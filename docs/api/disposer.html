<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
 <!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href='http://fonts.googleapis.com/css?family=Raleway:400,300,200,700,500,100,800,600,900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css" />
    <title>.disposer | bluebird</title>
    <meta name="description" content="Bluebird is a fully featured JavaScript promises library with unmatched performance.">
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/mono-blue.css" type='text/css' />
    <link rel="stylesheet" href="/css/hover-min.css" media="all">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="http://bluebirdjs.com/docs/api/disposer.html">
    <link rel="icon" href="/img/favicon.png" type="image/png" />
  </head>

  <body>

    <nav class="navbar" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>

                <a href="/" class="title">
                    <img src="/img/logo.png" class="hidden-xs" />

                    <span class="tagline">bluebird</span>
                </a>
            </div>
            <div id="navbar" class="navbar-collapse navbar-bluebird navbar-right collapse">
                <ul class="nav navbar-nav bb-nav">
                    
                        
                    

                    <li class="active"><a href="/docs/getting-started.html">Docs</a></li>
                    <li class=""><a href="/docs/support.html">Support</a></li>
                    <li class=""><a href="/docs/install.html">Install</a></li>
                    <li><a href="https://github.com/petkaantonov/bluebird/">Github</a></li>
                </ul>
            </div><!--/.navbar-collapse -->
        </div>
    </nav>

   <div class="container">
      <div class="row">
        <div class="col-sm-3">
            <ul class="nav left-nav">
                <li><a href="/docs/getting-started.html">Getting Started</a></li>
                <li><a href="/docs/features.html">Features</a></li>
                <li><a href="/docs/changelog.html">Changelog</a></li>
                <li><a href="/docs/api-reference.html"><strong>API Reference</strong></a></li>
                <li><a href="/docs/new-in-bluebird-3.html"><strong>New in 3.0</strong></a></li>
                <li><a href="/docs/warning-explanations.html">Warning Explanations</a></li>
                <li><a href="/docs/error-explanations.html">Error Explanations</a></li>
                <li><a href="/docs/contribute.html">Contribute</a></li>
                <li><a href="/docs/benchmarks.html">Benchmarks</a></li>
                <li><a href="/docs/deprecated-apis.html">Deprecated APIs</a></li>
                <li><hr></li>
                <li>Why?
                    <ul class="nav nav-child">
                        <li><a href="/docs/why-promises.html">Why Promises?</a></li>
                        <li><a href="/docs/why-bluebird.html">Why bluebird?</a></li>
                        <li><a href="/docs/why-performance.html">Why Performance?</a></li>
                        <li><a href="/docs/what-about-generators.html">What About Generators?</a></li>
                    </ul>
                </li>
                <li><hr></li>
                <li>
                    Tutorials
                    <ul class="nav nav-child">
                        <li><a href="/docs/async-dialogs.html">Async Dialogs</a></li>
                    </ul>
                </li>
                <li><hr></li>
                <li>
                    Guides
                    <ul class="nav nav-child">
                        <li><a href="/docs/beginners-guide.html">Beginner's Guide</a></li>
                        <li><a href="/docs/anti-patterns.html">Anti-patterns</a></li>
                        <li><a href="/docs/working-with-callbacks.html">Working with Callbacks</a></li>
                        <li><a href="/docs/coming-from-other-languages.html">Coming from Other Languages</a></li>
                        <li><a href="/docs/coming-from-other-libraries.html">Coming from Other Libraries</a></li>
                    </ul>
                </li>
            </ul>
        </div>
        <div class="col-sm-9">
            
            <div class="post-info">
                <a href="https://github.com/petkaantonov/bluebird/edit/master/docs/docs/api/disposer.md">
                    <i class="fa fa-edit"></i>
                    Edit on Github</a>
                <br>
                <i>Updated 27 Oct 2015</i>
            </div>
            <div class="clearfix"></div>
            
            <div class="post">
  <article class="post-content">
    <p><a href='/docs/api-reference.html' title=''>‚Üê Back To API Reference</a>
<div class="api-code-section"><markdown></p>
            <h2>
                <a class="header-anchor"
                    name="disposer"
                    aria-hidden="true"
                    href="#disposer"><i class="fa fa-link"></i></a>
                .disposer
            </h2>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="p">.</span><span class="nx">disposer</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">any</span> <span class="nx">resource</span><span class="p">,</span> <span class="nx">Promise</span> <span class="nx">usingOutcomePromise</span><span class="p">)</span> <span class="nx">disposer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Disposer</span>
</code></pre></div>
<p>A meta method used to specify the disposer method that cleans up a resource when using undefined.</p>

<p>Example:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="c1">// This function doesn&#39;t return a promise but a Disposer</span>
<span class="c1">// so it&#39;s very hard to use it wrong (not passing it to `using`)</span>
<span class="kd">function</span> <span class="nx">getConnection</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">pool</span><span class="p">.</span><span class="nx">getConnectionAsync</span><span class="p">().</span><span class="nx">disposer</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">connection</span><span class="p">,</span> <span class="nx">promise</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">connection</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div>
<p>Real example:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">pg</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;pg&quot;</span><span class="p">);</span>
<span class="c1">// Uncomment if pg has not been properly promisified yet</span>
<span class="c1">//var Promise = require(&quot;bluebird&quot;);</span>
<span class="c1">//Promise.promisifyAll(pg, {</span>
<span class="c1">//    filter: function(methodName) {</span>
<span class="c1">//        return methodName === &quot;connect&quot;</span>
<span class="c1">//    },</span>
<span class="c1">//    multiArgs: true</span>
<span class="c1">//});</span>
<span class="c1">// Promisify rest of pg normally</span>
<span class="c1">//Promise.promisifyAll(pg);</span>

<span class="kd">function</span> <span class="nx">getSqlConnection</span><span class="p">(</span><span class="nx">connectionString</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">close</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">pg</span><span class="p">.</span><span class="nx">connectAsync</span><span class="p">(</span><span class="nx">connectionString</span><span class="p">).</span><span class="nx">spread</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">close</span> <span class="o">=</span> <span class="nx">done</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">client</span><span class="p">;</span>
    <span class="p">}).</span><span class="nx">disposer</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">close</span><span class="p">)</span> <span class="nx">close</span><span class="p">();</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">getSqlConnection</span><span class="p">;</span>
</code></pre></div>
<p>Real example 2:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">mysql</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;mysql&quot;</span><span class="p">);</span>
<span class="c1">// Uncomment if pg has not been properly promisified yet</span>
<span class="c1">// var Promise = require(&quot;bluebird&quot;);</span>
<span class="c1">// Promise.promisifyAll(mysql);</span>
<span class="c1">// Promise.promisifyAll(require(&quot;mysql/lib/Connection&quot;).prototype);</span>
<span class="c1">// Promise.promisifyAll(require(&quot;mysql/lib/Pool&quot;).prototype);</span>
<span class="kd">var</span> <span class="nx">pool</span>  <span class="o">=</span> <span class="nx">mysql</span><span class="p">.</span><span class="nx">createPool</span><span class="p">({</span>
    <span class="nx">connectionLimit</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="nx">host</span><span class="o">:</span> <span class="s1">&#39;example.org&#39;</span><span class="p">,</span>
    <span class="nx">user</span><span class="o">:</span> <span class="s1">&#39;bob&#39;</span><span class="p">,</span>
    <span class="nx">password</span><span class="o">:</span> <span class="s1">&#39;secret&#39;</span>
<span class="p">});</span>

<span class="kd">function</span> <span class="nx">getSqlConnection</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">pool</span><span class="p">.</span><span class="nx">getConnectionAsync</span><span class="p">().</span><span class="nx">disposer</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">connection</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">connection</span><span class="p">.</span><span class="nx">release</span><span class="p">();</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">getSqlConnection</span><span class="p">;</span>
</code></pre></div>
<p>The second argument passed to a disposer is the result promise of the using block, which you can inspect synchronously.</p>

<p>Example:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">getTransaction</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">db</span><span class="p">.</span><span class="nx">getTransactionAsync</span><span class="p">().</span><span class="nx">disposer</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">tx</span><span class="p">,</span> <span class="nx">promise</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">promise</span><span class="p">.</span><span class="nx">isFulfilled</span><span class="p">()</span> <span class="o">?</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">commitAsync</span><span class="p">()</span> <span class="o">:</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">rollbackAsync</span><span class="p">();</span>
    <span class="p">});</span>
<span class="p">}</span>


<span class="c1">// If the using block completes successfully, the transaction is automatically committed</span>
<span class="c1">// Any error or rejection will automatically roll it back</span>
<span class="nx">using</span><span class="p">(</span><span class="nx">getTransaction</span><span class="p">(),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">tx</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">queryAsync</span><span class="p">(...).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">queryAsync</span><span class="p">(...)</span>
    <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">queryAsync</span><span class="p">(...)</span>
    <span class="p">});</span>
<span class="p">});</span>
</code></pre></div>
<p>Real example 3, transactions with postgres:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">pg</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;pg&#39;</span><span class="p">);</span>
<span class="c1">// uncomment if necessary</span>
<span class="c1">//var Promise = require(&quot;bluebird&quot;);</span>
<span class="c1">//Promise.promisifyAll(pg, {</span>
<span class="c1">//    filter: function(methodName) {</span>
<span class="c1">//        return methodName === &quot;connect&quot;</span>
<span class="c1">//    },</span>
<span class="c1">//    multiArgs: true</span>
<span class="c1">//});</span>
<span class="c1">// Promisify rest of pg normally</span>
<span class="c1">//Promise.promisifyAll(pg);</span>

<span class="kd">function</span> <span class="nx">getTransaction</span><span class="p">(</span><span class="nx">connectionString</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">close</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">pg</span><span class="p">.</span><span class="nx">connectAsync</span><span class="p">(</span><span class="nx">connectionString</span><span class="p">).</span><span class="nx">spread</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">close</span> <span class="o">=</span> <span class="nx">done</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">client</span><span class="p">.</span><span class="nx">queryAsync</span><span class="p">(</span><span class="s1">&#39;BEGIN&#39;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">client</span><span class="p">;</span>
        <span class="p">});</span>
    <span class="p">}).</span><span class="nx">disposer</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">promise</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">promise</span><span class="p">.</span><span class="nx">isFulfilled</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">client</span><span class="p">.</span><span class="nx">queryAsync</span><span class="p">(</span><span class="s1">&#39;COMMIT&#39;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">closeClient</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">client</span><span class="p">.</span><span class="nx">queryAsync</span><span class="p">(</span><span class="s1">&#39;ROLLBACK&#39;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">closeClient</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="kd">function</span> <span class="nx">closeClient</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">close</span><span class="p">)</span> <span class="nx">close</span><span class="p">(</span><span class="nx">client</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">getTransaction</span> <span class="o">=</span> <span class="nx">getTransaction</span><span class="p">;</span>
</code></pre></div>            <h4>
                <a class="header-anchor"
                    name="note-about-disposers-in-node"
                    aria-hidden="true"
                    href="#note-about-disposers-in-node"><i class="fa fa-link"></i></a>
                Note about disposers in node
            </h4>

<p>If a disposer method throws, its highly likely that it failed to dispose of the resource. In that case, Bluebird has two options - it can either ignore the error and continue with program execution or throw an exception (crashing the process in node.js). Bluebird prefers to do the later because resources are typically scarce. For example, if database connections cannot be disposed of and Bluebird ignores that, the connection pool will be quickly depleted and the process will become unusable. Since Bluebird doesn&#39;t know how to handle that, the only sensible default is to crash the process.</p>

<p>If you anticipate thrown errors while disposing of the resource you should use a <code>try..catch</code> block (or <code>Promise.try</code>) and write the appropriate code to handle the errors.</p>

<p><hr>
</markdown></div></p>
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_title = ".disposer";
    var disqus_shortname = "bluebirdjs";
    var disqus_identifier = "disqus-id-disposer";
    
    (function() {
        var dsq = document.createElement("script"); dsq.type = "text/javascript"; dsq.async = true;
        dsq.src = "//" + disqus_shortname + ".disqus.com/embed.js";
        (document.getElementsByTagName("head")[0] || document.getElementsByTagName("body")[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

  </article>
</div>

        </div>
      </div>
    </div>
    <footer></footer>
    <script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
</body>

</html>
