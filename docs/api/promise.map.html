<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
 <!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href='http://fonts.googleapis.com/css?family=Raleway:400,300,200,700,500,100,800,600,900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css" />
    <title>Promise.map | bluebird</title>
    <meta name="description" content="Bluebird is a fully featured JavaScript promises library with unmatched performance.">
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/mono-blue.css" type='text/css' />
    <link rel="stylesheet" href="/css/hover-min.css" media="all">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="http://bluebirdjs.com/docs/api/promise.map.html">
    <link rel="icon" href="/img/favicon.png" type="image/png" />
  </head>

  <body>

    <nav class="navbar" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>

                <a href="/" class="title">
                    <img src="/img/logo.png" class="hidden-xs" />

                    <span class="tagline">bluebird</span>
                </a>
            </div>
            <div id="navbar" class="navbar-collapse navbar-bluebird navbar-right collapse">
                <ul class="nav navbar-nav bb-nav">
                    
                        
                    

                    <li class="active"><a href="/docs/getting-started.html">Docs</a></li>
                    <li class=""><a href="/docs/support.html">Support</a></li>
                    <li class=""><a href="/docs/install.html">Install</a></li>
                    <li><a href="https://github.com/petkaantonov/bluebird/">Github</a></li>
                </ul>
            </div><!--/.navbar-collapse -->
        </div>
    </nav>

   <div class="container">
      <div class="row">
        <div class="col-sm-3">
            <ul class="nav left-nav">
                <li><a href="/docs/getting-started.html">Getting Started</a></li>
                <li><a href="/docs/features.html">Features</a></li>
                <li><a href="/docs/changelog.html">Changelog</a></li>
                <li><a href="/docs/api-reference.html"><strong>API Reference</strong></a></li>
                <li><a href="/docs/new-in-bluebird-3.html"><strong>New in 3.0</strong></a></li>
                <li><a href="/docs/warning-explanations.html">Warning Explanations</a></li>
                <li><a href="/docs/error-explanations.html">Error Explanations</a></li>
                <li><a href="/docs/contribute.html">Contribute</a></li>
                <li><a href="/docs/benchmarks.html">Benchmarks</a></li>
                <li><a href="/docs/deprecated-apis.html">Deprecated APIs</a></li>
                <li><hr></li>
                <li>Why?
                    <ul class="nav nav-child">
                        <li><a href="/docs/why-promises.html">Why Promises?</a></li>
                        <li><a href="/docs/why-bluebird.html">Why bluebird?</a></li>
                        <li><a href="/docs/why-performance.html">Why Performance?</a></li>
                        <li><a href="/docs/what-about-generators.html">What About Generators?</a></li>
                    </ul>
                </li>
                <li><hr></li>
                <li>
                    Tutorials
                    <ul class="nav nav-child">
                        <li><a href="/docs/async-dialogs.html">Async Dialogs</a></li>
                    </ul>
                </li>
                <li><hr></li>
                <li>
                    Guides
                    <ul class="nav nav-child">
                        <li><a href="/docs/beginners-guide.html">Beginner's Guide</a></li>
                        <li><a href="/docs/anti-patterns.html">Anti-patterns</a></li>
                        <li><a href="/docs/working-with-callbacks.html">Working with Callbacks</a></li>
                        <li><a href="/docs/coming-from-other-languages.html">Coming from Other Languages</a></li>
                        <li><a href="/docs/coming-from-other-libraries.html">Coming from Other Libraries</a></li>
                    </ul>
                </li>
            </ul>
        </div>
        <div class="col-sm-9">
            
            <div class="post-info">
                <a href="https://github.com/petkaantonov/bluebird/edit/master/docs/docs/api/promise.map.md">
                    <i class="fa fa-edit"></i>
                    Edit on Github</a>
                <br>
                <i>Updated 27 Oct 2015</i>
            </div>
            <div class="clearfix"></div>
            
            <div class="post">
  <article class="post-content">
    <p><a href='/docs/api-reference.html' title=''>‚Üê Back To API Reference</a>
<div class="api-code-section"><markdown></p>
            <h2>
                <a class="header-anchor"
                    name="promise.map"
                    aria-hidden="true"
                    href="#promise.map"><i class="fa fa-link"></i></a>
                Promise.map
            </h2>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">Promise</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span>
    <span class="nx">Iterable</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;|</span><span class="nx">Promise</span><span class="o">&lt;</span><span class="nx">Iterable</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;&gt;</span> <span class="nx">input</span><span class="p">,</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">any</span> <span class="nx">item</span><span class="p">,</span> <span class="kr">int</span> <span class="nx">index</span><span class="p">,</span> <span class="kr">int</span> <span class="nx">length</span><span class="p">)</span> <span class="nx">mapper</span><span class="p">,</span>
    <span class="p">[</span><span class="nb">Object</span> <span class="p">{</span><span class="nx">concurrency</span><span class="o">:</span> <span class="kr">int</span><span class="o">=</span><span class="kc">Infinity</span><span class="p">}</span> <span class="nx">options</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</code></pre></div>
<p>Given an <a href='https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Iteration_protocols' title=''><code>Iterable</code></a>(arrays are <code>Iterable</code>), or a promise of an <code>Iterable</code>, which produces promises (or a mix of promises and values), iterate over all the values in the <code>Iterable</code> into an array and <a href='http://en.wikipedia.org/wiki/Map_(higher-order_function)' title=''>map the array to another</a> using the given <code>mapper</code> function.</p>

<p>Promises returned by the <code>mapper</code> function are awaited for and the returned promise doesn&#39;t fulfill until all mapped promises have fulfilled as well. If any promise in the array is rejected, or any promise returned by the <code>mapper</code> function is rejected, the returned promise is rejected as well.</p>

<p>The mapper function for a given item is called as soon as possible, that is, when the promise for that item&#39;s index in the input array is fulfilled. This doesn&#39;t mean that the result array has items in random order, it means that <code>.map</code> can be used for concurrency coordination unlike <code>.all</code>.</p>

<p>A common use of <code>Promise.map</code> is to replace the <code>.push</code>+<code>Promise.all</code> boilerplate:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">promises</span> <span class="o">=</span> <span class="p">[];</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">fileNames</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">promises</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileAsync</span><span class="p">(</span><span class="nx">fileNames</span><span class="p">[</span><span class="nx">i</span><span class="p">]));</span>
<span class="p">}</span>
<span class="nx">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">promises</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;done&quot;</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// Using Promise.map:</span>
<span class="nx">Promise</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">fileNames</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fileName</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Promise.map awaits for returned promises as well.</span>
    <span class="k">return</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileAsync</span><span class="p">(</span><span class="nx">fileName</span><span class="p">);</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;done&quot;</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
<p>A more involved example:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">join</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">join</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;fs&quot;</span><span class="p">));</span>
<span class="nx">fs</span><span class="p">.</span><span class="nx">readdirAsync</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">fileName</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">stat</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">statAsync</span><span class="p">(</span><span class="nx">fileName</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">contents</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileAsync</span><span class="p">(</span><span class="nx">fileName</span><span class="p">).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span> <span class="nx">ignore</span><span class="p">()</span> <span class="p">{});</span>
    <span class="k">return</span> <span class="nx">join</span><span class="p">(</span><span class="nx">stat</span><span class="p">,</span> <span class="nx">contents</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stat</span><span class="p">,</span> <span class="nx">contents</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="nx">stat</span><span class="o">:</span> <span class="nx">stat</span><span class="p">,</span>
            <span class="nx">fileName</span><span class="o">:</span> <span class="nx">fileName</span><span class="p">,</span>
            <span class="nx">contents</span><span class="o">:</span> <span class="nx">contents</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="c1">// The return value of .map is a promise that is fulfilled with an array of the mapped values</span>
<span class="c1">// That means we only get here after all the files have been statted and their contents read</span>
<span class="c1">// into memory. If you need to do more operations per file, they should be chained in the map</span>
<span class="c1">// callback for concurrency.</span>
<span class="p">}).</span><span class="nx">call</span><span class="p">(</span><span class="s2">&quot;sort&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">fileName</span><span class="p">.</span><span class="nx">localeCompare</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">fileName</span><span class="p">);</span>
<span class="p">}).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">contentLength</span> <span class="o">=</span> <span class="nx">file</span><span class="p">.</span><span class="nx">stat</span><span class="p">.</span><span class="nx">isDirectory</span><span class="p">()</span> <span class="o">?</span> <span class="s2">&quot;(directory)&quot;</span> <span class="o">:</span> <span class="nx">file</span><span class="p">.</span><span class="nx">contents</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="s2">&quot; bytes&quot;</span><span class="p">;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">fileName</span> <span class="o">+</span> <span class="s2">&quot; last modified &quot;</span> <span class="o">+</span> <span class="nx">file</span><span class="p">.</span><span class="nx">stat</span><span class="p">.</span><span class="nx">mtime</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">contentLength</span><span class="p">)</span>
<span class="p">});</span>
</code></pre></div>            <h4>
                <a class="header-anchor"
                    name="map-option-concurrency"
                    aria-hidden="true"
                    href="#map-option-concurrency"><i class="fa fa-link"></i></a>
                Map Option: concurrency
            </h4>

<p>You may optionally specify a concurrency limit:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="p">...</span><span class="nx">map</span><span class="p">(...,</span> <span class="p">{</span><span class="nx">concurrency</span><span class="o">:</span> <span class="mi">3</span><span class="p">});</span>
</code></pre></div>
<p>The concurrency limit applies to Promises returned by the mapper function and it basically limits the number of Promises created. For example, if <code>concurrency</code> is <code>3</code> and the mapper callback has been called enough so that there are three returned Promises currently pending, no further callbacks are called until one of the pending Promises resolves. So the mapper function will be called three times and it will be called again only after at least one of the Promises resolves.</p>

<p>Playing with the first example with and without limits, and seeing how it affects the duration when reading 20 files:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">join</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">join</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;fs&quot;</span><span class="p">));</span>
<span class="kd">var</span> <span class="nx">concurrency</span> <span class="o">=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">||</span> <span class="s2">&quot;Infinity&quot;</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">time</span><span class="p">(</span><span class="s2">&quot;reading files&quot;</span><span class="p">);</span>
<span class="nx">fs</span><span class="p">.</span><span class="nx">readdirAsync</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">fileName</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">stat</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">statAsync</span><span class="p">(</span><span class="nx">fileName</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">contents</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileAsync</span><span class="p">(</span><span class="nx">fileName</span><span class="p">).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span> <span class="nx">ignore</span><span class="p">()</span> <span class="p">{});</span>
    <span class="k">return</span> <span class="nx">join</span><span class="p">(</span><span class="nx">stat</span><span class="p">,</span> <span class="nx">contents</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stat</span><span class="p">,</span> <span class="nx">contents</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="nx">stat</span><span class="o">:</span> <span class="nx">stat</span><span class="p">,</span>
            <span class="nx">fileName</span><span class="o">:</span> <span class="nx">fileName</span><span class="p">,</span>
            <span class="nx">contents</span><span class="o">:</span> <span class="nx">contents</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="c1">// The return value of .map is a promise that is fulfilled with an array of the mapped values</span>
<span class="c1">// That means we only get here after all the files have been statted and their contents read</span>
<span class="c1">// into memory. If you need to do more operations per file, they should be chained in the map</span>
<span class="c1">// callback for concurrency.</span>
<span class="p">},</span> <span class="p">{</span><span class="nx">concurrency</span><span class="o">:</span> <span class="nx">concurrency</span><span class="p">}).</span><span class="nx">call</span><span class="p">(</span><span class="s2">&quot;sort&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">fileName</span><span class="p">.</span><span class="nx">localeCompare</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">fileName</span><span class="p">);</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">timeEnd</span><span class="p">(</span><span class="s2">&quot;reading files&quot;</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div><div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>sync <span class="o">&amp;&amp;</span> <span class="nb">echo </span><span class="m">3</span> &gt; /proc/sys/vm/drop_caches
<span class="nv">$ </span>node test.js 1
reading files 35ms
<span class="nv">$ </span>sync <span class="o">&amp;&amp;</span> <span class="nb">echo </span><span class="m">3</span> &gt; /proc/sys/vm/drop_caches
<span class="nv">$ </span>node test.js Infinity
reading files: 9ms
</code></pre></div>
<p>The order <code>map</code> calls the mapper function on the array elements is not specified, there is no guarantee on the order in which it&#39;ll execute the <code>map</code>er on the elements. This makes sense because the order of the even with the <code>{concurrency: 1}</code>. For order guarantee in sequential execution - see <a href='/docs/api/promise.each.html'><code>Promise.each</code></a>.
</markdown></div></p>
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_title = "Promise.map";
    var disqus_shortname = "bluebirdjs";
    var disqus_identifier = "disqus-id-promise.map";

    (function() {
        var dsq = document.createElement("script"); dsq.type = "text/javascript"; dsq.async = true;
        dsq.src = "//" + disqus_shortname + ".disqus.com/embed.js";
        (document.getElementsByTagName("head")[0] || document.getElementsByTagName("body")[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

  </article>
</div>

        </div>
      </div>
    </div>
    <footer></footer>
    <script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
</body>

</html>
