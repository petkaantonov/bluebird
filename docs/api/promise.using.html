<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
 <!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href='http://fonts.googleapis.com/css?family=Raleway:400,300,200,700,500,100,800,600,900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css" />
    <title>Promise.using | bluebird</title>
    <meta name="description" content="Bluebird is a fully featured JavaScript promises library with unmatched performance.">
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/mono-blue.css" type='text/css' />
    <link rel="stylesheet" href="/css/hover-min.css" media="all">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="http://bluebirdjs.com/docs/api/promise.using.html">
    <link rel="icon" href="/img/favicon.png" type="image/png" />
  </head>

  <body>

    <nav class="navbar" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>

                <a href="/" class="title">
                    <img src="/img/logo.png" class="hidden-xs" />

                    <span class="tagline">bluebird</span>
                </a>
            </div>
            <div id="navbar" class="navbar-collapse navbar-bluebird navbar-right collapse">
                <ul class="nav navbar-nav bb-nav">
                    
                        
                    

                    <li class="active"><a href="/docs/getting-started.html">Docs</a></li>
                    <li class=""><a href="/docs/support.html">Support</a></li>
                    <li class=""><a href="/docs/install.html">Install</a></li>
                    <li><a href="https://github.com/petkaantonov/bluebird/">Github</a></li>
                </ul>
            </div><!--/.navbar-collapse -->
        </div>
    </nav>

   <div class="container">
      <div class="row">
        <div class="col-sm-3">
            <ul class="nav left-nav">
                <li><a href="/docs/getting-started.html">Getting Started</a></li>
                <li><a href="/docs/features.html">Features</a></li>
                <li><a href="/docs/changelog.html">Changelog</a></li>
                <li><a href="/docs/api-reference.html"><strong>API Reference</strong></a></li>
                <li><a href="/docs/new-in-bluebird-3.html"><strong>New in 3.0</strong></a></li>
                <li><a href="/docs/warning-explanations.html">Warning Explanations</a></li>
                <li><a href="/docs/error-explanations.html">Error Explanations</a></li>
                <li><a href="/docs/contribute.html">Contribute</a></li>
                <li><a href="/docs/benchmarks.html">Benchmarks</a></li>
                <li><a href="/docs/deprecated-apis.html">Deprecated APIs</a></li>
                <li><hr></li>
                <li>Why?
                    <ul class="nav nav-child">
                        <li><a href="/docs/why-promises.html">Why Promises?</a></li>
                        <li><a href="/docs/why-bluebird.html">Why bluebird?</a></li>
                        <li><a href="/docs/why-performance.html">Why Performance?</a></li>
                        <li><a href="/docs/what-about-generators.html">What About Generators?</a></li>
                    </ul>
                </li>
                <li><hr></li>
                <li>
                    Tutorials
                    <ul class="nav nav-child">
                        <li><a href="/docs/async-dialogs.html">Async Dialogs</a></li>
                    </ul>
                </li>
                <li><hr></li>
                <li>
                    Guides
                    <ul class="nav nav-child">
                        <li><a href="/docs/beginners-guide.html">Beginner's Guide</a></li>
                        <li><a href="/docs/anti-patterns.html">Anti-patterns</a></li>
                        <li><a href="/docs/working-with-callbacks.html">Working with Callbacks</a></li>
                        <li><a href="/docs/coming-from-other-languages.html">Coming from Other Languages</a></li>
                        <li><a href="/docs/coming-from-other-libraries.html">Coming from Other Libraries</a></li>
                    </ul>
                </li>
            </ul>
        </div>
        <div class="col-sm-9">
            
            <div class="post-info">
                <a href="https://github.com/petkaantonov/bluebird/edit/master/docs/docs/api/promise.using.md">
                    <i class="fa fa-edit"></i>
                    Edit on Github</a>
                <br>
                <i>Updated 27 Oct 2015</i>
            </div>
            <div class="clearfix"></div>
            
            <div class="post">
  <article class="post-content">
    <p><a href='/docs/api-reference.html' title=''>‚Üê Back To API Reference</a>
<div class="api-code-section"><markdown></p>
            <h2>
                <a class="header-anchor"
                    name="promise.using"
                    aria-hidden="true"
                    href="#promise.using"><i class="fa fa-link"></i></a>
                Promise.using
            </h2>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">Promise</span><span class="p">.</span><span class="nx">using</span><span class="p">(</span>
    <span class="nx">Promise</span><span class="o">|</span><span class="nx">Disposer</span><span class="o">|</span><span class="nx">any</span> <span class="nx">resource</span><span class="p">,</span>
    <span class="nx">Promise</span><span class="o">|</span><span class="nx">Disposer</span><span class="o">|</span><span class="nx">any</span> <span class="nx">resource</span><span class="p">...,</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">any</span> <span class="nx">resources</span><span class="p">...)</span> <span class="nx">handler</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</code></pre></div><div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">Promise</span><span class="p">.</span><span class="nx">using</span><span class="p">(</span>
    <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">Promise</span><span class="o">|</span><span class="nx">Disposer</span><span class="o">|</span><span class="nx">Any</span><span class="o">&gt;</span> <span class="nx">resources</span><span class="p">,</span>
    <span class="kd">function</span><span class="p">(</span><span class="nb">Array</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span> <span class="nx">resources</span><span class="p">)</span> <span class="nx">handler</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</code></pre></div>
<p>In conjunction with <a href='/docs/api/disposer.html'><code><code>.disposer</code></code></a>, <code>using</code> will make sure that no matter what, the specified disposer will be called when the promise returned by the callback passed to <code>using</code> has settled. The disposer is necessary because there is no standard interface in node for disposing resources.</p>

<p>Here is a simple example ` [has been defined] to return a proper undefined))</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">using</span><span class="p">(</span><span class="nx">getConnection</span><span class="p">(),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">connection</span><span class="p">)</span> <span class="p">{</span>
   <span class="c1">// Don&#39;t leak the `connection` variable anywhere from here</span>
   <span class="c1">// it is only guaranteed to be open while the promise returned from</span>
   <span class="c1">// this callback is still pending</span>
   <span class="k">return</span> <span class="nx">connection</span><span class="p">.</span><span class="nx">queryAsync</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM TABLE&quot;</span><span class="p">);</span>
   <span class="c1">// Code that is chained from the promise created in the line above</span>
   <span class="c1">// still has access to `connection`</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">rows</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// The connection has been closed by now</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">rows</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
<p>Using multiple resources:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">using</span><span class="p">(</span><span class="nx">getConnection</span><span class="p">(),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">conn1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">using</span><span class="p">(</span><span class="nx">getConnection</span><span class="p">(),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">conn2</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// use conn1 and conn 2 here</span>
    <span class="p">});</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Both connections closed by now</span>
<span class="p">})</span>
</code></pre></div>
<p>The above can also be written as (with a caveat, see below)</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">using</span><span class="p">(</span><span class="nx">getConnection</span><span class="p">(),</span> <span class="nx">getConnection</span><span class="p">(),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">conn1</span><span class="p">,</span> <span class="nx">conn2</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// use conn1 and conn2</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Both connections closed by now</span>
<span class="p">})</span>
</code></pre></div>
<p>However, if the second <code>getConnection</code> throws <strong>synchronously</strong>, the first connection is leaked. This will not happen
when using APIs through bluebird promisified methods though. You can wrap functions that could throw in <a href='/docs/api/promise.method.html'><code><code>Promise.method</code></code></a> which will turn synchronous rejections into rejected promises.</p>

<p>Note that you can mix promises and disposers, so that you can acquire all the things you need in parallel instead of sequentially</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="c1">// The files don&#39;t need resource management but you should</span>
<span class="c1">// still start the process of reading them even before you have the connection</span>
<span class="c1">// instead of waiting for the connection</span>

<span class="c1">// The connection is always closed, no matter what fails at what point</span>
<span class="nx">using</span><span class="p">(</span><span class="nx">readFile</span><span class="p">(</span><span class="s2">&quot;1.txt&quot;</span><span class="p">),</span> <span class="nx">readFile</span><span class="p">(</span><span class="s2">&quot;2.txt&quot;</span><span class="p">),</span> <span class="nx">getConnection</span><span class="p">(),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">txt1</span><span class="p">,</span> <span class="nx">txt2</span><span class="p">,</span> <span class="nx">conn</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// use conn and have access to txt1 and txt2</span>
<span class="p">});</span>
</code></pre></div>
<p><hr></p>

<p>+You can also pass the resources in an array in the first argument. In this case the handler function will only be called with one rgument that is the array containing the resolved resources in respective positions in the array. Example:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">connectionPromises</span> <span class="o">=</span> <span class="p">[</span><span class="nx">getConnection</span><span class="p">(),</span> <span class="nx">getConnection</span><span class="p">()];</span>

<span class="nx">using</span><span class="p">(</span><span class="nx">connectionPromises</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">connections</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">conn1</span> <span class="o">=</span> <span class="nx">connections</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">conn2</span> <span class="o">=</span> <span class="nx">connections</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="c1">// use conn1 and conn2</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Both connections closed by now</span>
<span class="p">})</span>
</code></pre></div>
<p></markdown></div></p>
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_title = "Promise.using";
    var disqus_shortname = "bluebirdjs";
    var disqus_identifier = "disqus-id-promise.using";

    (function() {
        var dsq = document.createElement("script"); dsq.type = "text/javascript"; dsq.async = true;
        dsq.src = "//" + disqus_shortname + ".disqus.com/embed.js";
        (document.getElementsByTagName("head")[0] || document.getElementsByTagName("body")[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

  </article>
</div>

        </div>
      </div>
    </div>
    <footer></footer>
    <script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
</body>

</html>
