<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
 <!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href='http://fonts.googleapis.com/css?family=Raleway:400,300,200,700,500,100,800,600,900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css" />
    <title>Cancellation | bluebird</title>
    <meta name="description" content="Bluebird is a fully featured JavaScript promises library with unmatched performance.">
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/mono-blue.css" type='text/css' />
    <link rel="stylesheet" href="/css/hover-min.css" media="all">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="http://bluebirdjs.com/docs/api/cancellation.html">
    <link rel="icon" href="/img/favicon.png" type="image/png" />
  </head>

  <body>

    <nav class="navbar" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>

                <a href="/" class="title">
                    <img src="/img/logo.png" class="hidden-xs" />

                    <span class="tagline">bluebird</span>
                </a>
            </div>
            <div id="navbar" class="navbar-collapse navbar-bluebird navbar-right collapse">
                <ul class="nav navbar-nav bb-nav">
                    
                        
                    

                    <li class="active"><a href="/docs/getting-started.html">Docs</a></li>
                    <li class=""><a href="/docs/support.html">Support</a></li>
                    <li class=""><a href="/docs/install.html">Install</a></li>
                    <li><a href="https://github.com/petkaantonov/bluebird/">Github</a></li>
                </ul>
            </div><!--/.navbar-collapse -->
        </div>
    </nav>

   <div class="container">
      <div class="row">
        <div class="col-sm-3">
            <ul class="nav left-nav">
                <li><a href="/docs/getting-started.html">Getting Started</a></li>
                <li><a href="/docs/features.html">Features</a></li>
                <li><a href="/docs/changelog.html">Changelog</a></li>
                <li><a href="/docs/api-reference.html"><strong>API Reference</strong></a></li>
                <li><a href="/docs/new-in-bluebird-3.html"><strong>New in 3.0</strong></a></li>
                <li><a href="/docs/warning-explanations.html">Warning Explanations</a></li>
                <li><a href="/docs/error-explanations.html">Error Explanations</a></li>
                <li><a href="/docs/contribute.html">Contribute</a></li>
                <li><a href="/docs/benchmarks.html">Benchmarks</a></li>
                <li><a href="/docs/deprecated-apis.html">Deprecated APIs</a></li>
                <li><hr></li>
                <li>Why?
                    <ul class="nav nav-child">
                        <li><a href="/docs/why-promises.html">Why Promises?</a></li>
                        <li><a href="/docs/why-bluebird.html">Why bluebird?</a></li>
                        <li><a href="/docs/why-performance.html">Why Performance?</a></li>
                        <li><a href="/docs/what-about-generators.html">What About Generators?</a></li>
                    </ul>
                </li>
                <li><hr></li>
                <li>
                    Tutorials
                    <ul class="nav nav-child">
                        <li><a href="/docs/async-dialogs.html">Async Dialogs</a></li>
                    </ul>
                </li>
                <li><hr></li>
                <li>
                    Guides
                    <ul class="nav nav-child">
                        <li><a href="/docs/beginners-guide.html">Beginner's Guide</a></li>
                        <li><a href="/docs/anti-patterns.html">Anti-patterns</a></li>
                        <li><a href="/docs/working-with-callbacks.html">Working with Callbacks</a></li>
                        <li><a href="/docs/coming-from-other-languages.html">Coming from Other Languages</a></li>
                        <li><a href="/docs/coming-from-other-libraries.html">Coming from Other Libraries</a></li>
                    </ul>
                </li>
            </ul>
        </div>
        <div class="col-sm-9">
            
            <div class="post-info">
                <a href="https://github.com/petkaantonov/bluebird/edit/master/docs/docs/api/cancellation.md">
                    <i class="fa fa-edit"></i>
                    Edit on Github</a>
                <br>
                <i>Updated 27 Oct 2015</i>
            </div>
            <div class="clearfix"></div>
            
            <div class="post">
  <article class="post-content">
    <p><a href='/docs/api-reference.html' title=''>‚Üê Back To API Reference</a>
<div class="api-code-section"><markdown></p>
            <h2>
                <a class="header-anchor"
                    name="cancellation"
                    aria-hidden="true"
                    href="#cancellation"><i class="fa fa-link"></i></a>
                Cancellation
            </h2>

<p>Cancellation has been redesigned for bluebird 3.x, any code that relies on 2.x cancellation semantics won&#39;t work in 3.x.</p>

<p>The cancellation feature is <strong>by default turned off</strong>, you can enable it using <a href='/docs/api/promise.config.html'><code>Promise.config</code></a>.</p>

<p>The new cancellation has &quot;don&#39;t care&quot; semantics while the old cancellation had abort semantics. Cancelling a promise simply means that its handler callbacks will not be called.</p>

<p>The advantages of the new cancellation compared to the old cancellation are:</p>

<ul>
<li><a href='/docs/api/cancel.html'><code>.cancel()</code></a> is synchronous.</li>
<li>no setup code required to make cancellation work</li>
<li>composes with other bluebird features, like <a href='/docs/api/promise.all.html'><code>Promise.all</code></a>.</li>
<li><a href='#what-about-promises-that-have-multiple-consumers' title=''>reasonable semantics for multiple consumer cancellation</a></li>
</ul>

<p>As an optimization, the cancellation signal propagates upwards the promise chain so that an ongoing operation e.g. network request can be aborted. However, <em>not</em> aborting the network request still doesn&#39;t make any operational difference as the callbacks are still not called either way.</p>

<p>You may register an optional cancellation hook at a root promise by using the <code>onCancel</code> argument that is passed to the executor function when cancellation is enabled:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">makeCancellableRequest</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">,</span> <span class="nx">onCancel</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;load&quot;</span><span class="p">,</span> <span class="nx">resolve</span><span class="p">);</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="nx">reject</span><span class="p">);</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
        <span class="c1">// Note the onCancel argument only exists if cancellation has been enabled!</span>
        <span class="nx">onCancel</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">xhr</span><span class="p">.</span><span class="nx">abort</span><span class="p">();</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div>
<p>Note that the <code>onCancel</code> hook is really an optional disconnected optimization, there is no real requirement to register any cancellation hooks for cancellation to work. As such, any errors that may occur while inside the <code>onCancel</code> callback are not caught and turned into rejections.</p>

<p>Example:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">searchPromise</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>  <span class="c1">// Dummy promise to avoid null check.</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&quot;#search-input&quot;</span><span class="p">).</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// The handlers of the previous request must not be called</span>
    <span class="nx">searchPromise</span><span class="p">.</span><span class="nx">cancel</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="s2">&quot;/search?term=&quot;</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">trim</span><span class="p">());</span>
    <span class="nx">showSpinner</span><span class="p">();</span>
    <span class="nx">searchPromise</span> <span class="o">=</span> <span class="nx">makeCancellableRequest</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">transformData</span><span class="p">(</span><span class="nx">results</span><span class="p">);</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">transformedData</span><span class="p">)</span> <span class="p">{</span>
            <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&quot;#search-results&quot;</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">transformedData</span><span class="p">;</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&quot;#search-results&quot;</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">renderErrorBox</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="k">finally</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="c1">// This check is necessary because `.finally` handlers are always called.</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">searchPromise</span><span class="p">.</span><span class="nx">isCancelled</span><span class="p">())</span> <span class="p">{</span>
                <span class="nx">hideSpinner</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">});</span>
<span class="p">});</span>
</code></pre></div>
<p>As shown in the example the handlers registered with <code>.finally</code> are called even if the promise is cancelled. Another such exception is <a href='/docs/api/reflect.html'><code>.reflect()</code></a>. No other types of handlers will be called in case of cancellation. This means that in <code>.then(onSuccess, onFailure)</code> neither <code>onSuccess</code> or <code>onFailure</code> handler is called. This is similar to how <a href='https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Generator/return' title=''><code>Generator#return</code></a> works - only active <code>finally</code> blocks are executed and then the generator exits.</p>
            <h3>
                <a class="header-anchor"
                    name="what-about-promises-that-have-multiple-consumers"
                    aria-hidden="true"
                    href="#what-about-promises-that-have-multiple-consumers"><i class="fa fa-link"></i></a>
                What about promises that have multiple consumers?
            </h3>

<p>It is often said that promises cannot be cancellable beacuse they can have multiple consumers.</p>

<p>For instance:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">makeCancellableRequest</span><span class="p">(...);</span>

<span class="kd">var</span> <span class="nx">firstConsumer</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">then</span><span class="p">(...);</span>
<span class="kd">var</span> <span class="nx">secondConsumer</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">then</span><span class="p">(...);</span>
</code></pre></div>
<p>Even though in practice most users of promises will never have any need to take advantage of the fact that you can attach multiple consumers to a promise, it is nevertheless possible. The problem: &quot;what should happen if <a href='/docs/api/cancel.html'><code>.cancel()</code></a> is called on <code>firstConsumer</code>?&quot; Propagating the cancellation signal (and therefore making it abort the request) would be very bad as the second consumer might still be interested in the result despite the first consumer&#39;s disinterest.</p>

<p>What actually happens is that <code>result</code> keeps track of how many consumers it has, in this case 2, and only if all the consumers signal cancel will the request be aborted. However, as far as <code>firstConsumer</code> can tell, the promise was successfully cancelled and its handlers will not be called.</p>

<p>Note that it is an error to consume an already cancelled promise, doing such a thing will give you a promise that is rejected with <code>new CancellationError(&quot;late cancellation observer&quot;)</code> as the rejection reason.</p>

<p><hr>
</markdown></div></p>
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_title = "Cancellation";
    var disqus_shortname = "bluebirdjs";
    var disqus_identifier = "disqus-id-cancellation";
    
    (function() {
        var dsq = document.createElement("script"); dsq.type = "text/javascript"; dsq.async = true;
        dsq.src = "//" + disqus_shortname + ".disqus.com/embed.js";
        (document.getElementsByTagName("head")[0] || document.getElementsByTagName("body")[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

  </article>
</div>

        </div>
      </div>
    </div>
    <footer></footer>
    <script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
</body>

</html>
