<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
 <!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href='http://fonts.googleapis.com/css?family=Raleway:400,300,200,700,500,100,800,600,900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css" />
    <title>API Reference | bluebird</title>
    <meta name="description" content="Bluebird is a fully featured JavaScript promises library with unmatched performance.">
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
    <link rel="stylesheet" href="/bluebird/web/css/mono-blue.css" type='text/css' />
    <link rel="stylesheet" href="/bluebird/web/css/hover-min.css" media="all">
    <link rel="stylesheet" href="/bluebird/web/css/main.css">
    <link rel="canonical" href="http://petkaantonov.github.io/bluebird/web/docs/api-reference.html">
  </head>

  <body>

    <nav class="navbar" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>

                <a href="/bluebird" class="title">
                    <img src="/bluebird/web/img/logo.png" class="hidden-xs" />

                    <span class="tagline">bluebird</span>
                </a>
            </div>
            <div id="navbar" class="navbar-collapse navbar-bluebird navbar-right collapse">
                <ul class="nav navbar-nav bb-nav">
                    
                        
                    

                    <li class="active"><a href="/bluebird/web/docs/getting-started.html">Docs</a></li>
                    <li class=""><a href="/bluebird/web/docs/support.html">Support</a></li>
                    <li class=""><a href="/bluebird/web/docs/install.html">Install</a></li>
                    <li><a href="https://github.com/petkaantonov/bluebird/">Github</a></li>
                </ul>
            </div><!--/.navbar-collapse -->
        </div>
    </nav>

   <div class="container">
      <div class="row">
        <div class="col-sm-3">
            <ul class="nav left-nav">
                <li><a href="/bluebird/web/docs/getting-started.html">Getting Started</a></li>
                <li><a href="/bluebird/web/docs/features.html">Features</a></li>
                <li><a href="/bluebird/web/docs/changelog.html">Changelog</a></li>
                <li><a href="/bluebird/web/docs/api-reference.html"><strong>API Reference</strong></a></li>
                <li><a href="/bluebird/web/docs/warning-explanations.html">Warning Explanations</a></li>
                <li><a href="/bluebird/web/docs/error-explanations.html">Error Explanations</a></li>
                <li><a href="/bluebird/web/docs/contribute.html">Contribute</a></li>
                <li><a href="/bluebird/web/docs/benchmarks.html">Benchmarks</a></li>
                <li><hr></li>
                <li>Why?
                    <ul class="nav nav-child">
                        <li><a href="/bluebird/web/docs/why-promises.html">Why Promises?</a></li>
                        <li><a href="/bluebird/web/docs/why-bluebird.html">Why bluebird?</a></li>
                        <li><a href="/bluebird/web/docs/why-performance.html">Why Performance?</a></li>
                        <li><a href="/bluebird/web/docs/what-about-generators.html">What About Generators?</a></li>
                    </ul>
                </li>
                <li><hr></li>
                <li>
                    Tutorials
                    <ul class="nav nav-child">
                        <li><a href="/bluebird/web/docs/async-dialogs.html">Async Dialogs</a></li>
                    </ul>
                </li>
                <li><hr></li>
                <li>
                    Guides
                    <ul class="nav nav-child">
                        <li><a href="/bluebird/web/docs/beginners-guide.html">Beginner's Guide</a></li>
                        <li><a href="/bluebird/web/docs/anti-patterns.html">Anti-patterns</a></li>
                        <li><a href="/bluebird/web/docs/working-with-callbacks.html">Working with Callbacks</a></li>
                        <li><a href="/bluebird/web/docs/coming-from-other-languages.html">Coming from Other Languages</a></li>
                        <li><a href="/bluebird/web/docs/coming-from-other-libraries.html">Coming from Other Libraries</a></li>
                    </ul>
                </li>
            </ul>
        </div>
        <div class="col-sm-9">
            
            <div class="post-info">
                <a href="https://github.com/petkaantonov/bluebird/edit/master/docs/docs/api-reference.md">
                    <i class="fa fa-edit"></i>
                    Edit on Github</a>
                <br>
                <i>Updated 11 May 2015</i>
            </div>
            <div class="clearfix"></div>
            
            <div class="post">

  <header class="post-header">
    <h1 class="post-title">API Reference</h1>
  </header>

  <article class="post-content">
    <div class="api-reference-menu">
<ul>
<li>                <a href="#core" title="">Core</a>


<ul>
<li>                <a href="#new-promise" title="">new Promise</a></li>
<li>                <a href="#.then" title="">.then</a></li>
<li>                <a href="#.spread" title="">.spread</a></li>
<li>                <a href="#.catch" title="">.catch</a></li>
<li>                <a href="#.error" title="">.error</a></li>
<li>                <a href="#.finally" title="">.finally</a></li>
<li>                <a href="#.bind" title="">.bind</a></li>
<li>                <a href="#promise.join" title="">Promise.join</a></li>
<li>                <a href="#promise.try" title="">Promise.try</a></li>
<li>                <a href="#promise.method" title="">Promise.method</a></li>
<li>                <a href="#promise.resolve" title="">Promise.resolve</a></li>
<li>                <a href="#promise.reject" title="">Promise.reject</a></li>
</ul></li>
<li>                <a href="#synchronous-inspection" title="">Synchronous inspection</a>


<ul>
<li>                <a href="#promiseinspection" title="">PromiseInspection</a></li>
<li>                <a href="#.isfulfilled" title="">.isFulfilled</a></li>
<li>                <a href="#.isrejected" title="">.isRejected</a></li>
<li>                <a href="#.ispending" title="">.isPending</a></li>
<li>                <a href="#.iscancelled" title="">.isCancelled</a></li>
<li>                <a href="#.value" title="">.value</a></li>
<li>                <a href="#.reason" title="">.reason</a></li>
</ul></li>
<li>                <a href="#collections" title="">Collections</a>


<ul>
<li>                <a href="#promise.all" title="">.all</a></li>
<li>                <a href="#promise.props" title="">.props</a></li>
<li>                <a href="#promise.any" title="">.any</a></li>
<li>                <a href="#promise.race" title="">.race</a></li>
<li>                <a href="#promise.some" title="">.some</a></li>
<li>                <a href="#promise.map" title="">.map</a></li>
<li>                <a href="#promise.reduce" title="">.reduce</a></li>
<li>                <a href="#promise.filter" title="">.filter</a></li>
<li>                <a href="#promise.each" title="">.each</a></li>
</ul></li>
<li>                <a href="#resource-management" title="">Resource management</a>


<ul>
<li>                <a href="#promise.using" title="">Promise.using</a></li>
<li>                <a href="#.disposer" title="">.disposer</a></li>
</ul></li>
<li>                <a href="#promisification" title="">Promisification</a>


<ul>
<li>                <a href="#promise.promisify" title="">Promise.promisify</a></li>
<li>                <a href="#promise.promisifyall" title="">Promise.promisifyAll</a></li>
<li>                <a href="#promise.fromcallback" title="">Promise.fromCallback</a></li>
<li>                <a href="#.ascallback" title="">.asCallback</a></li>
</ul></li>
<li>                <a href="#timers" title="">Timers</a>


<ul>
<li>                <a href="#.delay" title="">.delay</a></li>
<li>                <a href="#.timeout" title="">.timeout</a></li>
</ul></li>
<li>                <a href="#cancellation" title="">Cancellation</a>


<ul>
<li>                <a href="#.cancel" title="">.cancel</a></li>
</ul></li>
<li>                <a href="#generators" title="">Generators</a>


<ul>
<li>                <a href="#promise.coroutine" title="">Promise.coroutine</a></li>
<li>                <a href="#promise.coroutine.addyieldhandler" title="">Promise.coroutine.addYieldHandler</a></li>
</ul></li>
<li>                <a href="#utility" title="">Utility</a>


<ul>
<li>                <a href="#.tap" title="">.tap</a></li>
<li>                <a href="#.call" title="">.call</a></li>
<li>                <a href="#.get" title="">.get</a></li>
<li>                <a href="#.return" title="">.return</a></li>
<li>                <a href="#.throw" title="">.throw</a></li>
<li>                <a href="#.catchreturn" title="">.catchReturn</a></li>
<li>                <a href="#.catchthrow" title="">.catchThrow</a></li>
<li>                <a href="#.reflect" title="">.reflect</a></li>
<li>                <a href="#promise.noconflict" title="">Promise.noConflict</a></li>
<li>                <a href="#promise.setscheduler" title="">Promise.setScheduler</a></li>
</ul></li>
<li>                <a href="#built-in-error-types" title="">Built-in error types</a>


<ul>
<li>                <a href="#operationalerror" title="">OperationalError</a></li>
<li>                <a href="#timeouterror" title="">TimeoutError</a></li>
<li>                <a href="#cancellationerror" title="">CancellationError</a></li>
<li>                <a href="#aggregateerror" title="">AggregateError</a></li>
</ul></li>
<li>                <a href="#error-management-configuration" title="">Configuration</a>


<ul>
<li>                <a href="#global-rejection-events" title="">Rejection events</a></li>
<li>                <a href="#promise.config" title="">Promise.config</a></li>
<li>                <a href="#.suppressunhandledrejections" title="">.suppressUnhandledRejections</a></li>
<li>                <a href="#.done" title="">.done</a></li>
</ul></li>
<li>                <a href="#progression-migration" title="">Progression migration</a></li>
<li>                <a href="#deferred-migration" title="">Deferred migration</a></li>
<li>                <a href="#environment-variables" title="">Environment variables</a></li>
</ul>

</div>

            <h2>
                <a class="header-anchor"
                    name="core"
                    aria-hidden="true"
                    href="#core"><i class="fa fa-link"></i></a>
                Core
            </h2>

<p>Core methods of <code>Promise</code> instances and core static methods of the Promise class.</p>
<div class="api-code-section">            <h2>
                <a class="header-anchor"
                    name="new-promise"
                    aria-hidden="true"
                    href="#new-promise"><i class="fa fa-link"></i></a>
                new Promise
            </h2>
<div class="highlight"><pre><span class="k">new</span> <span class="nx">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="kd">function</span> <span class="nx">resolve</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">reject</span><span class="p">)</span> <span class="nx">resolver</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div>
<p>Create a new promise. The passed in function will receive functions <code>resolve</code> and <code>reject</code> as its arguments which can be called to seal the fate of the created promise.</p>

<p><em>Note: See                 <a href="/bluebird/web/docs/anti-patterns.html#explicit-construction-anti-pattern" title="">explicit construction anti-pattern</a>
 before creating promises yourself</em></p>

<p>Example:</p>
<div class="highlight"><pre><span class="kd">function</span> <span class="nx">ajaxGetAsync</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">;</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="nx">reject</span><span class="p">);</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;load&quot;</span><span class="p">,</span> <span class="nx">resolve</span><span class="p">);</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="nx">url</span><span class="p">);</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></div>
<p>If you pass a promise object to the <code>resolve</code> function, the created promise will follow the state of that promise.</p>

<p><hr></p>

<p>To make sure a function that returns a promise is following the implicit but critically important contract of promises, you can start a function with <code>new Promise</code> if you cannot start a chain immediately:</p>
<div class="highlight"><pre><span class="kd">function</span> <span class="nx">getConnection</span><span class="p">(</span><span class="nx">urlString</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//Without new Promise, this throwing will throw an actual exception</span>
        <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">urlString</span><span class="p">);</span>
        <span class="nx">resolve</span><span class="p">(</span><span class="nx">getAdapater</span><span class="p">(</span><span class="nx">params</span><span class="p">).</span><span class="nx">getConnection</span><span class="p">());</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></div>
<p>The above ensures <code>getConnection</code> fulfills the contract of a promise-returning function of never throwing a synchronous exception. Also see                 <a href="/bluebird/web/docs/api-reference.html#promise.try"><code><code>Promise.try</code></code></a>
 and                 <a href="/bluebird/web/docs/api-reference.html#promise.method"><code><code>Promise.method</code></code></a>
</p>

<p>The resolver is called synchronously (the following is for documentation purposes and not idiomatic code):</p>
<div class="highlight"><pre><span class="kd">function</span> <span class="nx">getPromiseResolveFn</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">res</span><span class="p">;</span>
    <span class="k">new</span> <span class="nx">Promise</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">resolve</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span> <span class="o">=</span> <span class="nx">resolve</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="c1">// res is guaranteed to be set</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name=".then"
                    aria-hidden="true"
                    href="#.then"><i class="fa fa-link"></i></a>
                .then
            </h2>
<div class="highlight"><pre><span class="p">.</span><span class="nx">then</span><span class="p">(</span>
    <span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">any</span> <span class="nx">value</span><span class="p">)</span> <span class="nx">fulfilledHandler</span><span class="p">],</span>
    <span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">any</span> <span class="nx">error</span><span class="p">)</span> <span class="nx">rejectedHandler</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div>
<p><a href="http://promises-aplus.github.io/promises-spec/" title="">Promises/A+ <code>.then</code></a>
. If you are new to promises, see the                 <a href="/bluebird/web/docs/beginners-guide.html" title="">Beginner&#39;s Guide</a>
.</p>

<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name=".spread"
                    aria-hidden="true"
                    href="#.spread"><i class="fa fa-link"></i></a>
                .spread
            </h2>
<div class="highlight"><pre><span class="p">.</span><span class="nx">spread</span><span class="p">(</span>
    <span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">any</span> <span class="nx">values</span><span class="p">...)</span> <span class="nx">fulfilledHandler</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div>
<p>Like calling <code>.then</code>, but the fulfillment value <em>must be</em> an array, which is flattened to the formal parameters of the fulfillment handler.</p>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
   <span class="k">return</span> <span class="p">[</span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileAsync</span><span class="p">(</span><span class="s2">&quot;file1.txt&quot;</span><span class="p">),</span>
           <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileAsync</span><span class="p">(</span><span class="s2">&quot;file2.txt&quot;</span><span class="p">)]</span> <span class="p">;</span>
<span class="p">}).</span><span class="nx">spread</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">file1text</span><span class="p">,</span> <span class="nx">file2text</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">file1text</span> <span class="o">!==</span> <span class="nx">file2text</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;files are equal&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;files are not equal&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
</pre></div>
<p>If using ES6, the above can be replaced with                 <a href="/bluebird/web/docs/api-reference.html#.then"><code>.then()</code></a>
 and destructuring:</p>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
   <span class="k">return</span> <span class="p">[</span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileAsync</span><span class="p">(</span><span class="s2">&quot;file1.txt&quot;</span><span class="p">),</span>
           <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileAsync</span><span class="p">(</span><span class="s2">&quot;file2.txt&quot;</span><span class="p">)]</span> <span class="p">;</span>
<span class="p">}).</span><span class="nx">all</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">([</span><span class="nx">file1text</span><span class="p">,</span> <span class="nx">file2text</span><span class="p">])</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">file1text</span> <span class="o">!==</span> <span class="nx">file2text</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;files are equal&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;files are not equal&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
</pre></div>
<p>Note that                 <a href="/bluebird/web/docs/api-reference.html#.spread"><code>.spread()</code></a>
 implicitly does                 <a href="/bluebird/web/docs/api-reference.html#.all"><code>.all()</code></a>
 but the ES6 destructuring syntax doesn&#39;t, hence the manual <code>.all()</code> call in the above code.</p>

<p>If you want to coordinate several discrete concurrent promises, use                 <a href="/bluebird/web/docs/api-reference.html#promise.join"><code><code>Promise.join</code></code></a>
</p>

<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name=".catch"
                    aria-hidden="true"
                    href="#.catch"><i class="fa fa-link"></i></a>
                .catch
            </h2>
<div class="highlight"><pre><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">any</span> <span class="nx">error</span><span class="p">)</span> <span class="nx">handler</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div><div class="highlight"><pre><span class="p">.</span><span class="nx">caught</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">any</span> <span class="nx">error</span><span class="p">)</span> <span class="nx">handler</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div>
<p>This is a catch-all exception handler, shortcut for calling                 <a href="/bluebird/web/docs/api-reference.html#.then"><code><code>.then(null, handler)</code></code></a>
 on this promise. Any exception happening in a <code>.then</code>-chain will propagate to nearest <code>.catch</code> handler.</p>

<p><em>For compatibility with earlier ECMAScript version, an alias <code>.caught</code> is provided for                 <a href="/bluebird/web/docs/api-reference.html#.catch"><code><code>.catch</code></code></a>
.</em></p>
<div class="highlight"><pre><span class="p">.</span><span class="k">catch</span><span class="p">(</span>
    <span class="kr">class</span> <span class="nx">ErrorClass</span><span class="o">|</span><span class="kd">function</span><span class="p">(</span><span class="nx">any</span> <span class="nx">error</span><span class="p">)</span><span class="o">|</span><span class="nb">Object</span> <span class="nx">predicate</span><span class="p">...,</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">any</span> <span class="nx">error</span><span class="p">)</span> <span class="nx">handler</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div><div class="highlight"><pre><span class="p">.</span><span class="nx">caught</span><span class="p">(</span>
    <span class="kr">class</span> <span class="nx">ErrorClass</span><span class="o">|</span><span class="kd">function</span><span class="p">(</span><span class="nx">any</span> <span class="nx">error</span><span class="p">)</span><span class="o">|</span><span class="nb">Object</span> <span class="nx">predicate</span><span class="p">...,</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">any</span> <span class="nx">error</span><span class="p">)</span> <span class="nx">handler</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div>
<p>This is an extension to                 <a href="/bluebird/web/docs/api-reference.html#.catch"><code><code>.catch</code></code></a>
 to work more like catch-clauses in languages like Java or C#. Instead of manually checking <code>instanceof</code> or <code>.name === &quot;SomeError&quot;</code>, you may specify a number of error constructors which are eligible for this catch handler. The catch handler that is first met that has eligible constructors specified, is the one that will be called.</p>

<p>Example:</p>
<div class="highlight"><pre><span class="nx">somePromise</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">b</span><span class="p">.</span><span class="nx">c</span><span class="p">.</span><span class="nx">d</span><span class="p">();</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">TypeError</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//If a is defined, will end up here because</span>
    <span class="c1">//it is a type error to reference property of undefined</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">ReferenceError</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//Will end up here if a wasn&#39;t defined at all</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//Generic catch-the rest, error wasn&#39;t TypeError nor</span>
    <span class="c1">//ReferenceError</span>
<span class="p">});</span>
</pre></div>
<p>You may also add multiple filters for a catch handler:</p>
<div class="highlight"><pre><span class="nx">somePromise</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">b</span><span class="p">.</span><span class="nx">c</span><span class="p">.</span><span class="nx">d</span><span class="p">();</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">TypeError</span><span class="p">,</span> <span class="nx">ReferenceError</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//Will end up here on programmer error</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">NetworkError</span><span class="p">,</span> <span class="nx">TimeoutError</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//Will end up here on expected everyday network errors</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//Catch any unexpected errors</span>
<span class="p">});</span>
</pre></div>
<p>For a parameter to be considered a type of error that you want to filter, you need the constructor to have its <code>.prototype</code> property be <code>instanceof Error</code>.</p>

<p>Such a constructor can be minimally created like so:</p>
<div class="highlight"><pre><span class="kd">function</span> <span class="nx">MyCustomError</span><span class="p">()</span> <span class="p">{}</span>
<span class="nx">MyCustomError</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nb">Error</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span>
</pre></div>
<p>Using it:</p>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nx">MyCustomError</span><span class="p">();</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">MyCustomError</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//will end up here now</span>
<span class="p">});</span>
</pre></div>
<p>However if you  want stack traces and cleaner string output, then you should do:</p>

<p><em>in Node.js and other V8 environments, with support for <code>Error.captureStackTrace</code></em></p>
<div class="highlight"><pre><span class="kd">function</span> <span class="nx">MyCustomError</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">message</span> <span class="o">=</span> <span class="nx">message</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;MyCustomError&quot;</span><span class="p">;</span>
    <span class="nb">Error</span><span class="p">.</span><span class="nx">captureStackTrace</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">MyCustomError</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">MyCustomError</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nb">Error</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span>
<span class="nx">MyCustomError</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">MyCustomError</span><span class="p">;</span>
</pre></div>
<p>Using CoffeeScript&#39;s <code>class</code> for the same:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nx">MyCustomError</span> <span class="k">extends</span> <span class="nb">Error</span>
  <span class="nv">constructor: </span><span class="nf">(@message) -&gt;</span>
    <span class="vi">@name = </span><span class="s">&quot;MyCustomError&quot;</span>
    <span class="nb">Error</span><span class="p">.</span><span class="nx">captureStackTrace</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">MyCustomError</span><span class="p">)</span>
</pre></div>
<p>This method also supports predicate-based filters. If you pass a
predicate function instead of an error constructor, the predicate will receive
the error as an argument. The return result of the predicate will be used
determine whether the error handler should be called.</p>

<p>Predicates should allow for very fine grained control over caught errors:
pattern matching, error-type sets with set operations and many other techniques
can be implemented on top of them.</p>

<p>Example of using a predicate-based filter:</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">promisify</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">));</span>

<span class="kd">function</span> <span class="nx">ClientError</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">e</span><span class="p">.</span><span class="nx">code</span> <span class="o">&gt;=</span> <span class="mi">400</span> <span class="o">&amp;&amp;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">code</span> <span class="o">&lt;</span> <span class="mi">500</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">request</span><span class="p">(</span><span class="s2">&quot;http://www.google.com&quot;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">contents</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">contents</span><span class="p">);</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">ClientError</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
   <span class="c1">//A client error like 400 Bad Request happened</span>
<span class="p">});</span>
</pre></div>
<p>Predicate functions that only check properties have a handy shorthand. In place of a predicate function, you can pass an object, and its properties will be checked against the error object for a match:</p>
<div class="highlight"><pre><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileAsync</span><span class="p">(...)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(...)</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">({</span><span class="nx">code</span><span class="o">:</span> <span class="s1">&#39;ENOENT&#39;</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;file not found: &quot;</span> <span class="o">+</span> <span class="nx">e</span><span class="p">.</span><span class="nx">path</span><span class="p">);</span>
    <span class="p">});</span>
</pre></div>
<p>The object predicate passed to <code>.catch</code> in the above code (<code>{code: &#39;ENOENT&#39;}</code>) is shorthand for a predicate function <code>function predicate(e) { return isObject(e) &amp;&amp; e.code == &#39;ENOENT&#39; }</code>, I.E. loose equality is used.</p>

<p><em>For compatibility with earlier ECMAScript version, an alias <code>.caught</code> is provided for                 <a href="/bluebird/web/docs/api-reference.html#.catch"><code><code>.catch</code></code></a>
.</em></p>

<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name=".error"
                    aria-hidden="true"
                    href="#.error"><i class="fa fa-link"></i></a>
                .error
            </h2>
<div class="highlight"><pre><span class="p">.</span><span class="nx">error</span><span class="p">([</span><span class="kd">function</span><span class="p">(</span><span class="nx">any</span> <span class="nx">error</span><span class="p">)</span> <span class="nx">rejectedHandler</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div>
<p>Like                 <a href="/bluebird/web/docs/api-reference.html#.catch"><code><code>.catch</code></code></a>
 but instead of catching all types of exceptions, it only catches operational errors.</p>

<p><em>Note, &quot;errors&quot; mean errors, as in objects that are <code>instanceof Error</code> - not strings, numbers and so on. See                 <a href="http://www.devthought.com/2011/12/22/a-string-is-not-an-error/" title="">a string is not an error</a>
.</em></p>

<p>It is equivalent to the following                 <a href="/bluebird/web/docs/api-reference.html#.catch"><code><code>.catch</code></code></a>
 pattern:</p>
<div class="highlight"><pre><span class="c1">// Assumes OperationalError has been made global</span>
<span class="kd">function</span> <span class="nx">isOperationalError</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">e</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">e</span> <span class="k">instanceof</span> <span class="nx">OperationalError</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">isOperational</span> <span class="o">===</span> <span class="kc">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Now this bit:</span>
<span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">isOperationalError</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">})</span>

<span class="c1">// Is equivalent to:</span>

<span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">});</span>
</pre></div>
<p>For example, if a promisified function errbacks the node-style callback with an error, that could be caught with                 <a href="/bluebird/web/docs/api-reference.html#.error"><code><code>.error</code></code></a>
. However if the node-style callback <strong>throws</strong> an error, only <code>.catch</code> would catch that.</p>

<p>In the following example you might want to handle just the <code>SyntaxError</code> from JSON.parse and Filesystem errors from <code>fs</code> but let programmer errors bubble as unhandled rejections:</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;fs&quot;</span><span class="p">));</span>

<span class="nx">fs</span><span class="p">.</span><span class="nx">readFileAsync</span><span class="p">(</span><span class="s2">&quot;myfile.json&quot;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">json</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Successful json&quot;</span><span class="p">)</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">SyntaxError</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;file contains invalid json&quot;</span><span class="p">);</span>
<span class="p">}).</span><span class="nx">error</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;unable to read file, because: &quot;</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
<p>Now, because there is no catch-all handler, if you typed <code>console.lag</code> (causes an error you don&#39;t expect), you will see:</p>
<div class="highlight"><pre><span class="vg">Possibly</span><span class="w"> </span><span class="vg">unhandled</span><span class="w"> </span><span class="nl">TypeError:</span><span class="w"> </span><span class="vg">Object</span><span class="w"> </span><span class="err">#</span><span class="o">&lt;</span><span class="vg">Console</span><span class="o">&gt;</span><span class="w"> </span><span class="vg">has</span><span class="w"> </span><span class="vg">no</span><span class="w"> </span><span class="vg">method</span><span class="w"> </span><span class="c1">&#39;lag&#39;</span>
<span class="w">    </span><span class="vg">at</span><span class="w"> </span><span class="vg">application</span><span class="o">.</span><span class="nl">js:</span><span class="il">8</span><span class="o">:</span><span class="il">13</span>
<span class="vg">From</span><span class="w"> </span><span class="vg">previous</span><span class="w"> </span><span class="nl">event:</span>
<span class="w">    </span><span class="vg">at</span><span class="w"> </span><span class="vg">Object</span><span class="o">.&lt;</span><span class="vg">anonymous</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="vg">application</span><span class="o">.</span><span class="nl">js:</span><span class="il">7</span><span class="o">:</span><span class="il">4</span><span class="p">)</span>
<span class="w">    </span><span class="vg">at</span><span class="w"> </span><span class="vg">Module</span><span class="o">.</span><span class="vg">_compile</span><span class="w"> </span><span class="p">(</span><span class="vg">module</span><span class="o">.</span><span class="nl">js:</span><span class="il">449</span><span class="o">:</span><span class="il">26</span><span class="p">)</span>
<span class="w">    </span><span class="vg">at</span><span class="w"> </span><span class="vg">Object</span><span class="o">.</span><span class="vg">Module</span><span class="o">.</span><span class="vg">_extensions</span><span class="o">..</span><span class="vg">js</span><span class="w"> </span><span class="p">(</span><span class="vg">module</span><span class="o">.</span><span class="nl">js:</span><span class="il">467</span><span class="o">:</span><span class="il">10</span><span class="p">)</span>
<span class="w">    </span><span class="vg">at</span><span class="w"> </span><span class="vg">Module</span><span class="o">.</span><span class="vg">load</span><span class="w"> </span><span class="p">(</span><span class="vg">module</span><span class="o">.</span><span class="nl">js:</span><span class="il">349</span><span class="o">:</span><span class="il">32</span><span class="p">)</span>
<span class="w">    </span><span class="vg">at</span><span class="w"> </span><span class="vg">Function</span><span class="o">.</span><span class="vg">Module</span><span class="o">.</span><span class="vg">_load</span><span class="w"> </span><span class="p">(</span><span class="vg">module</span><span class="o">.</span><span class="nl">js:</span><span class="il">305</span><span class="o">:</span><span class="il">12</span><span class="p">)</span>
<span class="w">    </span><span class="vg">at</span><span class="w"> </span><span class="vg">Function</span><span class="o">.</span><span class="vg">Module</span><span class="o">.</span><span class="vg">runMain</span><span class="w"> </span><span class="p">(</span><span class="vg">module</span><span class="o">.</span><span class="nl">js:</span><span class="il">490</span><span class="o">:</span><span class="il">10</span><span class="p">)</span>
<span class="w">    </span><span class="vg">at</span><span class="w"> </span><span class="vg">startup</span><span class="w"> </span><span class="p">(</span><span class="vg">node</span><span class="o">.</span><span class="nl">js:</span><span class="il">121</span><span class="o">:</span><span class="il">16</span><span class="p">)</span>
<span class="w">    </span><span class="vg">at</span><span class="w"> </span><span class="vg">node</span><span class="o">.</span><span class="nl">js:</span><span class="il">761</span><span class="o">:</span><span class="il">3</span>
</pre></div>
<p><em>( If you don&#39;t get the above - you need to enable                 <a href="#promiselongstacktraces---undefined" title="">long stack traces</a>
 )</em></p>

<p>And if the file contains invalid JSON:</p>
<div class="highlight"><pre><span class="vg">file</span><span class="w"> </span><span class="vg">contains</span><span class="w"> </span><span class="vg">invalid</span><span class="w"> </span><span class="vg">json</span>
</pre></div>
<p>And if the <code>fs</code> module causes an error like file not found:</p>
<div class="highlight"><pre><span class="vg">unable</span><span class="w"> </span><span class="vg">to</span><span class="w"> </span><span class="vg">read</span><span class="w"> </span><span class="vg">file</span><span class="p">,</span><span class="w"> </span><span class="nl">because:</span><span class="w">  </span><span class="vg">ENOENT</span><span class="p">,</span><span class="w"> </span><span class="vg">open</span><span class="w"> </span><span class="c1">&#39;not_there.txt&#39;</span>
</pre></div>
<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name=".finally"
                    aria-hidden="true"
                    href="#.finally"><i class="fa fa-link"></i></a>
                .finally
            </h2>
<div class="highlight"><pre><span class="p">.</span><span class="k">finally</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="nx">handler</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div><div class="highlight"><pre><span class="p">.</span><span class="nx">lastly</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="nx">handler</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div>
<p>Pass a handler that will be called regardless of this promise&#39;s fate. Returns a new promise chained from this promise. There are special semantics for                 <a href="/bluebird/web/docs/api-reference.html#.finally"><code><code>.finally</code></code></a>
 in that the final value cannot be modified from the handler.</p>

<p><em>Note: using                 <a href="/bluebird/web/docs/api-reference.html#.finally"><code><code>.finally</code></code></a>
 for resource management has better alternatives, see                 <a href="#resource-management" title="">resource management</a>
</em></p>

<p>Consider the example:</p>
<div class="highlight"><pre><span class="kd">function</span> <span class="nx">anyway</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#ajax-loader-animation&quot;</span><span class="p">).</span><span class="nx">hide</span><span class="p">();</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">ajaxGetAsync</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">;</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="nx">reject</span><span class="p">);</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;load&quot;</span><span class="p">,</span> <span class="nx">resolve</span><span class="p">);</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="nx">url</span><span class="p">);</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
    <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">anyway</span><span class="p">,</span> <span class="nx">anyway</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>This example doesn&#39;t work as intended because the <code>then</code> handler actually swallows the exception and returns <code>undefined</code> for any further chainers.</p>

<p>The situation can be fixed with <code>.finally</code>:</p>
<div class="highlight"><pre><span class="kd">function</span> <span class="nx">ajaxGetAsync</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">;</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="nx">reject</span><span class="p">);</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;load&quot;</span><span class="p">,</span> <span class="nx">resolve</span><span class="p">);</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="nx">url</span><span class="p">);</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
    <span class="p">}).</span><span class="k">finally</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#ajax-loader-animation&quot;</span><span class="p">).</span><span class="nx">hide</span><span class="p">();</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></div>
<p>Now the animation is hidden but an exception or the actual return value will automatically skip the finally and propagate to further chainers. This is more in line with the synchronous <code>finally</code> keyword.</p>

<p><em>For compatibility with earlier ECMAScript version, an alias <code>.lastly</code> is provided for                 <a href="/bluebird/web/docs/api-reference.html#.finally"><code><code>.finally</code></code></a>
.</em></p>

<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name=".bind"
                    aria-hidden="true"
                    href="#.bind"><i class="fa fa-link"></i></a>
                .bind
            </h2>
<div class="highlight"><pre><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">any</span><span class="o">|</span><span class="nx">Promise</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span> <span class="nx">thisArg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">BoundPromise</span>
</pre></div>
<p>Same as calling                 <a href="/bluebird/web/docs/api-reference.html#promise.bind"><code>Promise.bind(thisArg, thisPromise)</code></a>
.</p>
            <h2>
                <a class="header-anchor"
                    name="promise.bind"
                    aria-hidden="true"
                    href="#promise.bind"><i class="fa fa-link"></i></a>
                Promise.bind
            </h2>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span>
    <span class="nx">any</span><span class="o">|</span><span class="nx">Promise</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span> <span class="nx">thisArg</span><span class="p">,</span>
    <span class="p">[</span><span class="nx">any</span><span class="o">|</span><span class="nx">Promise</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span> <span class="nx">value</span><span class="o">=</span><span class="kc">undefined</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">BoundPromise</span>
</pre></div>
<p>Create a promise that follows this promise or in the static method is resolved with the given <code>value</code>, but is bound to the given <code>thisArg</code> value. A bound promise will call its handlers with the bound value set to <code>this</code>. Additionally promises derived from a bound promise will also be bound promises with the same <code>thisArg</code> binding as the original promise.</p>

<p>If <code>thisArg</code> is a promise or thenable, its resolution will be awaited for and the bound value will be the promise&#39;s fulfillment value. If <code>thisArg</code> rejects
then the returned promise is rejected with the <code>thisArg&#39;s</code> rejection reason. Note that this means you cannot use <code>this</code> without checking inside catch handlers for promises that bind to promise because in case of rejection of <code>thisArg</code>, <code>this</code> will be <code>undefined</code>.</p>

<p><hr></p>

<p>Without arrow functions that provide lexical <code>this</code>, the correspondence between async and sync code breaks down when writing object-oriented code.                 <a href="/bluebird/web/docs/api-reference.html#.bind"><code><code>.bind</code></code></a>
 alleviates this.</p>

<p>Consider:</p>
<div class="highlight"><pre><span class="nx">MyClass</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">contents</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">file</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">urlParse</span><span class="p">(</span><span class="nx">contents</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">httpGetSync</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">refined</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">refine</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">writeRefinedSync</span><span class="p">(</span><span class="nx">refined</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>
</pre></div>
<p>The above has a direct translation:</p>
<div class="highlight"><pre><span class="nx">MyClass</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileAsync</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">file</span><span class="p">).</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">contents</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">urlParse</span><span class="p">(</span><span class="nx">contents</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">httpGetAsync</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
    <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">refined</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">refine</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">writeRefinedAsync</span><span class="p">(</span><span class="nx">refined</span><span class="p">);</span>
    <span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">};</span>
</pre></div>
<p><code>.bind</code> is the most efficient way of utilizing <code>this</code> with promises. The handler functions in the above code are not closures and can therefore even be hoisted out if needed. There is literally no overhead when propagating the bound value from one promise to another.</p>

<p><hr></p>

<p><code>.bind</code> also has a useful side purpose - promise handlers don&#39;t need to share a function to use shared state:</p>
<div class="highlight"><pre><span class="nx">somethingAsync</span><span class="p">().</span><span class="nx">bind</span><span class="p">({})</span>
<span class="p">.</span><span class="nx">spread</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">aValue</span><span class="p">,</span> <span class="nx">bValue</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">aValue</span> <span class="o">=</span> <span class="nx">aValue</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bValue</span> <span class="o">=</span> <span class="nx">bValue</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">somethingElseAsync</span><span class="p">(</span><span class="nx">aValue</span><span class="p">,</span> <span class="nx">bValue</span><span class="p">);</span>
<span class="p">})</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">cValue</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">aValue</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">bValue</span> <span class="o">+</span> <span class="nx">cValue</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>
<p>The above without                 <a href="/bluebird/web/docs/api-reference.html#.bind"><code><code>.bind</code></code></a>
 could be achieved with:</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">scope</span> <span class="o">=</span> <span class="p">{};</span>
<span class="nx">somethingAsync</span><span class="p">()</span>
<span class="p">.</span><span class="nx">spread</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">aValue</span><span class="p">,</span> <span class="nx">bValue</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">scope</span><span class="p">.</span><span class="nx">aValue</span> <span class="o">=</span> <span class="nx">aValue</span><span class="p">;</span>
    <span class="nx">scope</span><span class="p">.</span><span class="nx">bValue</span> <span class="o">=</span> <span class="nx">bValue</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">somethingElseAsync</span><span class="p">(</span><span class="nx">aValue</span><span class="p">,</span> <span class="nx">bValue</span><span class="p">);</span>
<span class="p">})</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">cValue</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">aValue</span> <span class="o">+</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">bValue</span> <span class="o">+</span> <span class="nx">cValue</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>
<p>However, there are many differences when you look closer:</p>

<ul>
<li>Requires a statement so cannot be used in an expression context</li>
<li>If not there already, an additional wrapper function is required to aundefined leaking or sharing <code>scope</code></li>
<li>The handler functions are now closures, thus less efficient and not reusable</li>
</ul>

<p><hr></p>

<p>Note that bind is only propagated with promise transformation. If you create new promise chains inside a handler, those chains are not bound to the &quot;upper&quot; <code>this</code>:</p>
<div class="highlight"><pre><span class="nx">something</span><span class="p">().</span><span class="nx">bind</span><span class="p">(</span><span class="nx">var1</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">//`this` is var1 here</span>
    <span class="k">return</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">getStuff</span><span class="p">()).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//`this` is undefined here</span>
        <span class="c1">//refine results here etc</span>
    <span class="p">});</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">//`this` is var1 here</span>
<span class="p">});</span>
</pre></div>
<p>However, if you are utilizing the full bluebird API offering, you will <em>almost never</em> need to resort to nesting promises in the first place. The above should be written more like:</p>
<div class="highlight"><pre><span class="nx">something</span><span class="p">().</span><span class="nx">bind</span><span class="p">(</span><span class="nx">var1</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">//`this` is var1 here</span>
    <span class="k">return</span> <span class="nx">getStuff</span><span class="p">();</span>
<span class="p">}).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//`this` is var1 here</span>
    <span class="c1">//refine result here</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">//`this` is var1 here</span>
<span class="p">});</span>
</pre></div>
<p>Also see [this Stackoverflow answer]`](.) can clean up code.</p>

<p><hr></p>

<p>If you don&#39;t want to return a bound promise to the consumers of a promise, you can rebind the chain at the end:</p>
<div class="highlight"><pre><span class="nx">MyClass</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileAsync</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">file</span><span class="p">).</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">contents</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">urlParse</span><span class="p">(</span><span class="nx">contents</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">httpGetAsync</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
    <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">refined</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">refine</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">writeRefinedAsync</span><span class="p">(</span><span class="nx">refined</span><span class="p">);</span>
    <span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>
    <span class="p">}).</span><span class="nx">bind</span><span class="p">();</span> <span class="c1">//The `thisArg` is implicitly undefined - I.E. the default promise `this` value</span>
<span class="p">};</span>
</pre></div>
<p>Rebinding can also be abused to do something gratuitous like this:</p>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="s2">&quot;my-element&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nb">document</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">console</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">);</span>
</pre></div>
<p>The above does <code>console.log</code>](.)s are necessary because in browser neither of the methods can be called as a stand-alone function.</p>

<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name="promise.join"
                    aria-hidden="true"
                    href="#promise.join"><i class="fa fa-link"></i></a>
                Promise.join
            </h2>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span>
    <span class="nx">Promise</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;|</span><span class="nx">any</span> <span class="nx">values</span><span class="p">...,</span>
    <span class="kd">function</span> <span class="nx">handler</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div>
<p>For coordinating multiple concurrent discrete promises. While                 <a href="/bluebird/web/docs/api-reference.html#.all"><code><code>.all</code></code></a>
 is good for handling a dynamically sized list of uniform promises, <code>Promise.join</code> is much easier (and more performant) to use when you have a fixed amount of discrete promises that you want to coordinate concurrently, for example:</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">join</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">join</span><span class="p">;</span>

<span class="nx">join</span><span class="p">(</span><span class="nx">getPictures</span><span class="p">(),</span> <span class="nx">getComments</span><span class="p">(),</span> <span class="nx">getTweets</span><span class="p">(),</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">pictures</span><span class="p">,</span> <span class="nx">comments</span><span class="p">,</span> <span class="nx">tweets</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;in total: &quot;</span> <span class="o">+</span> <span class="nx">pictures</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="nx">comments</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="nx">tweets</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
<span class="p">});</span>
</pre></div><div class="highlight"><pre><span class="kd">var</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;fs&quot;</span><span class="p">));</span>
<span class="kd">var</span> <span class="nx">pg</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;pg&quot;</span><span class="p">);</span>
<span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">pg</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">filter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">methodName</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">methodName</span> <span class="o">===</span> <span class="s2">&quot;connect&quot;</span>
    <span class="p">},</span>
    <span class="nx">multiArgs</span><span class="o">:</span> <span class="kc">true</span>
<span class="p">});</span>
<span class="c1">// Promisify rest of pg normally</span>
<span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">pg</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">join</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">join</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">connectionString</span> <span class="o">=</span> <span class="s2">&quot;postgres://username:password@localhost/database&quot;</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">fContents</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileAsync</span><span class="p">(</span><span class="s2">&quot;file.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;utf8&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">fStat</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">statAsync</span><span class="p">(</span><span class="s2">&quot;file.txt&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">fSqlClient</span> <span class="o">=</span> <span class="nx">pg</span><span class="p">.</span><span class="nx">connectAsync</span><span class="p">(</span><span class="nx">connectionString</span><span class="p">).</span><span class="nx">spread</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">close</span> <span class="o">=</span> <span class="nx">done</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">client</span><span class="p">;</span>
<span class="p">});</span>

<span class="nx">join</span><span class="p">(</span><span class="nx">fContents</span><span class="p">,</span> <span class="nx">fStat</span><span class="p">,</span> <span class="nx">fSqlClient</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">contents</span><span class="p">,</span> <span class="nx">stat</span><span class="p">,</span> <span class="nx">sqlClient</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">query</span> <span class="o">=</span> <span class="s2">&quot;                                                              \</span>
<span class="s2">        INSERT INTO files (byteSize, contents)                                 \</span>
<span class="s2">        VALUES ($1, $2)                                                        \</span>
<span class="s2">    &quot;</span><span class="p">;</span>
   <span class="k">return</span> <span class="nx">sqlClient</span><span class="p">.</span><span class="nx">queryAsync</span><span class="p">(</span><span class="nx">query</span><span class="p">,</span> <span class="p">[</span><span class="nx">stat</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="nx">contents</span><span class="p">]).</span><span class="nx">thenReturn</span><span class="p">(</span><span class="nx">query</span><span class="p">);</span>
<span class="p">})</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">query</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Successfully ran the Query: &quot;</span> <span class="o">+</span> <span class="nx">query</span><span class="p">);</span>
<span class="p">})</span>
<span class="p">.</span><span class="k">finally</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// This is why you want to use Promise.using for resource management</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">fSqlClient</span><span class="p">.</span><span class="nx">isFulfilled</span><span class="p">())</span> <span class="p">{</span>
        <span class="nx">fSqlClient</span><span class="p">.</span><span class="nx">value</span><span class="p">().</span><span class="nx">close</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">});</span>
</pre></div>
<p><em>Note: In 1.x and 0.x <code>Promise.join</code> used to be a <code>Promise.all</code> that took the values in as arguments instead in an array. This behavior has been deprecated but is still supported partially - when the last argument is an immediate function value the new semantics will apply</em></p>

<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name="promise.try"
                    aria-hidden="true"
                    href="#promise.try"><i class="fa fa-link"></i></a>
                Promise.try
            </h2>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="k">try</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="nx">fn</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div><div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">attempt</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="nx">fn</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div>
<p>Start the chain of promises with <code>Promise.try</code>. Any synchronous exceptions will be turned into rejections on the returned promise.</p>
<div class="highlight"><pre><span class="kd">function</span> <span class="nx">getUserById</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Promise</span><span class="p">.</span><span class="k">try</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">id</span> <span class="o">!==</span> <span class="s2">&quot;number&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;id must be a number&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">db</span><span class="p">.</span><span class="nx">getUserById</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></div>
<p>Now if someone uses this function, they will catch all errors in their Promise <code>.catch</code> handlers instead of having to handle both synchronous and asynchronous exception flows.</p>

<p><em>For compatibility with earlier ECMAScript version, an alias <code>Promise.attempt</code> is provided for                 <a href="/bluebird/web/docs/api-reference.html#promise.try"><code><code>Promise.try</code></code></a>
.</em></p>

<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name="promise.method"
                    aria-hidden="true"
                    href="#promise.method"><i class="fa fa-link"></i></a>
                Promise.method
            </h2>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">method</span><span class="p">(</span><span class="kd">function</span><span class="p">(...</span><span class="nx">arguments</span><span class="p">)</span> <span class="nx">fn</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kd">function</span>
</pre></div>
<p>Returns a new function that wraps the given function <code>fn</code>. The new function will always return a promise that is fulfilled with the original functions return values or rejected with thrown exceptions from the original function.</p>

<p>This method is convenient when a function can sometimes return synchronously or throw synchronously.</p>

<p>Example without using <code>Promise.method</code>:</p>
<div class="highlight"><pre><span class="nx">MyClass</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">input</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isValid</span><span class="p">(</span><span class="nx">input</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s2">&quot;input is not valid&quot;</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">cache</span><span class="p">(</span><span class="nx">input</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">someCachedValue</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">db</span><span class="p">.</span><span class="nx">queryAsync</span><span class="p">(</span><span class="nx">input</span><span class="p">).</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">someCachedValue</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
    <span class="p">});</span>
<span class="p">};</span>
</pre></div>
<p>Using the same function <code>Promise.method</code>, there is no need to manually wrap direct return or throw values into a promise:</p>
<div class="highlight"><pre><span class="nx">MyClass</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">method</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">input</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isValid</span><span class="p">(</span><span class="nx">input</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s2">&quot;input is not valid&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">cache</span><span class="p">(</span><span class="nx">input</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">someCachedValue</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">db</span><span class="p">.</span><span class="nx">queryAsync</span><span class="p">(</span><span class="nx">input</span><span class="p">).</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">someCachedValue</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
    <span class="p">});</span>
<span class="p">});</span>
</pre></div>
<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name="promise.resolve"
                    aria-hidden="true"
                    href="#promise.resolve"><i class="fa fa-link"></i></a>
                Promise.resolve
            </h2>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">Promise</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;|</span><span class="nx">any</span> <span class="nx">value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div>
<p>Create a promise that is resolved with the given value. If <code>value</code> is already a trusted <code>Promise</code>, it is returned as is. If <code>value</code> is not a thenable, a fulfilled Promise is returned with <code>value</code> as its fulfillment value. If <code>value</code> is a thenable (Promise-like object, like those returned by jQuery&#39;s <code>$.ajax</code>), returns a trusted Promise that assimilates the state of the thenable.</p>

<p>Example: (<code>$</code> is jQuery)</p>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;http://www.google.com&quot;</span><span class="p">)).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">//Returning a thenable from a handler is automatically</span>
    <span class="c1">//cast to a trusted Promise as per Promises/A+ specification</span>
    <span class="k">return</span> <span class="nx">$</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&quot;http://www.yahoo.com&quot;</span><span class="p">);</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//jQuery doesn&#39;t throw real errors so use catch-all</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">statusText</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name="promise.reject"
                    aria-hidden="true"
                    href="#promise.reject"><i class="fa fa-link"></i></a>
                Promise.reject
            </h2>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">any</span> <span class="nx">error</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div>
<p>Create a promise that is rejected with the given <code>error</code>.</p>
</div>

            <h2>
                <a class="header-anchor"
                    name="synchronous-inspection"
                    aria-hidden="true"
                    href="#synchronous-inspection"><i class="fa fa-link"></i></a>
                Synchronous inspection
            </h2>

<p>Often it is known in certain code paths that a promise is guaranteed to be fulfilled at that point - it would then be extremely inconvenient to use                 <a href="/bluebird/web/docs/api-reference.html#.then"><code><code>.then</code></code></a>
 to get at the promise&#39;s value as the callback is always called asynchronously.</p>

<p><strong>Note</strong>: In recent versions of Bluebird a design choice was made to expose                 <a href="/bluebird/web/docs/api-reference.html#.reason"><code>.reason()</code></a>
 and                 <a href="/bluebird/web/docs/api-reference.html#.value"><code>.value()</code></a>
 as well as other inspection methods on promises directly in order to make the below use case easier to work with. Every promise implements the                 <a href="/bluebird/web/docs/api-reference.html#promiseinspection"><code>PromiseInspection</code></a>
 interface.</p>

<p>For example, if you need to use values of earlier promises in the chain, you could nest:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="c1">// From Q Docs https://github.com/kriskowal/q/#chaining</span>
<span class="c1">// MIT License Copyright 20092014 Kristopher Michael Kowal.</span>
<span class="kd">function</span> <span class="nx">authenticate</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">getUsername</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">username</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">getUser</span><span class="p">(</span><span class="nx">username</span><span class="p">);</span>
    <span class="c1">// chained because we will not need the user name in the next event</span>
    <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// nested because we need both user and password next</span>
        <span class="k">return</span> <span class="nx">getPassword</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">password</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">passwordHash</span> <span class="o">!==</span> <span class="nx">hash</span><span class="p">(</span><span class="nx">password</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Can&#39;t authenticate&quot;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div>
<p>Or you could take advantage of the fact that if we reach password validation, then the user promise must be fulfilled:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">authenticate</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">getUsername</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">username</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">getUser</span><span class="p">(</span><span class="nx">username</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">user</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">getPassword</span><span class="p">();</span>
    <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">password</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Guaranteed that user promise is fulfilled, so .value() can be called here</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">value</span><span class="p">().</span><span class="nx">passwordHash</span> <span class="o">!==</span> <span class="nx">hash</span><span class="p">(</span><span class="nx">password</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Can&#39;t authenticate&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div>
<p>In the latter the indentation stays flat no matter how many previous variables you need, whereas with the former each additional previous value would require an additional nesting level.</p>
<div class="api-code-section">            <h2>
                <a class="header-anchor"
                    name="promiseinspection"
                    aria-hidden="true"
                    href="#promiseinspection"><i class="fa fa-link"></i></a>
                PromiseInspection
            </h2>
<div class="highlight"><pre><span class="kr">interface</span> <span class="nx">PromiseInspection</span> <span class="p">{</span>
    <span class="nx">any</span> <span class="nx">reason</span><span class="p">()</span>
    <span class="nx">any</span> <span class="nx">value</span><span class="p">()</span>
    <span class="kr">boolean</span> <span class="nx">pending</span><span class="p">()</span>
    <span class="kr">boolean</span> <span class="nx">isRejected</span><span class="p">()</span>
    <span class="kr">boolean</span> <span class="nx">isFulfilled</span><span class="p">()</span>
    <span class="kr">boolean</span> <span class="nx">isCancelled</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>
<p>This interface is implemented by <code>Promise</code> instances as well as the <code>PromiseInspection</code> result given by                 <a href="/bluebird/web/docs/api-reference.html#.reflect"><code>.reflect()</code></a>
.</p>

<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name=".isfulfilled"
                    aria-hidden="true"
                    href="#.isfulfilled"><i class="fa fa-link"></i></a>
                .isFulfilled
            </h2>
<div class="highlight"><pre><span class="p">.</span><span class="nx">isFulfilled</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kr">boolean</span>
</pre></div>
<p>See if this <code>promise</code> has been fulfilled.</p>

<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name=".isrejected"
                    aria-hidden="true"
                    href="#.isrejected"><i class="fa fa-link"></i></a>
                .isRejected
            </h2>
<div class="highlight"><pre><span class="p">.</span><span class="nx">isRejected</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kr">boolean</span>
</pre></div>
<p>See if this <code>promise</code> has been rejected.</p>

<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name=".iscancelled"
                    aria-hidden="true"
                    href="#.iscancelled"><i class="fa fa-link"></i></a>
                .isCancelled
            </h2>
<div class="highlight"><pre><span class="p">.</span><span class="nx">isCancelled</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kr">boolean</span>
</pre></div>
<p>See if this <code>promise</code> has been cancelled.</p>

<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name=".ispending"
                    aria-hidden="true"
                    href="#.ispending"><i class="fa fa-link"></i></a>
                .isPending
            </h2>
<div class="highlight"><pre><span class="p">.</span><span class="nx">isPending</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kr">boolean</span>
</pre></div>
<p>See if this <code>promise</code> is pending (not fulfilled or rejected or cancelled).</p>

<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name=".value"
                    aria-hidden="true"
                    href="#.value"><i class="fa fa-link"></i></a>
                .value
            </h2>
<div class="highlight"><pre><span class="p">.</span><span class="nx">value</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nx">any</span>
</pre></div>
<p>Get the fulfillment value of this promise. Throws an error if the promise isn&#39;t fulfilled - it is a bug to call this method on an unfulfilled promise.</p>

<p>You should check if this promise is                 <a href="/bluebird/web/docs/api-reference.html#.isfulfilled"><code>.isFulfilled()</code></a>
 in code paths where it&#39;s guaranteed that this promise is fulfilled.</p>

<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name=".reason"
                    aria-hidden="true"
                    href="#.reason"><i class="fa fa-link"></i></a>
                .reason
            </h2>
<div class="highlight"><pre><span class="p">.</span><span class="nx">reason</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nx">any</span>
</pre></div>
<p>Get the rejection reason of this promise. Throws an error if the promise isn&#39;t rejected - it is a bug to call this method on an unrejected promise.</p>

<p>You should check if this promise is                 <a href="/bluebird/web/docs/api-reference.html#.isrejected"><code>.isRejected()</code></a>
 in code paths where it&#39;s guaranteed that this promise is rejected.</p>

<p><hr></p>
</div>

            <h2>
                <a class="header-anchor"
                    name="collections"
                    aria-hidden="true"
                    href="#collections"><i class="fa fa-link"></i></a>
                Collections
            </h2>

<p>Methods of <code>Promise</code> instances and core static methods of the Promise class to deal with collections of promises or mixed promises and values.</p>

<p>All collection methods have a static equivalent on the Promise object, e.g. <code>somePromise.map(...)...</code> is same as <code>Promise.map(somePromise, ...)...</code>,
<code>somePromise.all</code> is same as                 <a href="/bluebird/web/docs/api-reference.html#promise.all"><code><code>Promise.all</code></code></a>
 and so on.</p>

<p>None of the collection methods modify the original input. Holes in arrays are treated as if they were defined with the value <code>undefined</code>.</p>
<div class="api-code-section">            <h2>
                <a class="header-anchor"
                    name=".all"
                    aria-hidden="true"
                    href="#.all"><i class="fa fa-link"></i></a>
                .all
            </h2>
<div class="highlight"><pre><span class="p">.</span><span class="nx">all</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div>
<p>Same as                 <a href="/bluebird/web/docs/api-reference.html#promise.all"><code>Promise.all(this)</code></a>
.</p>
            <h2>
                <a class="header-anchor"
                    name="promise.all"
                    aria-hidden="true"
                    href="#promise.all"><i class="fa fa-link"></i></a>
                Promise.all
            </h2>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">Iterable</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;|</span><span class="nx">Promise</span><span class="o">&lt;</span><span class="nx">Iterable</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;&gt;</span> <span class="nx">input</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div>
<p>Given an                 <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Iteration_protocols" title=""><code>Iterable</code></a>
(arrays are <code>Iterable</code>), or a promise of an <code>Iterable</code>, which produces promises (or a mix of promises and values), iterate over all the values in the <code>Iterable</code> into an array and return a promise that is fulfilled when all the items in the array are fulfilled. The promise&#39;s fulfillment value is an array with fulfillment values at respective positions to the original array. If any promise in the array rejects, the returned promise is rejected with the rejection reason.</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">files</span> <span class="o">=</span> <span class="p">[];</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">files</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">writeFileAsync</span><span class="p">(</span><span class="s2">&quot;file-&quot;</span> <span class="o">+</span> <span class="nx">i</span> <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">));</span>
<span class="p">}</span>
<span class="nx">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">files</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;all the files were created&quot;</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name=".props"
                    aria-hidden="true"
                    href="#.props"><i class="fa fa-link"></i></a>
                .props
            </h2>
<div class="highlight"><pre><span class="p">.</span><span class="nx">props</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div>
<p>Same as                 <a href="/bluebird/web/docs/api-reference.html#promise.props"><code>Promise.props(this)</code></a>
.</p>
            <h2>
                <a class="header-anchor"
                    name="promise.props"
                    aria-hidden="true"
                    href="#promise.props"><i class="fa fa-link"></i></a>
                Promise.props
            </h2>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">props</span><span class="p">(</span><span class="nb">Object</span><span class="o">|</span><span class="nx">Map</span><span class="o">|</span><span class="nx">Promise</span><span class="o">&lt;</span><span class="nb">Object</span><span class="o">|</span><span class="nx">Map</span><span class="o">&gt;</span> <span class="nx">input</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div>
<p>Like                 <a href="/bluebird/web/docs/api-reference.html#.all"><code><code>.all</code></code></a>
 but for object properties or <code>Map</code>s* entries instead of iterated values. Returns a promise that is fulfilled when all the properties of the object or the <code>Map</code>&#39;s&#39; values** are fulfilled. The promise&#39;s fulfillment value is an object or a <code>Map</code> with fulfillment values at respective keys to the original object or a <code>Map</code>. If any promise in the object or <code>Map</code> rejects, the returned promise is rejected with the rejection reason.</p>

<p>If <code>object</code> is a trusted <code>Promise</code>, then it will be treated as a promise for object rather than for its properties. All other objects (except <code>Map</code>s) are treated for their properties as is returned by <code>Object.keys</code> - the object&#39;s own enumerable properties.</p>

<p><em>*Only the native                 <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Map" title="">ECMAScript 6 <code>Map</code></a>
 implementation that is provided by the environment as is is supported</em></p>

<p><em>**If the map&#39;s keys happen to be <code>Promise</code>s, they are not awaited for and the resulting <code>Map</code> will still have those same <code>Promise</code> instances as keys</em></p>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">props</span><span class="p">({</span>
    <span class="nx">pictures</span><span class="o">:</span> <span class="nx">getPictures</span><span class="p">(),</span>
    <span class="nx">comments</span><span class="o">:</span> <span class="nx">getComments</span><span class="p">(),</span>
    <span class="nx">tweets</span><span class="o">:</span> <span class="nx">getTweets</span><span class="p">()</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">tweets</span><span class="p">,</span> <span class="nx">result</span><span class="p">.</span><span class="nx">pictures</span><span class="p">,</span> <span class="nx">result</span><span class="p">.</span><span class="nx">comments</span><span class="p">);</span>
<span class="p">});</span>
</pre></div><div class="highlight"><pre><span class="kd">var</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;fs&quot;</span><span class="p">));</span>
<span class="kd">var</span> <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;lodash&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">util</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;util&quot;</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">directorySizeInfo</span><span class="p">(</span><span class="nx">root</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">counts</span> <span class="o">=</span> <span class="p">{</span><span class="nx">dirs</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">files</span><span class="o">:</span> <span class="mi">0</span><span class="p">};</span>
    <span class="kd">var</span> <span class="nx">stats</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="nx">reader</span><span class="p">(</span><span class="nx">root</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readdirAsync</span><span class="p">(</span><span class="nx">root</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">fileName</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">filePath</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="nx">fileName</span><span class="p">);</span>
            <span class="k">return</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">statAsync</span><span class="p">(</span><span class="nx">filePath</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">stat</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">stat</span><span class="p">.</span><span class="nx">filePath</span> <span class="o">=</span> <span class="nx">filePath</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">stat</span><span class="p">.</span><span class="nx">isDirectory</span><span class="p">())</span> <span class="p">{</span>
                    <span class="nx">counts</span><span class="p">.</span><span class="nx">dirs</span><span class="o">++</span><span class="p">;</span>
                    <span class="k">return</span> <span class="nx">reader</span><span class="p">(</span><span class="nx">filePath</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="nx">counts</span><span class="p">.</span><span class="nx">files</span><span class="o">++</span><span class="p">;</span>
                <span class="k">return</span> <span class="nx">stat</span><span class="p">;</span>
            <span class="p">});</span>
        <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">flatten</span><span class="p">);</span>
    <span class="p">})(</span><span class="nx">root</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">_</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">smallest</span> <span class="o">=</span> <span class="nx">stats</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">).</span><span class="nx">call</span><span class="p">(</span><span class="s2">&quot;pick&quot;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="s2">&quot;filePath&quot;</span><span class="p">).</span><span class="nx">call</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">largest</span> <span class="o">=</span> <span class="nx">stats</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s2">&quot;max&quot;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">).</span><span class="nx">call</span><span class="p">(</span><span class="s2">&quot;pick&quot;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="s2">&quot;filePath&quot;</span><span class="p">).</span><span class="nx">call</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">totalSize</span> <span class="o">=</span> <span class="nx">stats</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s2">&quot;pluck&quot;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">).</span><span class="nx">call</span><span class="p">(</span><span class="s2">&quot;reduce&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span><span class="p">;</span>
    <span class="p">},</span> <span class="mi">0</span><span class="p">);</span>

    <span class="k">return</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">props</span><span class="p">({</span>
        <span class="nx">counts</span><span class="o">:</span> <span class="nx">counts</span><span class="p">,</span>
        <span class="nx">smallest</span><span class="o">:</span> <span class="nx">smallest</span><span class="p">,</span>
        <span class="nx">largest</span><span class="o">:</span> <span class="nx">largest</span><span class="p">,</span>
        <span class="nx">totalSize</span><span class="o">:</span> <span class="nx">totalSize</span>
    <span class="p">});</span>
<span class="p">}</span>


<span class="nx">directorySizeInfo</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">||</span> <span class="s2">&quot;.&quot;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">sizeInfo</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="s2">&quot;                                                \n\</span>
<span class="s2">        %d directories, %d files                                             \n\</span>
<span class="s2">        Total size: %d bytes                                                 \n\</span>
<span class="s2">        Smallest file: %s with %d bytes                                      \n\</span>
<span class="s2">        Largest file: %s with %d bytes                                       \n\</span>
<span class="s2">    &quot;</span><span class="p">,</span> <span class="nx">sizeInfo</span><span class="p">.</span><span class="nx">counts</span><span class="p">.</span><span class="nx">dirs</span><span class="p">,</span> <span class="nx">sizeInfo</span><span class="p">.</span><span class="nx">counts</span><span class="p">.</span><span class="nx">files</span><span class="p">,</span> <span class="nx">sizeInfo</span><span class="p">.</span><span class="nx">totalSize</span><span class="p">,</span>
        <span class="nx">sizeInfo</span><span class="p">.</span><span class="nx">smallest</span><span class="p">.</span><span class="nx">filePath</span><span class="p">,</span> <span class="nx">sizeInfo</span><span class="p">.</span><span class="nx">smallest</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span>
        <span class="nx">sizeInfo</span><span class="p">.</span><span class="nx">largest</span><span class="p">.</span><span class="nx">filePath</span><span class="p">,</span> <span class="nx">sizeInfo</span><span class="p">.</span><span class="nx">largest</span><span class="p">.</span><span class="nx">size</span><span class="p">));</span>
<span class="p">});</span>
</pre></div>
<p>Note that if you have no use for the result object other than retrieving the properties, it is more convenient to use                 <a href="/bluebird/web/docs/api-reference.html#promise.join"><code><code>Promise.join</code></code></a>
:</p>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">getPictures</span><span class="p">(),</span> <span class="nx">getComments</span><span class="p">(),</span> <span class="nx">getTweets</span><span class="p">(),</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">pictures</span><span class="p">,</span> <span class="nx">comments</span><span class="p">,</span> <span class="nx">tweets</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">pictures</span><span class="p">,</span> <span class="nx">comments</span><span class="p">,</span> <span class="nx">tweets</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name=".any"
                    aria-hidden="true"
                    href="#.any"><i class="fa fa-link"></i></a>
                .any
            </h2>
<div class="highlight"><pre><span class="p">.</span><span class="nx">any</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div>
<p>Same as                 <a href="/bluebird/web/docs/api-reference.html#promise.any"><code>Promise.any(this)</code></a>
.</p>
            <h2>
                <a class="header-anchor"
                    name="promise.any"
                    aria-hidden="true"
                    href="#promise.any"><i class="fa fa-link"></i></a>
                Promise.any
            </h2>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">any</span><span class="p">(</span><span class="nx">Iterable</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;|</span><span class="nx">Promise</span><span class="o">&lt;</span><span class="nx">Iterable</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;&gt;</span> <span class="nx">input</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div>
<p>Like                 <a href="/bluebird/web/docs/api-reference.html#promise.some"><code>Promise.some</code></a>
, with 1 as <code>count</code>. However, if the promise fulfills, the fulfillment value is not an array of 1 but the value directly.</p>

<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name=".race"
                    aria-hidden="true"
                    href="#.race"><i class="fa fa-link"></i></a>
                .race
            </h2>
<div class="highlight"><pre><span class="p">.</span><span class="nx">race</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div>
<p>Same as                 <a href="/bluebird/web/docs/api-reference.html#promise.race"><code>Promise.race(this)</code></a>
.</p>
            <h2>
                <a class="header-anchor"
                    name="promise.race"
                    aria-hidden="true"
                    href="#promise.race"><i class="fa fa-link"></i></a>
                Promise.race
            </h2>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">race</span><span class="p">(</span><span class="nx">Iterable</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;|</span><span class="nx">Promise</span><span class="o">&lt;</span><span class="nx">Iterable</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;&gt;</span> <span class="nx">input</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div>
<p>Given an                 <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Iteration_protocols" title=""><code>Iterable</code></a>
(arrays are <code>Iterable</code>), or a promise of an <code>Iterable</code>, which produces promises (or a mix of promises and values), iterate over all the values in the <code>Iterable</code> into an array and return a promise that is fulfilled or rejected as soon as a promise in the array is fulfilled or rejected with the respective rejection reason or fulfillment value.</p>

<p>This method is only implemented because it&#39;s in the ES6 standard. If you want to race promises to fulfillment the                 <a href="/bluebird/web/docs/api-reference.html#.any"><code><code>.any</code></code></a>
 method is more appropriate as it doesn&#39;t qualify a rejected promise as the winner. It also has less surprises: <code>.race</code> must become infinitely pending if an empty array is passed but passing an empty array to                 <a href="/bluebird/web/docs/api-reference.html#.any"><code><code>.any</code></code></a>
 is more usefully a <code>RangeError</code></p>

<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name=".some"
                    aria-hidden="true"
                    href="#.some"><i class="fa fa-link"></i></a>
                .some
            </h2>
<div class="highlight"><pre><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="kr">int</span> <span class="nx">count</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div>
<p>Same as                 <a href="/bluebird/web/docs/api-reference.html#promise.some"><code>Promise.some(this, count)</code></a>
.</p>
            <h2>
                <a class="header-anchor"
                    name="promise.some"
                    aria-hidden="true"
                    href="#promise.some"><i class="fa fa-link"></i></a>
                Promise.some
            </h2>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span>
    <span class="nx">Iterable</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;|</span><span class="nx">Promise</span><span class="o">&lt;</span><span class="nx">Iterable</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;&gt;</span> <span class="nx">input</span><span class="p">,</span>
    <span class="kr">int</span> <span class="nx">count</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div>
<p>Given an                 <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Iteration_protocols" title=""><code>Iterable</code></a>
(arrays are <code>Iterable</code>), or a promise of an <code>Iterable</code>, which produces promises (or a mix of promises and values), iterate over all the values in the <code>Iterable</code> into an array and return a promise that is fulfilled as soon <code>count</code> promises are fulfilled in the array. The fulfillment value is an array with <code>count</code> values in the order they were fulfilled.</p>

<p>This example pings 4 nameservers, and logs the fastest 2 on console:</p>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">some</span><span class="p">([</span>
    <span class="nx">ping</span><span class="p">(</span><span class="s2">&quot;ns1.example.com&quot;</span><span class="p">),</span>
    <span class="nx">ping</span><span class="p">(</span><span class="s2">&quot;ns2.example.com&quot;</span><span class="p">),</span>
    <span class="nx">ping</span><span class="p">(</span><span class="s2">&quot;ns3.example.com&quot;</span><span class="p">),</span>
    <span class="nx">ping</span><span class="p">(</span><span class="s2">&quot;ns4.example.com&quot;</span><span class="p">)</span>
<span class="p">],</span> <span class="mi">2</span><span class="p">).</span><span class="nx">spread</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">first</span><span class="p">,</span> <span class="nx">second</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">first</span><span class="p">,</span> <span class="nx">second</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
<p>If too many promises are rejected so that the promise can never become fulfilled, it will be immediately rejected with an                 <a href="/bluebird/web/docs/api-reference.html#aggregateerror"><code>AggregateError</code></a>
 of the rejection reasons in the order they were thrown in.</p>

<p>You can get a reference to                 <a href="/bluebird/web/docs/api-reference.html#aggregateerror"><code>AggregateError</code></a>
 from <code>Promise.AggregateError</code>.</p>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">some</span><span class="p">(...)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(...)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(...)</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">Promise</span><span class="p">.</span><span class="nx">AggregateError</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">err</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">});</span>
</pre></div>
<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name=".map"
                    aria-hidden="true"
                    href="#.map"><i class="fa fa-link"></i></a>
                .map
            </h2>
<div class="highlight"><pre><span class="p">.</span><span class="nx">map</span><span class="p">(</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">any</span> <span class="nx">item</span><span class="p">,</span> <span class="kr">int</span> <span class="nx">index</span><span class="p">,</span> <span class="kr">int</span> <span class="nx">length</span><span class="p">)</span> <span class="nx">mapper</span><span class="p">,</span>
    <span class="p">[</span><span class="nb">Object</span> <span class="p">{</span><span class="nx">concurrency</span><span class="o">:</span> <span class="kr">int</span><span class="o">=</span><span class="kc">Infinity</span><span class="p">}</span> <span class="nx">options</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div>
<p>Same as                 <a href="/bluebird/web/docs/api-reference.html#promise.map"><code>Promise.map(this, mapper, options)</code></a>
.</p>
            <h2>
                <a class="header-anchor"
                    name="promise.map"
                    aria-hidden="true"
                    href="#promise.map"><i class="fa fa-link"></i></a>
                Promise.map
            </h2>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span>
    <span class="nx">Iterable</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;|</span><span class="nx">Promise</span><span class="o">&lt;</span><span class="nx">Iterable</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;&gt;</span> <span class="nx">input</span><span class="p">,</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">any</span> <span class="nx">item</span><span class="p">,</span> <span class="kr">int</span> <span class="nx">index</span><span class="p">,</span> <span class="kr">int</span> <span class="nx">length</span><span class="p">)</span> <span class="nx">mapper</span><span class="p">,</span>
    <span class="p">[</span><span class="nb">Object</span> <span class="p">{</span><span class="nx">concurrency</span><span class="o">:</span> <span class="kr">int</span><span class="o">=</span><span class="kc">Infinity</span><span class="p">}</span> <span class="nx">options</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div>
<p>Given an                 <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Iteration_protocols" title=""><code>Iterable</code></a>
(arrays are <code>Iterable</code>), or a promise of an <code>Iterable</code>, which produces promises (or a mix of promises and values), iterate over all the values in the <code>Iterable</code> into an array and                 <a href="http://en.wikipedia.org/wiki/Map_(higher-order_function)" title="">map the array to another</a>
 using the given <code>mapper</code> function.</p>

<p>Promises returned by the <code>mapper</code> function are awaited for and the returned promise doesn&#39;t fulfill until all mapped promises have fulfilled as well. If any promise in the array is rejected, or any promise returned by the <code>mapper</code> function is rejected, the returned promise is rejected as well.</p>

<p>The mapper function for a given item is called as soon as possible, that is, when the promise for that item&#39;s index in the input array is fulfilled. This doesn&#39;t mean that the result array has items in random order, it means that <code>.map</code> can be used for concurrency coordination unlike <code>.all</code>.</p>

<p>A common use of <code>Promise.map</code> is to replace the <code>.push</code>+<code>Promise.all</code> boilerplate:</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">promises</span> <span class="o">=</span> <span class="p">[];</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">fileNames</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">promises</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileAsync</span><span class="p">(</span><span class="nx">fileNames</span><span class="p">[</span><span class="nx">i</span><span class="p">]));</span>
<span class="p">}</span>
<span class="nx">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">promises</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;done&quot;</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// Using Promise.map:</span>
<span class="nx">Promise</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">fileNames</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fileName</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Promise.map awaits for returned promises as well.</span>
    <span class="k">return</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileAsync</span><span class="p">(</span><span class="nx">fileName</span><span class="p">);</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;done&quot;</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
<p>A more involved example:</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">join</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">join</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;fs&quot;</span><span class="p">));</span>
<span class="nx">fs</span><span class="p">.</span><span class="nx">readdirAsync</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">fileName</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">stat</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">statAsync</span><span class="p">(</span><span class="nx">fileName</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">contents</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileAsync</span><span class="p">(</span><span class="nx">fileName</span><span class="p">).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span> <span class="nx">ignore</span><span class="p">()</span> <span class="p">{});</span>
    <span class="k">return</span> <span class="nx">join</span><span class="p">(</span><span class="nx">stat</span><span class="p">,</span> <span class="nx">contents</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stat</span><span class="p">,</span> <span class="nx">contents</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="nx">stat</span><span class="o">:</span> <span class="nx">stat</span><span class="p">,</span>
            <span class="nx">fileName</span><span class="o">:</span> <span class="nx">fileName</span><span class="p">,</span>
            <span class="nx">contents</span><span class="o">:</span> <span class="nx">contents</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="c1">// The return value of .map is a promise that is fulfilled with an array of the mapped values</span>
<span class="c1">// That means we only get here after all the files have been statted and their contents read</span>
<span class="c1">// into memory. If you need to do more operations per file, they should be chained in the map</span>
<span class="c1">// callback for concurrency.</span>
<span class="p">}).</span><span class="nx">call</span><span class="p">(</span><span class="s2">&quot;sort&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">fileName</span><span class="p">.</span><span class="nx">localeCompare</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">fileName</span><span class="p">);</span>
<span class="p">}).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">contentLength</span> <span class="o">=</span> <span class="nx">file</span><span class="p">.</span><span class="nx">stat</span><span class="p">.</span><span class="nx">isDirectory</span><span class="p">()</span> <span class="o">?</span> <span class="s2">&quot;(directory)&quot;</span> <span class="o">:</span> <span class="nx">file</span><span class="p">.</span><span class="nx">contents</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="s2">&quot; bytes&quot;</span><span class="p">;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">fileName</span> <span class="o">+</span> <span class="s2">&quot; last modified &quot;</span> <span class="o">+</span> <span class="nx">file</span><span class="p">.</span><span class="nx">stat</span><span class="p">.</span><span class="nx">mtime</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">contentLength</span><span class="p">)</span>
<span class="p">});</span>
</pre></div>            <h4>
                <a class="header-anchor"
                    name="map-option-concurrency"
                    aria-hidden="true"
                    href="#map-option-concurrency"><i class="fa fa-link"></i></a>
                Map Option: concurrency
            </h4>

<p>You may optionally specify a concurrency limit:</p>
<div class="highlight"><pre><span class="p">...</span><span class="nx">map</span><span class="p">(...,</span> <span class="p">{</span><span class="nx">concurrency</span><span class="o">:</span> <span class="mi">3</span><span class="p">});</span>
</pre></div>
<p>The concurrency limit applies to Promises returned by the mapper function and it basically limits the number of Promises created. For example, if <code>concurrency</code> is <code>3</code> and the mapper callback has been called enough so that there are three returned Promises currently pending, no further callbacks are called until one of the pending Promises resolves. So the mapper function will be called three times and it will be called again only after at least one of the Promises resolves.</p>

<p>Playing with the first example with and without limits, and seeing how it affects the duration when reading 20 files:</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">join</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">join</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;fs&quot;</span><span class="p">));</span>
<span class="kd">var</span> <span class="nx">concurrency</span> <span class="o">=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">||</span> <span class="s2">&quot;Infinity&quot;</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">time</span><span class="p">(</span><span class="s2">&quot;reading files&quot;</span><span class="p">);</span>
<span class="nx">fs</span><span class="p">.</span><span class="nx">readdirAsync</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">fileName</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">stat</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">statAsync</span><span class="p">(</span><span class="nx">fileName</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">contents</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileAsync</span><span class="p">(</span><span class="nx">fileName</span><span class="p">).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span> <span class="nx">ignore</span><span class="p">()</span> <span class="p">{});</span>
    <span class="k">return</span> <span class="nx">join</span><span class="p">(</span><span class="nx">stat</span><span class="p">,</span> <span class="nx">contents</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stat</span><span class="p">,</span> <span class="nx">contents</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="nx">stat</span><span class="o">:</span> <span class="nx">stat</span><span class="p">,</span>
            <span class="nx">fileName</span><span class="o">:</span> <span class="nx">fileName</span><span class="p">,</span>
            <span class="nx">contents</span><span class="o">:</span> <span class="nx">contents</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="c1">// The return value of .map is a promise that is fulfilled with an array of the mapped values</span>
<span class="c1">// That means we only get here after all the files have been statted and their contents read</span>
<span class="c1">// into memory. If you need to do more operations per file, they should be chained in the map</span>
<span class="c1">// callback for concurrency.</span>
<span class="p">},</span> <span class="p">{</span><span class="nx">concurrency</span><span class="o">:</span> <span class="nx">concurrency</span><span class="p">}).</span><span class="nx">call</span><span class="p">(</span><span class="s2">&quot;sort&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">fileName</span><span class="p">.</span><span class="nx">localeCompare</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">fileName</span><span class="p">);</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">timeEnd</span><span class="p">(</span><span class="s2">&quot;reading files&quot;</span><span class="p">);</span>
<span class="p">});</span>
</pre></div><div class="highlight"><pre><span class="nv">$ </span>sync <span class="o">&amp;&amp;</span> <span class="nb">echo </span><span class="m">3</span> &gt; /proc/sys/vm/drop_caches
<span class="nv">$ </span>node test.js 1
reading files 35ms
<span class="nv">$ </span>sync <span class="o">&amp;&amp;</span> <span class="nb">echo </span><span class="m">3</span> &gt; /proc/sys/vm/drop_caches
<span class="nv">$ </span>node test.js Infinity
reading files: 9ms
</pre></div>
<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name=".reduce"
                    aria-hidden="true"
                    href="#.reduce"><i class="fa fa-link"></i></a>
                .reduce
            </h2>
<div class="highlight"><pre><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">any</span> <span class="nx">previousValue</span><span class="p">,</span> <span class="nx">any</span> <span class="nx">currentValue</span><span class="p">,</span> <span class="kr">int</span> <span class="nx">index</span><span class="p">,</span> <span class="kr">int</span> <span class="nx">length</span><span class="p">)</span> <span class="nx">reducer</span><span class="p">,</span>
    <span class="p">[</span><span class="nx">any</span> <span class="nx">initialValue</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div>
<p>Same as                 <a href="/bluebird/web/docs/api-reference.html#promise.reduce"><code>Promise.reduce(this, reducer, initialValue)</code></a>
.</p>
            <h2>
                <a class="header-anchor"
                    name="promise.reduce"
                    aria-hidden="true"
                    href="#promise.reduce"><i class="fa fa-link"></i></a>
                Promise.reduce
            </h2>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span>
    <span class="nx">Iterable</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;|</span><span class="nx">Promise</span><span class="o">&lt;</span><span class="nx">Iterable</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;&gt;</span> <span class="nx">input</span><span class="p">,</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">any</span> <span class="nx">accumulator</span><span class="p">,</span> <span class="nx">any</span> <span class="nx">item</span><span class="p">,</span> <span class="kr">int</span> <span class="nx">index</span><span class="p">,</span> <span class="kr">int</span> <span class="nx">length</span><span class="p">)</span> <span class="nx">reducer</span><span class="p">,</span>
    <span class="p">[</span><span class="nx">any</span> <span class="nx">initialValue</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div>
<p>Given an                 <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Iteration_protocols" title=""><code>Iterable</code></a>
(arrays are <code>Iterable</code>), or a promise of an <code>Iterable</code>, which produces promises (or a mix of promises and values), iterate over all the values in the <code>Iterable</code> into an array and                 <a href="http://en.wikipedia.org/wiki/Fold_(higher-order_function)" title="">reduce the array to a value</a>
 using the given <code>reducer</code> function.</p>

<p>If the reducer function returns a promise, then the result of the promise is awaited, before continuing with next iteration. If any promise in the array is rejected or a promise returned by the reducer function is rejected, the result is rejected as well.</p>

<p>Read given files sequentially while summing their contents as an integer. Each file contains just the text <code>10</code>.</p>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">reduce</span><span class="p">([</span><span class="s2">&quot;file1.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;file2.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;file3.txt&quot;</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">total</span><span class="p">,</span> <span class="nx">fileName</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileAsync</span><span class="p">(</span><span class="nx">fileName</span><span class="p">,</span> <span class="s2">&quot;utf8&quot;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">contents</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">total</span> <span class="o">+</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">contents</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">},</span> <span class="mi">0</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">total</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//Total is 30</span>
<span class="p">});</span>
</pre></div>
<p><em>If <code>intialValue</code> is <code>undefined</code> (or a promise that resolves to <code>undefined</code>) and the iterable contains only 1 item, the callback will not be called and <code>undefined</code> is returned. If the iterable is empty, the callback will not be called and <code>initialValue</code> is returned (which may be <code>undefined</code>).</em></p>

<p><code>Promise.reduce</code> will start calling the reducer as soon as possible, this is why you might want to use it over <code>Promise.all</code> (which awaits for the entire array before you can call                 <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/reduce" title=""><code>Array#reduce</code></a>
 on it).</p>

<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name=".filter"
                    aria-hidden="true"
                    href="#.filter"><i class="fa fa-link"></i></a>
                .filter
            </h2>
<div class="highlight"><pre><span class="p">.</span><span class="nx">filter</span><span class="p">(</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">any</span> <span class="nx">item</span><span class="p">,</span> <span class="kr">int</span> <span class="nx">index</span><span class="p">,</span> <span class="kr">int</span> <span class="nx">length</span><span class="p">)</span> <span class="nx">filterer</span><span class="p">,</span>
    <span class="p">[</span><span class="nb">Object</span> <span class="p">{</span><span class="nx">concurrency</span><span class="o">:</span> <span class="kr">int</span><span class="o">=</span><span class="kc">Infinity</span><span class="p">}</span> <span class="nx">options</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div>
<p>Same as                 <a href="/bluebird/web/docs/api-reference.html#promise.filter"><code>Promise.filter(this, filterer, options)</code></a>
.</p>
            <h2>
                <a class="header-anchor"
                    name="promise.filter"
                    aria-hidden="true"
                    href="#promise.filter"><i class="fa fa-link"></i></a>
                Promise.filter
            </h2>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span>
    <span class="nx">Iterable</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;|</span><span class="nx">Promise</span><span class="o">&lt;</span><span class="nx">Iterable</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;&gt;</span> <span class="nx">input</span><span class="p">,</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">any</span> <span class="nx">item</span><span class="p">,</span> <span class="kr">int</span> <span class="nx">index</span><span class="p">,</span> <span class="kr">int</span> <span class="nx">length</span><span class="p">)</span> <span class="nx">filterer</span><span class="p">,</span>
    <span class="p">[</span><span class="nb">Object</span> <span class="p">{</span><span class="nx">concurrency</span><span class="o">:</span> <span class="kr">int</span><span class="o">=</span><span class="kc">Infinity</span><span class="p">}</span> <span class="nx">options</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div>
<p>Given an                 <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Iteration_protocols" title=""><code>Iterable</code></a>
(arrays are <code>Iterable</code>), or a promise of an <code>Iterable</code>, which produces promises (or a mix of promises and values), iterate over all the values in the <code>Iterable</code> into an array and                 <a href="http://en.wikipedia.org/wiki/Filter_(higher-order_function)" title="">filter the array to another</a>
 using the given <code>filterer</code> function.</p>

<p>It is essentially an efficient shortcut for doing a                 <a href="/bluebird/web/docs/api-reference.html#.map"><code>.map</code></a>
 and then                 <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/filter" title=""><code>Array#filter</code></a>
:</p>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">valuesToBeFiltered</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span><span class="nx">filterer</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">length</span><span class="p">),</span> <span class="nx">value</span><span class="p">]);</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">values</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">stuff</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">stuff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="kc">true</span>
    <span class="p">}).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">stuff</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">stuff</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="p">});</span>
<span class="p">});</span>
</pre></div>
<p>Example for filtering files that are accessible directories in the current directory:</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">E</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;core-error-predicates&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;fs&quot;</span><span class="p">));</span>

<span class="nx">fs</span><span class="p">.</span><span class="nx">readdirAsync</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">cwd</span><span class="p">()).</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">fileName</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">statAsync</span><span class="p">(</span><span class="nx">fileName</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">stat</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">stat</span><span class="p">.</span><span class="nx">isDirectory</span><span class="p">();</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">E</span><span class="p">.</span><span class="nx">FileAccessError</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">});</span>
<span class="p">}).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">directoryName</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">directoryName</span><span class="p">,</span> <span class="s2">&quot; is an accessible directory&quot;</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>            <h4>
                <a class="header-anchor"
                    name="filter-option-concurrency"
                    aria-hidden="true"
                    href="#filter-option-concurrency"><i class="fa fa-link"></i></a>
                Filter Option: concurrency
            </h4>

<p>See                 <a href="#map-option-concurrency" title="">Map Option: concurrency</a>
</p>

<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name=".each"
                    aria-hidden="true"
                    href="#.each"><i class="fa fa-link"></i></a>
                .each
            </h2>
<div class="highlight"><pre><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">any</span> <span class="nx">item</span><span class="p">,</span> <span class="kr">int</span> <span class="nx">index</span><span class="p">,</span> <span class="kr">int</span> <span class="nx">length</span><span class="p">)</span> <span class="nx">iterator</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div><div class="highlight"><pre><span class="p">.</span><span class="nx">mapSeries</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">any</span> <span class="nx">item</span><span class="p">,</span> <span class="kr">int</span> <span class="nx">index</span><span class="p">,</span> <span class="kr">int</span> <span class="nx">length</span><span class="p">)</span> <span class="nx">mapper</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div>
<p>Same as                 <a href="/bluebird/web/docs/api-reference.html#promise.each"><code>Promise.each(this, iterator)</code></a>
.</p>
            <h2>
                <a class="header-anchor"
                    name="promise.each"
                    aria-hidden="true"
                    href="#promise.each"><i class="fa fa-link"></i></a>
                Promise.each
            </h2>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span>
    <span class="nx">Iterable</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;|</span><span class="nx">Promise</span><span class="o">&lt;</span><span class="nx">Iterable</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;&gt;</span> <span class="nx">input</span><span class="p">,</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">any</span> <span class="nx">item</span><span class="p">,</span> <span class="kr">int</span> <span class="nx">index</span><span class="p">,</span> <span class="kr">int</span> <span class="nx">length</span><span class="p">)</span> <span class="nx">iterator</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div><div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">mapSeries</span><span class="p">(</span>
    <span class="nx">Iterable</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;|</span><span class="nx">Promise</span><span class="o">&lt;</span><span class="nx">Iterable</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;&gt;</span> <span class="nx">input</span><span class="p">,</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">any</span> <span class="nx">item</span><span class="p">,</span> <span class="kr">int</span> <span class="nx">index</span><span class="p">,</span> <span class="kr">int</span> <span class="nx">length</span><span class="p">)</span> <span class="nx">mapper</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div>
<p>Given an                 <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Iteration_protocols" title=""><code>Iterable</code></a>
(arrays are <code>Iterable</code>), or a promise of an <code>Iterable</code>, which produces promises (or a mix of promises and values), iterate over all the values in the <code>Iterable</code> into an array and iterate over the array serially, in-order.</p>

<p>Returns a promise for an array that contains the values returned by the <code>iterator</code> function in their respective positions. The iterator won&#39;t be called for an item until its previous item, and the promise returned by the iterator for that item are fulfilled. This results in a <code>mapSeries</code> kind of utility but it can also be used simply as a side effect iterator similar to                 <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/forEach" title=""><code>Array#forEach</code></a>
.</p>

<p>If any promise in the input array is rejected or any promise returned by the iterator function is rejected, the result will be rejected as well.</p>

<p>Example where                 <a href="/bluebird/web/docs/api-reference.html#.each"><code>.each</code></a>
(the instance method) is used for iterating with side effects:</p>
<div class="highlight"><pre><span class="c1">// Source: http://jakearchibald.com/2014/es7-async-functions/</span>
<span class="kd">function</span> <span class="nx">loadStory</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">getJSON</span><span class="p">(</span><span class="s1">&#39;story.json&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">story</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">addHtmlToPage</span><span class="p">(</span><span class="nx">story</span><span class="p">.</span><span class="nx">heading</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">story</span><span class="p">.</span><span class="nx">chapterURLs</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">getJSON</span><span class="p">);</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">chapter</span><span class="p">)</span> <span class="p">{</span> <span class="nx">addHtmlToPage</span><span class="p">(</span><span class="nx">chapter</span><span class="p">.</span><span class="nx">html</span><span class="p">);</span> <span class="p">})</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">addTextToPage</span><span class="p">(</span><span class="s2">&quot;All done&quot;</span><span class="p">);</span> <span class="p">})</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="nx">addTextToPage</span><span class="p">(</span><span class="s2">&quot;Argh, broken: &quot;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span> <span class="p">})</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;.spinner&#39;</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">;</span> <span class="p">});</span>
<span class="p">}</span>
</pre></div>
<p>The alias <code>mapSeries</code> is provided for an opportunity to be more explicit when using <code>.each</code> as a linear mapping operation instead of a side effect iterator.</p>

<p><hr></p>
</div>

            <h2>
                <a class="header-anchor"
                    name="resource-management"
                    aria-hidden="true"
                    href="#resource-management"><i class="fa fa-link"></i></a>
                Resource management
            </h2>

<p>Managing resources properly without leaks can be challenging. Simply using <code>.finally</code> is not enough as the following example demonstrates:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">doStuff</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
        <span class="nx">connectionPool</span><span class="p">.</span><span class="nx">getConnectionAsync</span><span class="p">(),</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileAsync</span><span class="p">(</span><span class="s2">&quot;file.sql&quot;</span><span class="p">,</span> <span class="s2">&quot;utf8&quot;</span><span class="p">)</span>
    <span class="p">]).</span><span class="nx">spread</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">connection</span><span class="p">,</span> <span class="nx">fileContents</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="nx">fileContents</span><span class="p">).</span><span class="k">finally</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">connection</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
        <span class="p">});</span>
    <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;query successful and connection closed&quot;</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div>
<p>It is very subtle but over time this code will exhaust the entire connection pool and the server needs to be restarted. This is because
reading the file may fail and then of course <code>.spread</code> is not called at all and thus the connection is not closed.</p>

<p>One could solve this by either reading the file first or connecting first, and only proceeding if the first step succeeds. However,
this would lose a lot of the benefits of using asynchronity and we might almost as well go back to using simple synchronous code.</p>

<p>We can do better, retaining concurrency and not leaking resources, by using undefined:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">using</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">using</span><span class="p">;</span>

<span class="nx">using</span><span class="p">(</span><span class="nx">getConnection</span><span class="p">(),</span>
      <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileAsync</span><span class="p">(</span><span class="s2">&quot;file.sql&quot;</span><span class="p">,</span> <span class="s2">&quot;utf8&quot;</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">connection</span><span class="p">,</span> <span class="nx">fileContents</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="nx">fileContents</span><span class="p">);</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;query successful and connection closed&quot;</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div><div class="api-code-section">            <h2>
                <a class="header-anchor"
                    name="promise.using"
                    aria-hidden="true"
                    href="#promise.using"><i class="fa fa-link"></i></a>
                Promise.using
            </h2>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">using</span><span class="p">(</span>
    <span class="nx">Promise</span><span class="o">|</span><span class="nx">Disposer</span><span class="o">|</span><span class="nx">any</span> <span class="nx">resource</span><span class="p">,</span>
    <span class="nx">Promise</span><span class="o">|</span><span class="nx">Disposer</span><span class="o">|</span><span class="nx">any</span> <span class="nx">resource</span><span class="p">...,</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">any</span> <span class="nx">resources</span><span class="p">...)</span> <span class="nx">handler</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div>
<p>In conjunction with                 <a href="/bluebird/web/docs/api-reference.html#.disposer"><code><code>.disposer</code></code></a>
, <code>using</code> will make sure that no matter what, the specified disposer will be called when the promise returned by the callback passed to <code>using</code> has settled. The disposer is necessary because there is no standard interface in node for disposing resources.</p>

<p>Here is a simple example ` [has been defined] to return a proper undefined))</p>
<div class="highlight"><pre><span class="nx">using</span><span class="p">(</span><span class="nx">getConnection</span><span class="p">(),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">connection</span><span class="p">)</span> <span class="p">{</span>
   <span class="c1">// Don&#39;t leak the `connection` variable anywhere from here</span>
   <span class="c1">// it is only guaranteed to be open while the promise returned from</span>
   <span class="c1">// this callback is still pending</span>
   <span class="k">return</span> <span class="nx">connection</span><span class="p">.</span><span class="nx">queryAsync</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM TABLE&quot;</span><span class="p">);</span>
   <span class="c1">// Code that is chained from the promise created in the line above</span>
   <span class="c1">// still has access to `connection`</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">rows</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// The connection has been closed by now</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">rows</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
<p>Using multiple resources:</p>
<div class="highlight"><pre><span class="nx">using</span><span class="p">(</span><span class="nx">getConnection</span><span class="p">(),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">conn1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">using</span><span class="p">(</span><span class="nx">getConnection</span><span class="p">(),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">conn2</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// use conn1 and conn 2 here</span>
    <span class="p">});</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Both connections closed by now</span>
<span class="p">})</span>
</pre></div>
<p>The above can also be written as (with a caveat, see below)</p>
<div class="highlight"><pre><span class="nx">using</span><span class="p">(</span><span class="nx">getConnection</span><span class="p">(),</span> <span class="nx">getConnection</span><span class="p">(),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">conn1</span><span class="p">,</span> <span class="nx">conn2</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// use conn1 and conn2</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Both connections closed by now</span>
<span class="p">})</span>
</pre></div>
<p>However, if the second <code>getConnection</code> throws <strong>synchronously</strong>, the first connection is leaked. This will not happen
when using APIs through bluebird promisified methods though. You can wrap functions that could throw in                 <a href="/bluebird/web/docs/api-reference.html#promise.method"><code><code>Promise.method</code></code></a>
 which will turn synchronous rejections into rejected promises.</p>

<p>Note that you can mix promises and disposers, so that you can acquire all the things you need in parallel instead of sequentially</p>
<div class="highlight"><pre><span class="c1">// The files don&#39;t need resource management but you should</span>
<span class="c1">// still start the process of reading them even before you have the connection</span>
<span class="c1">// instead of waiting for the connection</span>

<span class="c1">// The connection is always closed, no matter what fails at what point</span>
<span class="nx">using</span><span class="p">(</span><span class="nx">readFile</span><span class="p">(</span><span class="s2">&quot;1.txt&quot;</span><span class="p">),</span> <span class="nx">readFile</span><span class="p">(</span><span class="s2">&quot;2.txt&quot;</span><span class="p">),</span> <span class="nx">getConnection</span><span class="p">(),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">txt1</span><span class="p">,</span> <span class="nx">txt2</span><span class="p">,</span> <span class="nx">conn</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// use conn and have access to txt1 and txt2</span>
<span class="p">});</span>
</pre></div>
<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name=".disposer"
                    aria-hidden="true"
                    href="#.disposer"><i class="fa fa-link"></i></a>
                .disposer
            </h2>
<div class="highlight"><pre><span class="p">.</span><span class="nx">disposer</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">any</span> <span class="nx">resource</span><span class="p">,</span> <span class="nx">Promise</span> <span class="nx">usingOutcomePromise</span><span class="p">)</span> <span class="nx">disposer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Disposer</span>
</pre></div>
<p>A meta method used to specify the disposer method that cleans up a resource when using undefined.</p>

<p>Example:</p>
<div class="highlight"><pre><span class="c1">// This function doesn&#39;t return a promise but a Disposer</span>
<span class="c1">// so it&#39;s very hard to use it wrong (not passing it to `using`)</span>
<span class="kd">function</span> <span class="nx">getConnection</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">pool</span><span class="p">.</span><span class="nx">getConnectionAsync</span><span class="p">().</span><span class="nx">disposer</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">connection</span><span class="p">,</span> <span class="nx">promise</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">connection</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></div>
<p>Real example:</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">pg</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;pg&quot;</span><span class="p">);</span>
<span class="c1">// Uncomment if pg has not been properly promisified yet</span>
<span class="c1">//var Promise = require(&quot;bluebird&quot;);</span>
<span class="c1">//Promise.promisifyAll(pg, {</span>
<span class="c1">//    filter: function(methodName) {</span>
<span class="c1">//        return methodName === &quot;connect&quot;</span>
<span class="c1">//    },</span>
<span class="c1">//    multiArgs: true</span>
<span class="c1">//});</span>
<span class="c1">// Promisify rest of pg normally</span>
<span class="c1">//Promise.promisifyAll(pg);</span>

<span class="kd">function</span> <span class="nx">getSqlConnection</span><span class="p">(</span><span class="nx">connectionString</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">close</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">pg</span><span class="p">.</span><span class="nx">connectAsync</span><span class="p">(</span><span class="nx">connectionString</span><span class="p">).</span><span class="nx">spread</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">close</span> <span class="o">=</span> <span class="nx">done</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">client</span><span class="p">;</span>
    <span class="p">}).</span><span class="nx">disposer</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">close</span><span class="p">)</span> <span class="nx">close</span><span class="p">();</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">getSqlConnection</span><span class="p">;</span>
</pre></div>
<p>Real example 2:</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">mysql</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;mysql&quot;</span><span class="p">);</span>
<span class="c1">// Uncomment if pg has not been properly promisified yet</span>
<span class="c1">// var Promise = require(&quot;bluebird&quot;);</span>
<span class="c1">// Promise.promisifyAll(mysql);</span>
<span class="c1">// Promise.promisifyAll(require(&quot;mysql/lib/Connection&quot;).prototype);</span>
<span class="c1">// Promise.promisifyAll(require(&quot;mysql/lib/Pool&quot;).prototype);</span>
<span class="kd">var</span> <span class="nx">pool</span>  <span class="o">=</span> <span class="nx">mysql</span><span class="p">.</span><span class="nx">createPool</span><span class="p">({</span>
    <span class="nx">connectionLimit</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="nx">host</span><span class="o">:</span> <span class="s1">&#39;example.org&#39;</span><span class="p">,</span>
    <span class="nx">user</span><span class="o">:</span> <span class="s1">&#39;bob&#39;</span><span class="p">,</span>
    <span class="nx">password</span><span class="o">:</span> <span class="s1">&#39;secret&#39;</span>
<span class="p">});</span>

<span class="kd">function</span> <span class="nx">getSqlConnection</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">pool</span><span class="p">.</span><span class="nx">getConnectionAsync</span><span class="p">().</span><span class="nx">disposer</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">connection</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">connection</span><span class="p">.</span><span class="nx">release</span><span class="p">();</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">getSqlConnection</span><span class="p">;</span>
</pre></div>
<p>The second argument passed to a disposer is the result promise of the using block, which you can inspect synchronously.</p>

<p>Example:</p>
<div class="highlight"><pre><span class="kd">function</span> <span class="nx">getTransaction</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">db</span><span class="p">.</span><span class="nx">getTransactionAsync</span><span class="p">().</span><span class="nx">disposer</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">tx</span><span class="p">,</span> <span class="nx">promise</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">promise</span><span class="p">.</span><span class="nx">isFulfilled</span><span class="p">()</span> <span class="o">?</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">commitAsync</span><span class="p">()</span> <span class="o">:</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">rollbackAsync</span><span class="p">();</span>
    <span class="p">});</span>
<span class="p">}</span>


<span class="c1">// If the using block completes successfully, the transaction is automatically committed</span>
<span class="c1">// Any error or rejection will automatically roll it back</span>
<span class="nx">using</span><span class="p">(</span><span class="nx">getTransaction</span><span class="p">(),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">tx</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">queryAsync</span><span class="p">(...).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">queryAsync</span><span class="p">(...)</span>
    <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">queryAsync</span><span class="p">(...)</span>
    <span class="p">});</span>
<span class="p">});</span>
</pre></div>
<p>Real example 3, transactions with postgres:</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">pg</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;pg&#39;</span><span class="p">);</span>
<span class="c1">// uncomment if necessary</span>
<span class="c1">//var Promise = require(&quot;bluebird&quot;);</span>
<span class="c1">//Promise.promisifyAll(pg, {</span>
<span class="c1">//    filter: function(methodName) {</span>
<span class="c1">//        return methodName === &quot;connect&quot;</span>
<span class="c1">//    },</span>
<span class="c1">//    multiArgs: true</span>
<span class="c1">//});</span>
<span class="c1">// Promisify rest of pg normally</span>
<span class="c1">//Promise.promisifyAll(pg);</span>

<span class="kd">function</span> <span class="nx">getTransaction</span><span class="p">(</span><span class="nx">connectionString</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">close</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">pg</span><span class="p">.</span><span class="nx">connectAsync</span><span class="p">(</span><span class="nx">connectionString</span><span class="p">).</span><span class="nx">spread</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">close</span> <span class="o">=</span> <span class="nx">done</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">client</span><span class="p">.</span><span class="nx">queryAsync</span><span class="p">(</span><span class="s1">&#39;BEGIN&#39;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">client</span><span class="p">;</span>
        <span class="p">});</span>
    <span class="p">}).</span><span class="nx">disposer</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">promise</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">promise</span><span class="p">.</span><span class="nx">isFulfilled</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">client</span><span class="p">.</span><span class="nx">queryAsync</span><span class="p">(</span><span class="s1">&#39;COMMIT&#39;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">closeClient</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">client</span><span class="p">.</span><span class="nx">queryAsync</span><span class="p">(</span><span class="s1">&#39;ROLLBACK&#39;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">closeClient</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="kd">function</span> <span class="nx">closeClient</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">close</span><span class="p">)</span> <span class="nx">close</span><span class="p">(</span><span class="nx">client</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">getTransaction</span> <span class="o">=</span> <span class="nx">getTransaction</span><span class="p">;</span>
</pre></div>            <h4>
                <a class="header-anchor"
                    name="note-about-disposers-in-node"
                    aria-hidden="true"
                    href="#note-about-disposers-in-node"><i class="fa fa-link"></i></a>
                Note about disposers in node
            </h4>

<p>If a disposer method throws, its highly likely that it failed to dispose of the resource. In that case, Bluebird has two options - it can either ignore the error and continue with program execution or throw an exception (crashing the process in node.js). Bluebird prefers to do the later because resources are typically scarce. For example, if database connections cannot be disposed of and Bluebird ignores that, the connection pool will be quickly depleted and the process will become unusable. Since Bluebird doesn&#39;t know how to handle that, the only sensible default is to crash the process.</p>

<p>If you anticipate thrown errors while disposing of the resource you should use a <code>try..catch</code> block (or <code>Promise.try</code>) and write the appropriate code to handle the errors.</p>

<p><hr></p>
</div>

            <h2>
                <a class="header-anchor"
                    name="promisification"
                    aria-hidden="true"
                    href="#promisification"><i class="fa fa-link"></i></a>
                Promisification
            </h2>

<p>Promisification means converting an existing promise-unaware API to a promise-returning API.</p>

<p>The usual way to use promises in node is to                 <a href="/bluebird/web/docs/api-reference.html#promise.promisifyall"><code>Promise.promisifyAll</code></a>
 some API and start exclusively calling promise returning versions of the APIs methods. E.g.</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;fs&quot;</span><span class="p">);</span>
<span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">fs</span><span class="p">);</span>
<span class="c1">// Now you can use fs as if it was designed to use bluebird promises from the beginning</span>

<span class="nx">fs</span><span class="p">.</span><span class="nx">readFileAsync</span><span class="p">(</span><span class="s2">&quot;file.js&quot;</span><span class="p">,</span> <span class="s2">&quot;utf8&quot;</span><span class="p">).</span><span class="nx">then</span><span class="p">(...)</span>
</code></pre></div>
<p>Note that the above is an exceptional case because <code>fs</code> is a singleton instance. Most libraries can be promisified by requiring the library&#39;s classes (constructor functions) and calling promisifyAll on the <code>.prototype</code>. This only needs to be done once in the entire application&#39;s lifetime and after that you may use the library&#39;s methods exactly as they are documented, except by appending the <code>&quot;Async&quot;</code>-suffix to method calls and using the promise interface instead of the callback interface.</p>

<p>As a notable exception in <code>fs</code>, <code>fs.existsAsync</code> doesn&#39;t work as expected, because Node&#39;s <code>fs.exists</code> doesn&#39;t call back with error as first argument.  More at                 <a href="https://github.com/petkaantonov/bluebird/issues/418"><code>#418</code></a>
.  One possible workaround is using <code>fs.statAsync</code>.</p>

<p>Some examples of the above practice applied to some popular libraries:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="c1">// The most popular redis module</span>
<span class="kd">var</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;redis&quot;</span><span class="p">));</span>
</code></pre></div><div class="highlight"><pre><code class="language-js" data-lang="js"><span class="c1">// The most popular mongodb module</span>
<span class="kd">var</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;mongodb&quot;</span><span class="p">));</span>
</code></pre></div><div class="highlight"><pre><code class="language-js" data-lang="js"><span class="c1">// The most popular mysql module</span>
<span class="kd">var</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="c1">// Note that the library&#39;s classes are not properties of the main export</span>
<span class="c1">// so we require and promisifyAll them manually</span>
<span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;mysql/lib/Connection&quot;</span><span class="p">).</span><span class="nx">prototype</span><span class="p">);</span>
<span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;mysql/lib/Pool&quot;</span><span class="p">).</span><span class="nx">prototype</span><span class="p">);</span>
</code></pre></div><div class="highlight"><pre><code class="language-js" data-lang="js"><span class="c1">// Mongoose</span>
<span class="kd">var</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;mongoose&quot;</span><span class="p">));</span>
</code></pre></div><div class="highlight"><pre><code class="language-js" data-lang="js"><span class="c1">// Request</span>
<span class="kd">var</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">));</span>
<span class="c1">// Use request.getAsync(...) not request(..), it will not return a promise</span>
</code></pre></div><div class="highlight"><pre><code class="language-js" data-lang="js"><span class="c1">// mkdir</span>
<span class="kd">var</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;mkdirp&quot;</span><span class="p">));</span>
<span class="c1">// Use mkdirp.mkdirpAsync not mkdirp(..), it will not return a promise</span>
</code></pre></div><div class="highlight"><pre><code class="language-js" data-lang="js"><span class="c1">// winston</span>
<span class="kd">var</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;winston&quot;</span><span class="p">));</span>
</code></pre></div><div class="highlight"><pre><code class="language-js" data-lang="js"><span class="c1">// rimraf</span>
<span class="kd">var</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="c1">// The module isn&#39;t promisified but the function returned is</span>
<span class="kd">var</span> <span class="nx">rimrafAsync</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">promisify</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;rimraf&quot;</span><span class="p">));</span>
</code></pre></div><div class="highlight"><pre><code class="language-js" data-lang="js"><span class="c1">// xml2js</span>
<span class="kd">var</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;xml2js&quot;</span><span class="p">));</span>
</code></pre></div><div class="highlight"><pre><code class="language-js" data-lang="js"><span class="c1">// jsdom</span>
<span class="kd">var</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;jsdom&quot;</span><span class="p">));</span>
</code></pre></div><div class="highlight"><pre><code class="language-js" data-lang="js"><span class="c1">// fs-extra</span>
<span class="kd">var</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;fs-extra&quot;</span><span class="p">));</span>
</code></pre></div><div class="highlight"><pre><code class="language-js" data-lang="js"><span class="c1">// prompt</span>
<span class="kd">var</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;prompt&quot;</span><span class="p">));</span>
</code></pre></div><div class="highlight"><pre><code class="language-js" data-lang="js"><span class="c1">// Nodemailer</span>
<span class="kd">var</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;nodemailer&quot;</span><span class="p">));</span>
</code></pre></div><div class="highlight"><pre><code class="language-js" data-lang="js"><span class="c1">// ncp</span>
<span class="kd">var</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;ncp&quot;</span><span class="p">));</span>
</code></pre></div><div class="highlight"><pre><code class="language-js" data-lang="js"><span class="c1">// pg</span>
<span class="kd">var</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;pg&quot;</span><span class="p">));</span>
</code></pre></div>
<p>In all of the above cases the library made its classes available in one way or another. If this is not the case, you can still promisify by creating a throwaway instance:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">ParanoidLib</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;...&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">throwAwayInstance</span> <span class="o">=</span> <span class="nx">ParanoidLib</span><span class="p">.</span><span class="nx">createInstance</span><span class="p">();</span>
<span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">getPrototypeOf</span><span class="p">(</span><span class="nx">throwAwayInstance</span><span class="p">));</span>
<span class="c1">// Like before, from this point on, all new instances + even the throwAwayInstance suddenly support promises</span>
</code></pre></div>
<p>See also                 <a href="/bluebird/web/docs/api-reference.html#promise.promisifyall"><code><code>Promise.promisifyAll</code></code></a>
.</p>
<div class="api-code-section">            <h2>
                <a class="header-anchor"
                    name="promise.promisify"
                    aria-hidden="true"
                    href="#promise.promisify"><i class="fa fa-link"></i></a>
                Promise.promisify
            </h2>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">promisify</span><span class="p">(</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">any</span> <span class="nx">arguments</span><span class="p">...,</span> <span class="kd">function</span> <span class="nx">callback</span><span class="p">)</span> <span class="nx">nodeFunction</span><span class="p">,</span>
    <span class="p">[</span><span class="nb">Object</span> <span class="p">{</span>
        <span class="nx">multiArgs</span><span class="o">:</span> <span class="kr">boolean</span><span class="o">=</span><span class="kc">false</span><span class="p">,</span>
        <span class="nx">context</span><span class="o">:</span> <span class="nx">any</span><span class="o">=</span><span class="k">this</span>
    <span class="p">}</span> <span class="nx">options</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kd">function</span>
</pre></div>
<p>Returns a function that will wrap the given <code>nodeFunction</code>. Instead of taking a callback, the returned function will return a promise whose fate is decided by the callback behavior of the given node function. The node function should conform to node.js convention of accepting a callback as last argument and calling that callback with error as the first argument and success value on the second argument.</p>

<p>If the <code>nodeFunction</code> calls its callback with multiple success values, the fulfillment value will be an array of them.</p>

<p>Setting <code>multiArgs</code> to <code>true</code> means the resulting promise will always fulfill with an array of the callback&#39;s success value(s). This is needed because promises only support a single success value while some callback API&#39;s have multiple success value. The default is to ignore all but the first success value of a callback function.</p>

<p>If you pass a <code>receiver</code>, the <code>nodeFunction</code> will be called as a method on the <code>receiver</code>.</p>

<p>Example of promisifying the asynchronous <code>readFile</code> of node.js <code>fs</code>-module:</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">readFile</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">promisify</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;fs&quot;</span><span class="p">).</span><span class="nx">readFile</span><span class="p">);</span>

<span class="nx">readFile</span><span class="p">(</span><span class="s2">&quot;myfile.js&quot;</span><span class="p">,</span> <span class="s2">&quot;utf8&quot;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">contents</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="nx">contents</span><span class="p">);</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;The result of evaluating myfile.js&quot;</span><span class="p">,</span> <span class="nx">result</span><span class="p">);</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">SyntaxError</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;File had syntax error&quot;</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
<span class="c1">//Catch any other error</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Error reading file&quot;</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
<p>Note that if the node function is a method of some object, you can pass the object as the second argument like so:</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">redisGet</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">promisify</span><span class="p">(</span><span class="nx">redisClient</span><span class="p">.</span><span class="nx">get</span><span class="p">,</span> <span class="p">{</span><span class="nx">context</span><span class="o">:</span> <span class="nx">redisClient</span><span class="p">});</span>
<span class="nx">redisGet</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">//...</span>
<span class="p">});</span>
</pre></div>
<p>But this will also work:</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">getAsync</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">promisify</span><span class="p">(</span><span class="nx">redisClient</span><span class="p">.</span><span class="nx">get</span><span class="p">);</span>
<span class="nx">getAsync</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">redisClient</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">//...</span>
<span class="p">});</span>
</pre></div>
<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name="promise.promisifyall"
                    aria-hidden="true"
                    href="#promise.promisifyall"><i class="fa fa-link"></i></a>
                Promise.promisifyAll
            </h2>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span>
    <span class="nb">Object</span> <span class="nx">target</span><span class="p">,</span>
    <span class="p">[</span><span class="nb">Object</span> <span class="p">{</span>
        <span class="nx">suffix</span><span class="o">:</span> <span class="nb">String</span><span class="o">=</span><span class="s2">&quot;Async&quot;</span><span class="p">,</span>
        <span class="nx">multiArgs</span><span class="o">:</span> <span class="kr">boolean</span><span class="o">=</span><span class="kc">false</span><span class="p">,</span>
        <span class="nx">filter</span><span class="o">:</span> <span class="kr">boolean</span> <span class="kd">function</span><span class="p">(</span><span class="nb">String</span> <span class="nx">name</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">func</span><span class="p">,</span> <span class="nb">Object</span> <span class="nx">target</span><span class="p">,</span> <span class="kr">boolean</span> <span class="nx">passesDefaultFilter</span><span class="p">),</span>
        <span class="nx">promisifier</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="kd">function</span> <span class="nx">originalFunction</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">defaultPromisifier</span><span class="p">)</span>
    <span class="p">}</span> <span class="nx">options</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Object</span>
</pre></div>
<p>Promisifies the entire object by going through the object&#39;s properties and creating an async equivalent of each function on the object and its prototype chain. The promisified method name will be the original method name suffixed with <code>suffix</code> (default is <code>&quot;Async&quot;</code>). Any class properties of the object (which is the case for the main export of many modules) are also promisified, both static and instance methods. Class property is a property with a function value that has a non-empty <code>.prototype</code> object. Returns the input object.</p>

<p>Note that the original methods on the object are not overwritten but new methods are created with the <code>Async</code>-suffix. For example, if you <code>promisifyAll</code> the node.js <code>fs</code> object use <code>fs.statAsync</code> to call the promisified <code>stat</code> method.</p>

<p>Example:</p>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;redis&quot;</span><span class="p">));</span>

<span class="c1">//Later on, all redis client instances have promise returning functions:</span>

<span class="nx">redisClient</span><span class="p">.</span><span class="nx">hexistsAsync</span><span class="p">(</span><span class="s2">&quot;myhash&quot;</span><span class="p">,</span> <span class="s2">&quot;field&quot;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>

<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>

<span class="p">});</span>
</pre></div>
<p>It also works on singletons or specific instances:</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;fs&quot;</span><span class="p">));</span>

<span class="nx">fs</span><span class="p">.</span><span class="nx">readFileAsync</span><span class="p">(</span><span class="s2">&quot;myfile.js&quot;</span><span class="p">,</span> <span class="s2">&quot;utf8&quot;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">contents</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">contents</span><span class="p">);</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
<p>See                 <a href="#promisification" title="">promisification</a>
 for more examples.</p>

<p>The entire prototype chain of the object is promisified on the object. Only enumerable are considered. If the object already has a promisified version of the method, it will be skipped. The target methods are assumed to conform to node.js callback convention of accepting a callback as last argument and calling that callback with error as the first argument and success value on the second argument. If the node method calls its callback with multiple success values, the fulfillment value will be an array of them.</p>

<p>If a method name already has an <code>&quot;Async&quot;</code>-suffix, it will be duplicated. E.g. <code>getAsync</code>&#39;s promisified name is <code>getAsyncAsync</code>.</p>
            <h4>
                <a class="header-anchor"
                    name="option-suffix"
                    aria-hidden="true"
                    href="#option-suffix"><i class="fa fa-link"></i></a>
                Option: suffix
            </h4>

<p>Optionally, you can define a custom suffix through the options object:</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;fs&quot;</span><span class="p">),</span> <span class="p">{</span><span class="nx">suffix</span><span class="o">:</span> <span class="s2">&quot;MySuffix&quot;</span><span class="p">});</span>
<span class="nx">fs</span><span class="p">.</span><span class="nx">readFileMySuffix</span><span class="p">(...).</span><span class="nx">then</span><span class="p">(...);</span>
</pre></div>
<p>All the above limitations apply to custom suffices:</p>

<ul>
<li>Choose the suffix carefully, it must not collide with anything</li>
<li>PascalCase the suffix</li>
<li>The suffix must be a valid JavaScript identifier using ASCII letters</li>
<li>Always use the same suffix everywhere in your application, you could create a wrapper to make this easier:</li>
</ul>
<div class="highlight"><pre><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">myPromisifyAll</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="p">{</span><span class="nx">suffix</span><span class="o">:</span> <span class="s2">&quot;MySuffix&quot;</span><span class="p">});</span>
<span class="p">};</span>
</pre></div>            <h4>
                <a class="header-anchor"
                    name="option-multiargs"
                    aria-hidden="true"
                    href="#option-multiargs"><i class="fa fa-link"></i></a>
                Option: multiArgs
            </h4>

<p>Setting <code>multiArgs</code> to <code>true</code> means the resulting promise will always fulfill with an array of the callback&#39;s success value(s). This is needed because promises only support a single success value while some callback API&#39;s have multiple success value. The default is to ignore all but the first success value of a callback function.</p>
            <h4>
                <a class="header-anchor"
                    name="option-filter"
                    aria-hidden="true"
                    href="#option-filter"><i class="fa fa-link"></i></a>
                Option: filter
            </h4>

<p>Optionally, you can define a custom filter through the options object:</p>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(...,</span> <span class="p">{</span>
    <span class="nx">filter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">func</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">passesDefaultFilter</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// name = the property name to be promisified without suffix</span>
        <span class="c1">// func = the function</span>
        <span class="c1">// target = the target object where the promisified func will be put with name + suffix</span>
        <span class="c1">// passesDefaultFilter = whether the default filter would be passed</span>
        <span class="c1">// return boolean (return value is coerced, so not returning anything is same as returning false)</span>

        <span class="k">return</span> <span class="nx">passesDefaultFilter</span> <span class="o">&amp;&amp;</span> <span class="p">...</span>
    <span class="p">}</span>
<span class="p">})</span>
</pre></div>
<p>The default filter function will ignore properties that start with a leading underscore, properties that are not valid JavaScript identifiers and constructor functions (function which have enumerable properties in their <code>.prototype</code>).</p>
            <h4>
                <a class="header-anchor"
                    name="option-promisifier"
                    aria-hidden="true"
                    href="#option-promisifier"><i class="fa fa-link"></i></a>
                Option: promisifier
            </h4>

<p>Optionally, you can define a custom promisifier, so you could promisifyAll e.g. the chrome APIs used in Chrome extensions.</p>

<p>The promisifier gets a reference to the original method and should return a function which returns a promise.</p>
<div class="highlight"><pre><span class="kd">function</span> <span class="nx">DOMPromisifier</span><span class="p">(</span><span class="nx">originalMethod</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// return a function</span>
    <span class="k">return</span> <span class="kd">function</span> <span class="nx">promisified</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="p">[].</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>
        <span class="c1">// Needed so that the original method can be called with the correct receiver</span>
        <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="c1">// which returns a promise</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">args</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">);</span>
            <span class="nx">originalMethod</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">};</span>
<span class="p">}</span>

<span class="c1">// Promisify e.g. chrome.browserAction</span>
<span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">chrome</span><span class="p">.</span><span class="nx">browserAction</span><span class="p">,</span> <span class="p">{</span><span class="nx">promisifier</span><span class="o">:</span> <span class="nx">DOMPromisifier</span><span class="p">});</span>

<span class="c1">// Later</span>
<span class="nx">chrome</span><span class="p">.</span><span class="nx">browserAction</span><span class="p">.</span><span class="nx">getTitleAsync</span><span class="p">({</span><span class="nx">tabId</span><span class="o">:</span> <span class="mi">1</span><span class="p">})</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>

    <span class="p">});</span>
</pre></div>
<p>Combining <code>filter</code> with <code>promisifier</code> for the restler module to promisify event emitter:</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">restler</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;restler&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">methodNamesToPromisify</span> <span class="o">=</span> <span class="s2">&quot;get post put del head patch json postJson putJson&quot;</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">EventEmitterPromisifier</span><span class="p">(</span><span class="nx">originalMethod</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// return a function</span>
    <span class="k">return</span> <span class="kd">function</span> <span class="nx">promisified</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="p">[].</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>
        <span class="c1">// Needed so that the original method can be called with the correct receiver</span>
        <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="c1">// which returns a promise</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// We call the originalMethod here because if it throws,</span>
            <span class="c1">// it will reject the returned promise with the thrown error</span>
            <span class="kd">var</span> <span class="nx">emitter</span> <span class="o">=</span> <span class="nx">originalMethod</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>

            <span class="nx">emitter</span>
                <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">resolve</span><span class="p">([</span><span class="nx">data</span><span class="p">,</span> <span class="nx">response</span><span class="p">]);</span>
                <span class="p">})</span>
                <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;fail&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
                    <span class="c1">// Erroneous response like 400</span>
                    <span class="nx">resolve</span><span class="p">([</span><span class="nx">data</span><span class="p">,</span> <span class="nx">response</span><span class="p">]);</span>
                <span class="p">})</span>
                <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
                <span class="p">})</span>
                <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;abort&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                    <span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">CancellationError</span><span class="p">());</span>
                <span class="p">})</span>
                <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;timeout&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                    <span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">TimeoutError</span><span class="p">());</span>
                <span class="p">});</span>
        <span class="p">});</span>
    <span class="p">};</span>
<span class="p">};</span>

<span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">restler</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">filter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">methodNamesToPromisify</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">promisifier</span><span class="o">:</span> <span class="nx">EventEmitterPromisifier</span>
<span class="p">});</span>

<span class="c1">// ...</span>

<span class="c1">// Later in some other file</span>

<span class="kd">var</span> <span class="nx">restler</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;restler&quot;</span><span class="p">);</span>
<span class="nx">restler</span><span class="p">.</span><span class="nx">getAsync</span><span class="p">(</span><span class="s2">&quot;http://...&quot;</span><span class="p">,</span> <span class="p">...,).</span><span class="nx">spread</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>

<span class="p">})</span>
</pre></div>
<p>Using <code>defaultPromisifier</code> parameter to add enhancements on top of normal node
promisification:</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;fs&quot;</span><span class="p">),</span> <span class="p">{</span>
    <span class="nx">promisifier</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">originalFunction</span><span class="p">,</span> <span class="nx">defaultPromisifer</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">promisified</span> <span class="o">=</span> <span class="nx">defaultPromisifier</span><span class="p">(</span><span class="nx">originalFunction</span><span class="p">);</span>

        <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="c1">// Enhance normal promisification by supporting promises as</span>
            <span class="c1">// arguments</span>

            <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="p">[].</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>
            <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
            <span class="k">return</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">args</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">awaitedArgs</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">promisified</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">awaitedArgs</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">};</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// All promisified fs functions now await their arguments if they are promises</span>
<span class="kd">var</span> <span class="nx">version</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileAsync</span><span class="p">(</span><span class="s2">&quot;package.json&quot;</span><span class="p">,</span> <span class="s2">&quot;utf8&quot;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;version&quot;</span><span class="p">);</span>
<span class="nx">fs</span><span class="p">.</span><span class="nx">writeFileAsync</span><span class="p">(</span><span class="s2">&quot;the-version.txt&quot;</span><span class="p">,</span> <span class="nx">version</span><span class="p">,</span> <span class="s2">&quot;utf8&quot;</span><span class="p">);</span>
</pre></div>
<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name="promise.fromcallback"
                    aria-hidden="true"
                    href="#promise.fromcallback"><i class="fa fa-link"></i></a>
                Promise.fromCallback
            </h2>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">fromCallback</span><span class="p">(</span>
    <span class="kd">function</span><span class="p">(</span><span class="kd">function</span> <span class="nx">callback</span><span class="p">)</span> <span class="nx">resolver</span><span class="p">,</span>
    <span class="p">[</span><span class="nb">Object</span> <span class="p">{</span><span class="nx">multiArgs</span><span class="o">:</span> <span class="kr">boolean</span><span class="o">=</span><span class="kc">false</span><span class="p">}</span> <span class="nx">options</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div><div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">fromNode</span><span class="p">(</span>
    <span class="kd">function</span><span class="p">(</span><span class="kd">function</span> <span class="nx">callback</span><span class="p">)</span> <span class="nx">resolver</span><span class="p">,</span>
    <span class="p">[</span><span class="nb">Object</span> <span class="p">{</span><span class="nx">multiArgs</span><span class="o">:</span> <span class="kr">boolean</span><span class="o">=</span><span class="kc">false</span><span class="p">}</span> <span class="nx">options</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div>
<p>Returns a promise that is resolved by a node style callback function. This is the most fitting way to do on the fly promisification when libraries don&#39;t expose classes for automatic promisification by undefined.</p>

<p>The resolver function is passed a callback that expects to be called back according to error-first node conventions.</p>

<p>Setting <code>multiArgs</code> to <code>true</code> means the resulting promise will always fulfill with an array of the callback&#39;s success value(s). This is needed because promises only support a single success value while
some callback API&#39;s have multiple success value. The default is to ignore all but the first success value of a callback function.</p>

<p>Using manual resolver:</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="c1">// &quot;email-templates&quot; doesn&#39;t expose prototypes for promisification</span>
<span class="kd">var</span> <span class="nx">emailTemplates</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">promisify</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;email-templates&#39;</span><span class="p">));</span>
<span class="kd">var</span> <span class="nx">templatesDir</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">&#39;templates&#39;</span><span class="p">);</span>


<span class="nx">emailTemplates</span><span class="p">(</span><span class="nx">templatesDir</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">template</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">fromCallback</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">template</span><span class="p">(</span><span class="s2">&quot;newsletter&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
    <span class="p">},</span> <span class="kc">true</span><span class="p">).</span><span class="nx">spread</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">html</span><span class="p">,</span> <span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">html</span><span class="p">,</span> <span class="nx">text</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">});</span>
</pre></div>
<p>The same can also be written more concisely with <code>Function.prototype.bind</code>:</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="c1">// &quot;email-templates&quot; doesn&#39;t expose prototypes for promisification</span>
<span class="kd">var</span> <span class="nx">emailTemplates</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">promisify</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;email-templates&#39;</span><span class="p">));</span>
<span class="kd">var</span> <span class="nx">templatesDir</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">&#39;templates&#39;</span><span class="p">);</span>


<span class="nx">emailTemplates</span><span class="p">(</span><span class="nx">templatesDir</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">template</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">fromCallback</span><span class="p">(</span><span class="nx">template</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;newsletter&quot;</span><span class="p">),</span> <span class="kc">true</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">spread</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">html</span><span class="p">,</span> <span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">html</span><span class="p">,</span> <span class="nx">text</span><span class="p">);</span>
        <span class="p">});</span>
<span class="p">});</span>
</pre></div>
<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name=".ascallback"
                    aria-hidden="true"
                    href="#.ascallback"><i class="fa fa-link"></i></a>
                .asCallback
            </h2>
<div class="highlight"><pre><span class="p">.</span><span class="nx">asCallback</span><span class="p">(</span>
    <span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">any</span> <span class="nx">error</span><span class="p">,</span> <span class="nx">any</span> <span class="nx">value</span><span class="p">)</span> <span class="nx">callback</span><span class="p">],</span>
    <span class="p">[</span><span class="nb">Object</span> <span class="p">{</span><span class="nx">spread</span><span class="o">:</span> <span class="kr">boolean</span><span class="o">=</span><span class="kc">false</span><span class="p">}</span> <span class="nx">options</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="k">this</span>
</pre></div><div class="highlight"><pre><span class="p">.</span><span class="nx">nodeify</span><span class="p">(</span>
    <span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">any</span> <span class="nx">error</span><span class="p">,</span> <span class="nx">any</span> <span class="nx">value</span><span class="p">)</span> <span class="nx">callback</span><span class="p">],</span>
    <span class="p">[</span><span class="nb">Object</span> <span class="p">{</span><span class="nx">spread</span><span class="o">:</span> <span class="kr">boolean</span><span class="o">=</span><span class="kc">false</span><span class="p">}</span> <span class="nx">options</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="k">this</span>
</pre></div>
<p>Register a node-style callback on this promise. When this promise is either fulfilled or rejected, the node callback will be called back with the node.js convention where error reason is the first argument and success value is the second argument. The error argument will be <code>null</code> in case of success.</p>

<p>Returns back this promise instead of creating a new one. If the <code>callback</code> argument is not a function, this method does not do anything.</p>

<p>This can be used to create APIs that both accept node-style callbacks and return promises:</p>
<div class="highlight"><pre><span class="kd">function</span> <span class="nx">getDataFor</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">dataFromDataBase</span><span class="p">(</span><span class="nx">input</span><span class="p">).</span><span class="nx">asCallback</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>The above function can then make everyone happy.</p>

<p>Promises:</p>
<div class="highlight"><pre><span class="nx">getDataFor</span><span class="p">(</span><span class="s2">&quot;me&quot;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">dataForMe</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">dataForMe</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
<p>Normal callbacks:</p>
<div class="highlight"><pre><span class="nx">getDataFor</span><span class="p">(</span><span class="s2">&quot;me&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">dataForMe</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span> <span class="nx">err</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span> <span class="nx">err</span> <span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">dataForMe</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
<p>Promises can be rejected with falsy values (or no value at all, equal to rejecting with <code>undefined</code>), however <code>.asCallback</code> will call the callback with an <code>Error</code> object if the promise&#39;s rejection reason is a falsy value. You can retrieve the original falsy value from the error&#39;s <code>.cause</code> property.</p>

<p>Example:</p>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="kc">null</span><span class="p">).</span><span class="nx">asCallback</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// If is executed</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Logs &#39;null&#39;</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">cause</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
</pre></div>
<p>There is no effect on peformance if the user doesn&#39;t actually pass a node-style callback function.</p>
            <h4>
                <a class="header-anchor"
                    name="option-spread"
                    aria-hidden="true"
                    href="#option-spread"><i class="fa fa-link"></i></a>
                Option: spread
            </h4>

<p>Some nodebacks expect more than 1 success value but there is no mapping for this in the promise world. You may specify the option <code>spread</code> to call the nodeback with multiple values when the fulfillment value is an array:</p>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]).</span><span class="nx">asCallback</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// err == null</span>
    <span class="c1">// result is the array [1,2,3]</span>
<span class="p">});</span>

<span class="nx">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]).</span><span class="nx">asCallback</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// err == null</span>
    <span class="c1">// a == 1</span>
    <span class="c1">// b == 2</span>
    <span class="c1">// c == 3</span>
<span class="p">},</span> <span class="p">{</span><span class="nx">spread</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>

<span class="nx">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="mi">123</span><span class="p">).</span><span class="nx">asCallback</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// err == null</span>
    <span class="c1">// a == 123</span>
    <span class="c1">// b == undefined</span>
    <span class="c1">// c == undefined</span>
<span class="p">},</span> <span class="p">{</span><span class="nx">spread</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
</pre></div>
<p><hr></p>
</div>

            <h2>
                <a class="header-anchor"
                    name="timers"
                    aria-hidden="true"
                    href="#timers"><i class="fa fa-link"></i></a>
                Timers
            </h2>

<p>Methods to delay and time promises out.</p>
<div class="api-code-section"><p><hr></p>
            <h2>
                <a class="header-anchor"
                    name=".timeout"
                    aria-hidden="true"
                    href="#.timeout"><i class="fa fa-link"></i></a>
                .timeout
            </h2>
<div class="highlight"><pre><span class="p">.</span><span class="nx">timeout</span><span class="p">(</span>
    <span class="kr">int</span> <span class="nx">ms</span><span class="p">,</span>
    <span class="p">[</span><span class="nb">String</span> <span class="nx">message</span><span class="o">=</span><span class="s2">&quot;operation timed out&quot;</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div>
<p>Returns a promise that will be fulfilled with this promise&#39;s fulfillment value or rejection reason. However, if this promise is not fulfilled or rejected within <code>ms</code> milliseconds, the returned promise is rejected with a                 <a href="/bluebird/web/docs/api-reference.html#timeouterror"><code><code>TimeoutError</code></code></a>
 as the reason.</p>

<p>You may specify a custom error message with the <code>message</code> parameter.</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">));</span>
<span class="nx">fs</span><span class="p">.</span><span class="nx">readFileAsync</span><span class="p">(</span><span class="s2">&quot;huge-file.txt&quot;</span><span class="p">).</span><span class="nx">timeout</span><span class="p">(</span><span class="mi">100</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">fileContents</span><span class="p">)</span> <span class="p">{</span>

<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">Promise</span><span class="p">.</span><span class="nx">TimeoutError</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;could not read file within 100ms&quot;</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name=".delay"
                    aria-hidden="true"
                    href="#.delay"><i class="fa fa-link"></i></a>
                .delay
            </h2>
<div class="highlight"><pre><span class="p">.</span><span class="nx">delay</span><span class="p">(</span><span class="kr">int</span> <span class="nx">ms</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div>
<p>Same as calling                 <a href="/bluebird/web/docs/api-reference.html#promise.delay"><code>Promise.delay(this, ms)</code></a>
.</p>
            <h2>
                <a class="header-anchor"
                    name="promise.delay"
                    aria-hidden="true"
                    href="#promise.delay"><i class="fa fa-link"></i></a>
                Promise.delay
            </h2>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">delay</span><span class="p">(</span>
    <span class="p">[</span><span class="nx">any</span><span class="o">|</span><span class="nx">Promise</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span> <span class="nx">value</span><span class="o">=</span><span class="kc">undefined</span><span class="p">],</span>
    <span class="kr">int</span> <span class="nx">ms</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div>
<p>Returns a promise that will be resolved with <code>value</code> (or <code>undefined</code>) after given <code>ms</code> milliseconds. If <code>value</code> is a promise, the delay will start counting down when it is fulfilled and the returned promise will be fulfilled with the fulfillment value of the <code>value</code> promise.</p>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;500 ms passed&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="s2">&quot;Hello world&quot;</span><span class="p">;</span>
<span class="p">}).</span><span class="nx">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">helloWorldString</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">helloWorldString</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;another 500 ms passed&quot;</span><span class="p">)</span> <span class="p">;</span>
<span class="p">});</span>
</pre></div>
<p><hr></p>
</div>

            <h2>
                <a class="header-anchor"
                    name="cancellation"
                    aria-hidden="true"
                    href="#cancellation"><i class="fa fa-link"></i></a>
                Cancellation
            </h2>

<p>Cancellation has been redesigned for bluebird 3.x, any code that relies on 2.x cancellation semantics won&#39;t work in 3.x.</p>

<p>The cancellation feature is <strong>by default turned off</strong>, you can enable it using                 <a href="/bluebird/web/docs/api-reference.html#promise.config"><code>Promise.config</code></a>
.</p>

<p>The new cancellation has &quot;don&#39;t care&quot; semantics while the old cancellation had abort semantics. Cancelling a promise simply means that its handler callbacks will not be called.</p>

<p>The advantages of the new cancellation compared to the old cancellation are:</p>

<ul>
<li>                <a href="/bluebird/web/docs/api-reference.html#.cancel"><code>.cancel()</code></a>
 is synchronous.</li>
<li>no setup code required to make cancellation work</li>
<li>composes with other bluebird features, like                 <a href="/bluebird/web/docs/api-reference.html#promise.all"><code>Promise.all</code></a>
.</li>
<li>                <a href="#what-about-promises-that-have-multiple-consumers" title="">reasonable semantics for multiple consumer cancellation</a></li>
</ul>

<p>As an optimization, the cancellation signal propagates upwards the promise chain so that an ongoing operation e.g. network request can be aborted. However, <em>not</em> aborting the network request still doesn&#39;t make any operational difference as the callbacks are still not called either way.</p>

<p>You may register an optional cancellation hook at a root promise by using the <code>onCancel</code> argument that is passed to the executor function when cancellation is enabled:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">makeCancellableRequest</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">,</span> <span class="nx">onCancel</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;load&quot;</span><span class="p">,</span> <span class="nx">resolve</span><span class="p">);</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="nx">reject</span><span class="p">);</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
        <span class="c1">// Note the onCancel argument only exists if cancellation has been enabled!</span>
        <span class="nx">onCancel</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">xhr</span><span class="p">.</span><span class="nx">abort</span><span class="p">();</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div>
<p>Note that the <code>onCancel</code> hook is really an optional disconnected optimization, there is no real requirement to register any cancellation hooks for cancellation to work. As such, any errors that may occur while inside the <code>onCancel</code> callback are not caught and turned into rejections.</p>

<p>Example:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">searchPromise</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>  <span class="c1">// Dummy promise to avoid null check.</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&quot;#search-input&quot;</span><span class="p">).</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// The handlers of the previous request must not be called</span>
    <span class="nx">searchPromise</span><span class="p">.</span><span class="nx">cancel</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="s2">&quot;/search?term=&quot;</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">trim</span><span class="p">());</span>
    <span class="nx">showSpinner</span><span class="p">();</span>
    <span class="nx">searchPromise</span> <span class="o">=</span> <span class="nx">makeCancellableRequest</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">transformData</span><span class="p">(</span><span class="nx">results</span><span class="p">);</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">transformedData</span><span class="p">)</span> <span class="p">{</span>
            <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&quot;#search-results&quot;</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">transformedData</span><span class="p">;</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&quot;#search-results&quot;</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">renderErrorBox</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="k">finally</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="c1">// This check is necessary because `.finally` handlers are always called.</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">searchPromise</span><span class="p">.</span><span class="nx">isCancelled</span><span class="p">())</span> <span class="p">{</span>
                <span class="nx">hideSpinner</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">});</span>
<span class="p">});</span>
</code></pre></div>
<p>As shown in the example the handlers registered with <code>.finally</code> are called even if the promise is cancelled. Another such exception is                 <a href="/bluebird/web/docs/api-reference.html#.reflect"><code>.reflect()</code></a>
. No other types of handlers will be called in case of cancellation. This means that in <code>.then(onSuccess, onFailure)</code> neither <code>onSuccess</code> or <code>onFailure</code> handler is called. This is similar to how                 <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Generator/return" title=""><code>Generator#return</code></a>
 works - only active <code>finally</code> blocks are executed and then the generator exits.</p>
            <h3>
                <a class="header-anchor"
                    name="what-about-promises-that-have-multiple-consumers"
                    aria-hidden="true"
                    href="#what-about-promises-that-have-multiple-consumers"><i class="fa fa-link"></i></a>
                What about promises that have multiple consumers?
            </h3>

<p>It is often said that promises cannot be cancellable beacuse they can have multiple consumers.</p>

<p>For instance:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">makeCancellableRequest</span><span class="p">(...);</span>

<span class="kd">var</span> <span class="nx">firstConsumer</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">then</span><span class="p">(...);</span>
<span class="kd">var</span> <span class="nx">secondConsumer</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">then</span><span class="p">(...);</span>
</code></pre></div>
<p>Even though in practice most users of promises will never have any need to take advantage of the fact that you can attach multiple consumers to a promise, it is nevertheless possible. The problem: &quot;what should happen if                 <a href="/bluebird/web/docs/api-reference.html#.cancel"><code>.cancel()</code></a>
 is called on <code>firstConsumer</code>?&quot; Propagating the cancellation signal (and therefore making it abort the request) would be very bad as the second consumer might still be interested in the result despite the first consumer&#39;s disinterest.</p>

<p>What actually happens is that <code>result</code> keeps track of how many consumers it has, in this case 2, and only if all the consumers signal cancel will the request be aborted. However, as far as <code>firstConsumer</code> can tell, the promise was successfully cancelled and its handlers will not be called.</p>

<p>Note that it is an error to consume an already cancelled promise, doing such a thing will give you a promise that is rejected with <code>new CancellationError(&quot;late cancellation observer&quot;)</code> as the rejection reason.</p>

<p><hr></p>
<div class="api-code-section">            <h2>
                <a class="header-anchor"
                    name=".cancel"
                    aria-hidden="true"
                    href="#.cancel"><i class="fa fa-link"></i></a>
                .cancel
            </h2>
<div class="highlight"><pre><span class="p">.</span><span class="nx">cancel</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">undefined</span>
</pre></div>
<p>Cancel this promise. Will not do anything if this promise is already settled or if the                 <a href="/bluebird/web/docs/api-reference.html#cancellation"><code>Cancellation</code></a>
 feature has not been enabled. See                 <a href="/bluebird/web/docs/api-reference.html#cancellation"><code>Cancellation</code></a>
 for how to use cancellation.</p>

<p><hr></p>
</div>
            <h2>
                <a class="header-anchor"
                    name="generators"
                    aria-hidden="true"
                    href="#generators"><i class="fa fa-link"></i></a>
                Generators
            </h2>

<p>Using ECMAScript6 generators feature to implement C# 5.0 <code>async/await</code> like syntax.</p>
<div class="api-code-section">            <h2>
                <a class="header-anchor"
                    name="promise.coroutine"
                    aria-hidden="true"
                    href="#promise.coroutine"><i class="fa fa-link"></i></a>
                Promise.coroutine
            </h2>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">coroutine</span><span class="p">(</span><span class="nx">GeneratorFunction</span><span class="p">(...</span><span class="nx">arguments</span><span class="p">)</span> <span class="nx">generatorFunction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kd">function</span>
</pre></div>
<p>Returns a function that can use <code>yield</code> to yield promises. Control is returned back to the generator when the yielded promise settles. This can lead to less verbose code when doing lots of sequential async calls with minimal processing in between. Requires node.js 0.12+, io.js 1.0+ or Google Chrome 40+.</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">PingPong</span><span class="p">()</span> <span class="p">{</span>

<span class="p">}</span>

<span class="nx">PingPong</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">ping</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">coroutine</span><span class="p">(</span><span class="kd">function</span><span class="o">*</span> <span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Ping?&quot;</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span>
    <span class="k">yield</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">pong</span><span class="p">(</span><span class="nx">val</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="p">});</span>

<span class="nx">PingPong</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">pong</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">coroutine</span><span class="p">(</span><span class="kd">function</span><span class="o">*</span> <span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Pong!&quot;</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span>
    <span class="k">yield</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">ping</span><span class="p">(</span><span class="nx">val</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PingPong</span><span class="p">();</span>
<span class="nx">a</span><span class="p">.</span><span class="nx">ping</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</pre></div>
<p>Running the example:</p>
<div class="highlight"><pre><span class="nv">$ </span>node test.js
Ping? 0
Pong! 1
Ping? 2
Pong! 3
Ping? 4
Pong! 5
Ping? 6
Pong! 7
Ping? 8
...
</pre></div>
<p>When called, the coroutine function will start an instance of the generator and returns a promise for its final value.</p>

<p>Doing <code>Promise.coroutine</code> is almost like using the C# <code>async</code> keyword to mark the function, with <code>yield</code> working as the <code>await</code> keyword. Promises are somewhat like <code>Task</code>s.</p>

<p><strong>Tip</strong></p>

<p>You are able to yield non-promise values by adding your own yield handler using                  <a href="/bluebird/web/docs/api-reference.html#promise.coroutine.addyieldhandler"><code><code>Promise.coroutine.addYieldHandler</code></code></a>
</p>

<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name="promise.coroutine.addyieldhandler"
                    aria-hidden="true"
                    href="#promise.coroutine.addyieldhandler"><i class="fa fa-link"></i></a>
                Promise.coroutine.addYieldHandler
            </h2>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">coroutine</span><span class="p">.</span><span class="nx">addYieldHandler</span><span class="p">(</span><span class="kd">function</span> <span class="nx">handler</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">undefined</span>
</pre></div>
<p>By default you can only yield Promises and Thenables inside coroutines. You can use this function to add yielding support for arbitrary types.</p>

<p>For example, if you wanted <code>yield 500</code> to be same as <code>yield Promise.delay</code>:</p>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">coroutine</span><span class="p">.</span><span class="nx">addYieldHandler</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
     <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s2">&quot;number&quot;</span><span class="p">)</span> <span class="k">return</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">delay</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
<p>Yield handlers are called when you yield something that is not supported by default. The first yield handler to return a promise or a thenable will be used.
If no yield handler returns a promise or a thenable then an error is raised.</p>

<p>An example of implementing callback support with <code>addYieldHandler</code>:</p>

<p><em>This is a demonstration of how powerful the feature is and not the recommended usage. For best performance you need to use <code>promisifyAll</code> and yield promises directly.</em></p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;fs&quot;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">_</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">promise</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="nx">Promise</span><span class="p">.</span><span class="nx">coroutine</span><span class="p">.</span><span class="nx">addYieldHandler</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">v</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="nx">promise</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">promise</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">promise</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">def</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>
        <span class="nx">promise</span> <span class="o">=</span> <span class="nx">def</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">def</span><span class="p">.</span><span class="nx">callback</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">})();</span>


<span class="kd">var</span> <span class="nx">readFileJSON</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">coroutine</span><span class="p">(</span><span class="kd">function</span><span class="o">*</span> <span class="p">(</span><span class="nx">fileName</span><span class="p">)</span> <span class="p">{</span>
   <span class="kd">var</span> <span class="nx">contents</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">fileName</span><span class="p">,</span> <span class="s2">&quot;utf8&quot;</span><span class="p">,</span> <span class="nx">_</span><span class="p">());</span>
   <span class="k">return</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">contents</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
<p>An example of implementing thunks support with <code>addYieldHandler</code>:</p>

<p><em>This is a demonstration of how powerful the feature is and not the recommended usage. For best performance you need to use <code>promisifyAll</code> and yield promises directly.</em></p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;fs&quot;</span><span class="p">);</span>

<span class="nx">Promise</span><span class="p">.</span><span class="nx">coroutine</span><span class="p">.</span><span class="nx">addYieldHandler</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">v</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">def</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>
        <span class="k">try</span> <span class="p">{</span> <span class="nx">v</span><span class="p">(</span><span class="nx">def</span><span class="p">.</span><span class="nx">callback</span><span class="p">);</span> <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="nx">def</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span> <span class="p">}</span>
        <span class="k">return</span> <span class="nx">def</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">readFileThunk</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fileName</span><span class="p">,</span> <span class="nx">encoding</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">fileName</span><span class="p">,</span> <span class="nx">encoding</span><span class="p">,</span> <span class="nx">cb</span><span class="p">);</span>
    <span class="p">};</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">readFileJSON</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">coroutine</span><span class="p">(</span><span class="kd">function</span><span class="o">*</span> <span class="p">(</span><span class="nx">fileName</span><span class="p">)</span> <span class="p">{</span>
   <span class="kd">var</span> <span class="nx">contents</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">readFileThunk</span><span class="p">(</span><span class="nx">fileName</span><span class="p">,</span> <span class="s2">&quot;utf8&quot;</span><span class="p">);</span>
   <span class="k">return</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">contents</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
<p>An example of handling promises in parallel by adding an <code>addYieldHandler</code> for arrays :</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;fs&quot;</span><span class="p">));</span>

<span class="nx">Promise</span><span class="p">.</span><span class="nx">coroutine</span><span class="p">.</span><span class="nx">addYieldHandler</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">yieldedValue</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">yieldedValue</span><span class="p">))</span> <span class="k">return</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">yieldedValue</span><span class="p">);</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">readFiles</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">coroutine</span><span class="p">(</span><span class="kd">function</span><span class="o">*</span> <span class="p">(</span><span class="nx">fileNames</span><span class="p">)</span> <span class="p">{</span>
   <span class="kd">var</span> <span class="nx">promises</span> <span class="o">=</span> <span class="p">[];</span>

   <span class="nx">fileNames</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">fileName</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">promises</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileAsync</span><span class="p">(</span><span class="nx">fileName</span><span class="p">,</span> <span class="s2">&quot;utf8&quot;</span><span class="p">));</span>
   <span class="p">});</span>

   <span class="k">return</span> <span class="k">yield</span> <span class="nx">promises</span><span class="p">;</span>
<span class="p">});</span>
</pre></div></div>

            <h2>
                <a class="header-anchor"
                    name="utility"
                    aria-hidden="true"
                    href="#utility"><i class="fa fa-link"></i></a>
                Utility
            </h2>

<p>Functions that could potentially be handy in some situations.</p>

<p><hr></p>
<div class="api-code-section">            <h2>
                <a class="header-anchor"
                    name=".tap"
                    aria-hidden="true"
                    href="#.tap"><i class="fa fa-link"></i></a>
                .tap
            </h2>
<div class="highlight"><pre><span class="p">.</span><span class="nx">tap</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">any</span> <span class="nx">value</span><span class="p">)</span> <span class="nx">handler</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div>
<p>Like                 <a href="/bluebird/web/docs/api-reference.html#.finally"><code><code>.finally</code></code></a>
 that is not called for rejections.</p>
<div class="highlight"><pre><span class="nx">getUser</span><span class="p">().</span><span class="nx">tap</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//Like in finally, if you return a promise from the handler</span>
    <span class="c1">//the promise is awaited for before passing the original value through</span>
    <span class="k">return</span> <span class="nx">recordStatsAsync</span><span class="p">();</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//user is the user from getUser(), not recordStatsAsync()</span>
<span class="p">});</span>
</pre></div>
<p>Common case includes adding logging to an existing promise chain:</p>
<div class="highlight"><pre><span class="nx">doSomething</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(...)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(...)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(...)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(...)</span>
</pre></div><div class="highlight"><pre><span class="nx">doSomething</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(...)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(...)</span>
    <span class="p">.</span><span class="nx">tap</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(...)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(...)</span>
</pre></div>
<p><em>Note: in browsers it is necessary to call <code>.tap</code> with <code>console.log.bind(console)</code> because console methods can not be called as stand-alone functions.</em></p>

<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name=".call"
                    aria-hidden="true"
                    href="#.call"><i class="fa fa-link"></i></a>
                .call
            </h2>
<div class="highlight"><pre><span class="p">.</span><span class="nx">call</span><span class="p">(</span>
    <span class="nb">String</span> <span class="nx">methodName</span><span class="p">,</span>
    <span class="p">[</span><span class="nx">any</span> <span class="nx">args</span><span class="p">...]</span>
<span class="p">)</span>
</pre></div>
<p>This is a convenience method for doing:</p>
<div class="highlight"><pre><span class="nx">promise</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">methodName</span><span class="p">].</span><span class="nx">call</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">arg</span><span class="p">...);</span>
<span class="p">});</span>
</pre></div>
<p>For example (                <a href="https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Global_Objects/Array/some" title=""><code>some</code> is a built-in array method</a>
):</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;fs&quot;</span><span class="p">));</span>
<span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">thisPath</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">||</span> <span class="s2">&quot;.&quot;</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">now</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>

<span class="nx">fs</span><span class="p">.</span><span class="nx">readdirAsync</span><span class="p">(</span><span class="nx">thisPath</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">fileName</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">statAsync</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">thisPath</span><span class="p">,</span> <span class="nx">fileName</span><span class="p">));</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s2">&quot;some&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stat</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="nx">now</span> <span class="o">-</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">stat</span><span class="p">.</span><span class="nx">mtime</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">;</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">someFilesHaveBeenModifiedLessThanTenSecondsAgo</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">someFilesHaveBeenModifiedLessThanTenSecondsAgo</span><span class="p">)</span> <span class="p">;</span>
    <span class="p">});</span>
</pre></div>
<p>Chaining lo-dash or underscore methods (Copy-pasteable example):</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">pmap</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">map</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">props</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">props</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;lodash&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;fs&quot;</span><span class="p">));</span>

<span class="kd">function</span> <span class="nx">getTotalSize</span><span class="p">(</span><span class="nx">paths</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">pmap</span><span class="p">(</span><span class="nx">paths</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">statAsync</span><span class="p">(</span><span class="nx">path</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;size&quot;</span><span class="p">);</span>
    <span class="p">}).</span><span class="nx">reduce</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span><span class="p">;</span>
    <span class="p">},</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">fs</span><span class="p">.</span><span class="nx">readdirAsync</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">_</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s2">&quot;groupBy&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fileName</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">fileName</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s2">&quot;map&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fileNames</span><span class="p">,</span> <span class="nx">firstCh</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">props</span><span class="p">({</span>
            <span class="nx">firstCh</span><span class="o">:</span> <span class="nx">firstCh</span><span class="p">,</span>
            <span class="nx">count</span><span class="o">:</span> <span class="nx">fileNames</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
            <span class="nx">totalSize</span><span class="o">:</span> <span class="nx">getTotalSize</span><span class="p">(</span><span class="nx">fileNames</span><span class="p">)</span>
        <span class="p">});</span>
    <span class="p">})</span>
    <span class="c1">// Since the currently wrapped array contains promises we need to unwrap it and call .all() before continuing the chain</span>
    <span class="c1">// If the currently wrapped thing was an object with properties that might be promises, we would call .props() instead</span>
    <span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">).</span><span class="nx">all</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">_</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s2">&quot;sortBy&quot;</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s2">&quot;reverse&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s2">&quot;map&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">data</span><span class="p">.</span><span class="nx">count</span> <span class="o">+</span> <span class="s2">&quot; total files beginning with &quot;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">.</span><span class="nx">firstCh</span> <span class="o">+</span> <span class="s2">&quot; with total size of &quot;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">.</span><span class="nx">totalSize</span> <span class="o">+</span> <span class="s2">&quot; bytes&quot;</span><span class="p">;</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s2">&quot;join&quot;</span><span class="p">,</span> <span class="s2">&quot;\n&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">)</span>
</pre></div>
<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name=".get"
                    aria-hidden="true"
                    href="#.get"><i class="fa fa-link"></i></a>
                .get
            </h2>
<div class="highlight"><pre><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nb">String</span> <span class="nx">propertyName</span><span class="o">|</span><span class="kr">int</span> <span class="nx">index</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div>
<p>This is a convenience method for doing:</p>
<div class="highlight"><pre><span class="nx">promise</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">propertyName</span><span class="p">];</span>
<span class="p">});</span>
</pre></div>
<p>For example:</p>
<div class="highlight"><pre><span class="nx">db</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s2">&quot;...&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">firstRow</span><span class="p">)</span> <span class="p">{</span>

    <span class="p">});</span>
</pre></div>
<p>If <code>index</code> is negative, the indexed load will become <code>obj.length + index</code>. So that -1 can be used to read last item
in the array, -2 to read the second last and so on. For example:</p>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]).</span><span class="nx">get</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span> <span class="c1">// 3</span>
<span class="p">});</span>
</pre></div>
<p>If the <code>index</code> is still negative after <code>obj.length + index</code>, it will be clamped to 0.</p>

<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name=".return"
                    aria-hidden="true"
                    href="#.return"><i class="fa fa-link"></i></a>
                .return
            </h2>
<div class="highlight"><pre><span class="p">.</span><span class="k">return</span><span class="p">(</span><span class="nx">any</span> <span class="nx">value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div><div class="highlight"><pre><span class="p">.</span><span class="nx">thenReturn</span><span class="p">(</span><span class="nx">any</span> <span class="nx">value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div>
<p>Convenience method for:</p>
<div class="highlight"><pre><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
   <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>
<p>in the case where <code>value</code> doesn&#39;t change its value because its binding time is different than when using a closure.</p>

<p>That means <code>value</code> is bound at the time of calling                 <a href="/bluebird/web/docs/api-reference.html#.return"><code><code>.return</code></code></a>
 so this will not work as expected:</p>
<div class="highlight"><pre><span class="kd">function</span> <span class="nx">getData</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">data</span><span class="p">;</span>

    <span class="k">return</span> <span class="nx">query</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">data</span> <span class="o">=</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">}).</span><span class="k">return</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>because <code>data</code> is <code>undefined</code> at the time <code>.return</code> is called.</p>

<p>Function that returns the full path of the written file:</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;fs&quot;</span><span class="p">));</span>
<span class="kd">var</span> <span class="nx">baseDir</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">||</span> <span class="s2">&quot;.&quot;</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">writeFile</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">contents</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">fullpath</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="nx">baseDir</span><span class="p">,</span> <span class="nx">path</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFileAsync</span><span class="p">(</span><span class="nx">fullpath</span><span class="p">,</span> <span class="nx">contents</span><span class="p">).</span><span class="nx">thenReturn</span><span class="p">(</span><span class="nx">fullpath</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">writeFile</span><span class="p">(</span><span class="s2">&quot;test.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;this is text&quot;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">fullPath</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Successfully file at: &quot;</span> <span class="o">+</span> <span class="nx">fullPath</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
<p><em>For compatibility with earlier ECMAScript version, an alias <code>.thenReturn</code> is provided for                 <a href="/bluebird/web/docs/api-reference.html#.return"><code><code>.return</code></code></a>
.</em></p>

<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name=".throw"
                    aria-hidden="true"
                    href="#.throw"><i class="fa fa-link"></i></a>
                .throw
            </h2>
<div class="highlight"><pre><span class="p">.</span><span class="k">throw</span><span class="p">(</span><span class="nx">any</span> <span class="nx">reason</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div><div class="highlight"><pre><span class="p">.</span><span class="nx">thenThrow</span><span class="p">(</span><span class="nx">any</span> <span class="nx">reason</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div>
<p>Convenience method for:</p>
<div class="highlight"><pre><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
   <span class="k">throw</span> <span class="nx">reason</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>
<p>Same limitations regarding to the binding time of <code>reason</code> to apply as with                 <a href="/bluebird/web/docs/api-reference.html#.return"><code><code>.return</code></code></a>
.</p>

<p><em>For compatibility with earlier ECMAScript version, an alias <code>.thenThrow</code> is provided for                 <a href="/bluebird/web/docs/api-reference.html#.throw"><code><code>.throw</code></code></a>
.</em></p>

<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name=".catchreturn"
                    aria-hidden="true"
                    href="#.catchreturn"><i class="fa fa-link"></i></a>
                .catchReturn
            </h2>
<div class="highlight"><pre><span class="p">.</span><span class="nx">catchReturn</span><span class="p">(</span>
    <span class="p">[</span><span class="kr">class</span> <span class="nx">ErrorClass</span><span class="o">|</span><span class="kd">function</span><span class="p">(</span><span class="nx">any</span> <span class="nx">error</span><span class="p">)</span> <span class="nx">predicate</span><span class="p">],</span>
    <span class="nx">any</span> <span class="nx">value</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div>
<p>Convenience method for:</p>
<div class="highlight"><pre><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
   <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>
<p>You may optionally prepend one predicate function or ErrorClass to pattern match the error (the generic                 <a href="/bluebird/web/docs/api-reference.html#.catch"><code>.catch</code></a>
 methods accepts multiple)</p>

<p>Same limitations regarding to the binding time of <code>value</code> to apply as with                 <a href="/bluebird/web/docs/api-reference.html#.return"><code><code>.return</code></code></a>
.</p>

<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name=".catchthrow"
                    aria-hidden="true"
                    href="#.catchthrow"><i class="fa fa-link"></i></a>
                .catchThrow
            </h2>
<div class="highlight"><pre><span class="p">.</span><span class="nx">catchThrow</span><span class="p">(</span>
    <span class="p">[</span><span class="kr">class</span> <span class="nx">ErrorClass</span><span class="o">|</span><span class="kd">function</span><span class="p">(</span><span class="nx">any</span> <span class="nx">error</span><span class="p">)</span> <span class="nx">predicate</span><span class="p">],</span>
    <span class="nx">any</span> <span class="nx">reason</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Promise</span>
</pre></div>
<p>Convenience method for:</p>
<div class="highlight"><pre><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
   <span class="k">throw</span> <span class="nx">reason</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>
<p>You may optionally prepend one predicate function or ErrorClass to pattern match the error (the generic                 <a href="/bluebird/web/docs/api-reference.html#.catch"><code>.catch</code></a>
 methods accepts multiple)</p>

<p>Same limitations regarding to the binding time of <code>reason</code> to apply as with                 <a href="/bluebird/web/docs/api-reference.html#.return"><code><code>.return</code></code></a>
.</p>

<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name=".reflect"
                    aria-hidden="true"
                    href="#.reflect"><i class="fa fa-link"></i></a>
                .reflect
            </h2>
<div class="highlight"><pre><span class="p">.</span><span class="nx">reflect</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nx">Promise</span><span class="o">&lt;</span><span class="nx">PromiseInspection</span><span class="o">&gt;</span>
</pre></div>
<p>The                 <a href="/bluebird/web/docs/api-reference.html#.reflect"><code><code>.reflect</code></code></a>
 method returns a promise that is always successful when this promise is settled. Its fulfillment value is an object that implements the                 <a href="/bluebird/web/docs/api-reference.html#promiseinspection"><code>PromiseInspection</code></a>
 interface and reflects the resolution this promise.</p>

<p>Using <code>.reflect()</code> to implement <code>settleAll</code> (wait until all promises in an array are either rejected or fulfilled) functionality</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">promises</span> <span class="o">=</span> <span class="p">[</span><span class="nx">getPromise</span><span class="p">(),</span> <span class="nx">getPromise</span><span class="p">(),</span> <span class="nx">getPromise</span><span class="p">()];</span>
<span class="nx">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">promises</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">promise</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">promise</span><span class="p">.</span><span class="nx">reflect</span><span class="p">();</span>
<span class="p">})).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">inspection</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">inspection</span><span class="p">.</span><span class="nx">isFulfilled</span><span class="p">())</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;A promise in the array was fulfilled with&quot;</span><span class="p">,</span> <span class="nx">inspection</span><span class="p">.</span><span class="nx">value</span><span class="p">());</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;A promise in the array was rejected with&quot;</span><span class="p">,</span> <span class="nx">inspection</span><span class="p">.</span><span class="nx">reason</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">});</span>
</pre></div>
<p>Using <code>.reflect()</code> to implement <code>settleProps</code> (like settleAll for an object&#39;s properties) functionality</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">object</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">first</span><span class="o">:</span> <span class="nx">getPromise1</span><span class="p">(),</span>
    <span class="nx">second</span><span class="o">:</span> <span class="nx">getPromise2</span><span class="p">()</span>
<span class="p">};</span>
<span class="nx">Promise</span><span class="p">.</span><span class="nx">props</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">object</span><span class="p">).</span><span class="nx">reduce</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">newObject</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">newObject</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">object</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">reflect</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">newObject</span><span class="p">;</span>
<span class="p">},</span> <span class="p">{})).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">object</span><span class="p">.</span><span class="nx">first</span><span class="p">.</span><span class="nx">isFulfilled</span><span class="p">())</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;first was fulfilled with&quot;</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">first</span><span class="p">.</span><span class="nx">value</span><span class="p">());</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;first was rejected with&quot;</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">first</span><span class="p">.</span><span class="nx">reason</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">})</span>
</pre></div>
<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name="promise.noconflict"
                    aria-hidden="true"
                    href="#promise.noconflict"><i class="fa fa-link"></i></a>
                Promise.noConflict
            </h2>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">noConflict</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">Object</span>
</pre></div>
<p>This is relevant to browser environments with no module loader.</p>

<p>Release control of the <code>Promise</code> namespace to whatever it was before this library was loaded. Returns a reference to the library namespace so you can attach it to something else.</p>
<div class="highlight"><pre><span class="c">&lt;!-- the other promise library must be loaded first --&gt;</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;/scripts/other_promise.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;/scripts/bluebird_debug.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
<span class="c1">//Release control right after</span>
<span class="kd">var</span> <span class="nx">Bluebird</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">noConflict</span><span class="p">();</span>

<span class="c1">//Cast a promise from some other Promise library using the Promise namespace to Bluebird:</span>
<span class="kd">var</span> <span class="nx">promise</span> <span class="o">=</span> <span class="nx">Bluebird</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="k">new</span> <span class="nx">Promise</span><span class="p">());</span>
<span class="nt">&lt;/script&gt;</span>
</pre></div>
<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name="promise.setscheduler"
                    aria-hidden="true"
                    href="#promise.setscheduler"><i class="fa fa-link"></i></a>
                Promise.setScheduler
            </h2>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">setScheduler</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="kd">function</span> <span class="nx">fn</span><span class="p">)</span> <span class="nx">scheduler</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">undefined</span>
</pre></div>
<p>Scheduler should be a function that asynchronously schedules the calling of the passed in function:</p>
<div class="highlight"><pre><span class="c1">// This is just an example of how to use the api, there is no reason to do this</span>
<span class="nx">Promise</span><span class="p">.</span><span class="nx">setScheduler</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
<p>Setting a custom scheduler could be necessary when you need a faster way to schedule functions than bluebird does by default.</p>

<p>You can also use it as a hook:</p>
<div class="highlight"><pre><span class="c1">// This will synchronize bluebird promise queue flushing with angulars queue flushing</span>
<span class="c1">// Angular is also now responsible for choosing the actual scheduler</span>
<span class="nx">Promise</span><span class="p">.</span><span class="nx">setScheduler</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$rootScope</span><span class="p">.</span><span class="nx">$evalAsync</span><span class="p">(</span><span class="nx">fn</span><span class="p">);</span>
<span class="p">});</span>
</pre></div></div>

            <h2>
                <a class="header-anchor"
                    name="built-in-error-types"
                    aria-hidden="true"
                    href="#built-in-error-types"><i class="fa fa-link"></i></a>
                Built-in error types
            </h2>

<p>Bluebird includes a few built-in error types for common usage. All error types have the same identity across different copies of bluebird
module so that pattern matching works in                 <a href="/bluebird/web/docs/api-reference.html#.catch"><code><code>.catch</code></code></a>
. All error types have a constructor taking a message string as their first argument, with that message
becoming the <code>.message</code> property of the error object.</p>

<p>By default the error types need to be referenced from the Promise constructor, e.g. to get a reference to                 <a href="/bluebird/web/docs/api-reference.html#timeouterror"><code>TimeoutError</code></a>
, do <code>var TimeoutError = Promise.TimeoutError</code>. However, for convenience you will probably want to just make the references global.</p>
<div class="api-code-section">            <h2>
                <a class="header-anchor"
                    name="operationalerror"
                    aria-hidden="true"
                    href="#operationalerror"><i class="fa fa-link"></i></a>
                OperationalError
            </h2>
<div class="highlight"><pre><span class="k">new</span> <span class="nx">OperationalError</span><span class="p">(</span><span class="nb">String</span> <span class="nx">message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">OperationalError</span>
</pre></div>
<p>Represents an error is an explicit promise rejection as opposed to a thrown error. For example, if an error is errbacked by a callback API promisified through undefined or undefined
and is not a typed error, it will be converted to a <code>OperationalError</code> which has the original error in the <code>.cause</code> property.</p>

<p><code>OperationalError</code>s are caught in                 <a href="/bluebird/web/docs/api-reference.html#.error"><code><code>.error</code></code></a>
 handlers.</p>

<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name="timeouterror"
                    aria-hidden="true"
                    href="#timeouterror"><i class="fa fa-link"></i></a>
                TimeoutError
            </h2>
<div class="highlight"><pre><span class="k">new</span> <span class="nx">TimeoutError</span><span class="p">(</span><span class="nb">String</span> <span class="nx">message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">TimeoutError</span>
</pre></div>
<p>Signals that an operation has timed out. Used as a custom cancellation reason in                 <a href="/bluebird/web/docs/api-reference.html#.timeout"><code><code>.timeout</code></code></a>
.</p>

<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name="cancellationerror"
                    aria-hidden="true"
                    href="#cancellationerror"><i class="fa fa-link"></i></a>
                CancellationError
            </h2>
<div class="highlight"><pre><span class="k">new</span> <span class="nx">CancellationError</span><span class="p">(</span><span class="nb">String</span> <span class="nx">message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">CancellationError</span>
</pre></div>
<p>Signals that an operation has been aborted or cancelled. The default reason used by                 <a href="/bluebird/web/docs/api-reference.html#.cancel"><code><code>.cancel</code></code></a>
.</p>

<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name="aggregateerror"
                    aria-hidden="true"
                    href="#aggregateerror"><i class="fa fa-link"></i></a>
                AggregateError
            </h2>
<div class="highlight"><pre><span class="k">new</span> <span class="nx">AggregateError</span><span class="p">()</span> <span class="kr">extends</span> <span class="nb">Array</span> <span class="o">-&gt;</span> <span class="nx">AggregateError</span>
</pre></div>
<p>A collection of errors. <code>AggregateError</code> is an array-like object, with numeric indices and a <code>.length</code> property. It supports all generic array methods such as <code>.forEach</code> directly.</p>

<p><code>AggregateError</code>s are caught in                 <a href="/bluebird/web/docs/api-reference.html#.error"><code><code>.error</code></code></a>
 handlers, even if the contained errors are not operational.</p>

<p><a href="/bluebird/web/docs/api-reference.html#promise.some"><code>Promise.some</code></a>
 and                 <a href="/bluebird/web/docs/api-reference.html#promise.any"><code>Promise.any</code></a>
  use <code>AggregateError</code> as rejection reason when they fail.</p>

<p>Example:</p>
<div class="highlight"><pre><span class="c1">//Assumes AggregateError has been made global</span>
<span class="kd">var</span> <span class="nx">err</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AggregateError</span><span class="p">();</span>
<span class="nx">err</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;first error&quot;</span><span class="p">));</span>
<span class="nx">err</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;second error&quot;</span><span class="p">));</span>
<span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
</pre></div>
<p><hr></p>
</div>

            <h2>
                <a class="header-anchor"
                    name="error-management-configuration"
                    aria-hidden="true"
                    href="#error-management-configuration"><i class="fa fa-link"></i></a>
                Error management configuration
            </h2>

<p>The default approach of bluebird is to immediately log the stack trace when there is an unhandled rejection. This is similar to how uncaught exceptions cause the stack trace to be logged so that you have something to work with when something is not working as expected.</p>

<p>However because it is possible to handle a rejected promise at any time in the indeterminate future, some programming patterns will result in false positives. Because such programming patterns are not necessary and can always be refactored to never cause false positives, we recommend doing that to keep debugging as easy as possible . You may however feel differently so bluebird provides hooks to implement more complex failure policies.</p>

<p>Such policies could include:</p>

<ul>
<li>Logging after the promise became GCd (requires a native node.js module)</li>
<li>Showing a live list of rejected promises</li>
<li>Using no hooks and using                 <a href="/bluebird/web/docs/api-reference.html#.done"><code><code>.done</code></code></a>
 to manually to mark end points where rejections will not be handled</li>
<li>Swallowing all errors (challenge your debugging skills)</li>
<li>...</li>
</ul>

<p><hr></p>
            <h3>
                <a class="header-anchor"
                    name="global-rejection-events"
                    aria-hidden="true"
                    href="#global-rejection-events"><i class="fa fa-link"></i></a>
                Global rejection events
            </h3>

<p>Starting from 2.7.0 all bluebird instances also fire rejection events globally so that applications can register one universal hook for them.</p>

<p>The global events are:</p>

<ul>
<li><code>&quot;unhandledRejection&quot;</code> (corresponds to the local                 <a href="/bluebird/web/docs/api-reference.html#promise.onpossiblyunhandledrejection"><code><code>Promise.onPossiblyUnhandledRejection</code></code></a>
)</li>
<li><code>&quot;rejectionHandled&quot;</code> (corresponds to the local                 <a href="/bluebird/web/docs/api-reference.html#promise.onunhandledrejectionhandled"><code><code>Promise.onUnhandledRejectionHandled</code></code></a>
)</li>
</ul>

<p>Attaching global rejection event handlers in <strong>node.js</strong>:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="c1">// NOTE: event name is camelCase as per node convention</span>
<span class="nx">process</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;unhandledRejection&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">reason</span><span class="p">,</span> <span class="nx">promise</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// See Promise.onPossiblyUnhandledRejection for parameter documentation</span>
<span class="p">});</span>

<span class="c1">// NOTE: event name is camelCase as per node convention</span>
<span class="nx">process</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;rejectionHandled&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">promise</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// See Promise.onUnhandledRejectionHandled for parameter documentation</span>
<span class="p">});</span>
</code></pre></div>
<p>Attaching global rejection event handlers in <strong>browsers</strong>:</p>

<p>Using DOM3 <code>addEventListener</code> APIs (support starting from IE9+):</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="c1">// NOTE: event name is all lower case as per DOM convention</span>
<span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;unhandledrejection&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// NOTE: e.preventDefault() must be manually called to prevent the default</span>
    <span class="c1">// action which is currently to log the stack trace to console.warn</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
    <span class="c1">// NOTE: parameters are properties of the event detail property</span>
    <span class="kd">var</span> <span class="nx">reason</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">detail</span><span class="p">.</span><span class="nx">reason</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">promise</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">detail</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
    <span class="c1">// See Promise.onPossiblyUnhandledRejection for parameter documentation</span>
<span class="p">});</span>

<span class="c1">// NOTE: event name is all lower case as per DOM convention</span>
<span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;rejectionhandled&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// NOTE: e.preventDefault() must be manually called prevent the default</span>
    <span class="c1">// action which is currently unset (but might be set to something in the future)</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
    <span class="c1">// NOTE: parameters are properties of the event detail property</span>
    <span class="kd">var</span> <span class="nx">promise</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">detail</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
    <span class="c1">// See Promise.onUnhandledRejectionHandled for parameter documentation</span>
<span class="p">});</span>
</code></pre></div>
<p>In Web Workers you may use <code>self.addEventListener</code>.</p>

<p>Using legacy APIs (support starting from IE6+):</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="c1">// NOTE: event name is all lower case as per legacy convention</span>
<span class="nb">window</span><span class="p">.</span><span class="nx">onunhandledrejection</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">reason</span><span class="p">,</span> <span class="nx">promise</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// See Promise.onPossiblyUnhandledRejection for parameter documentation</span>
<span class="p">};</span>

<span class="c1">// NOTE: event name is all lower case as per legacy convention</span>
<span class="nb">window</span><span class="p">.</span><span class="nx">onrejectionhandled</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">promise</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// See Promise.onUnhandledRejectionHandled for parameter documentation</span>
<span class="p">};</span>
</code></pre></div>
<p><hr></p>
<div class="api-code-section">            <h2>
                <a class="header-anchor"
                    name="promise.onpossiblyunhandledrejection"
                    aria-hidden="true"
                    href="#promise.onpossiblyunhandledrejection"><i class="fa fa-link"></i></a>
                Promise.onPossiblyUnhandledRejection
            </h2>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">onPossiblyUnhandledRejection</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">any</span> <span class="nx">error</span><span class="p">,</span> <span class="nx">Promise</span> <span class="nx">promise</span><span class="p">)</span> <span class="nx">handler</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">undefined</span>
</pre></div>
<p><em>Note: this hook is specific to the bluebird instance its called on, application developers should use                 <a href="#global-rejection-events" title="">global rejection events</a>
</em></p>

<p>Add <code>handler</code> as the handler to call when there is a possibly unhandled rejection. The default handler logs the error stack to stderr or <code>console.error</code> in browsers.</p>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">onPossiblyUnhandledRejection</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">promise</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="nx">e</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>
<p>Passing no value or a non-function will have the effect of removing any kind of handling for possibly unhandled rejections.</p>

<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name="promise.onunhandledrejectionhandled"
                    aria-hidden="true"
                    href="#promise.onunhandledrejectionhandled"><i class="fa fa-link"></i></a>
                Promise.onUnhandledRejectionHandled
            </h2>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">onUnhandledRejectionHandled</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">Promise</span> <span class="nx">promise</span><span class="p">)</span> <span class="nx">handler</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">undefined</span>
</pre></div>
<p><em>Note: this hook is specific to the bluebird instance its called on, application developers should use                 <a href="#global-rejection-events" title="">global rejection events</a>
</em></p>

<p>Add <code>handler</code> as the handler to call when a rejected promise that was reported as &quot;possibly unhandled rejection&quot; became handled.</p>

<p>Together with <code>onPossiblyUnhandledRejection</code> these hooks can be used to implement a debugger that will show a list
of unhandled promise rejections updated in real time as promises become handled.</p>

<p>For example:</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">unhandledPromises</span> <span class="o">=</span> <span class="p">[];</span>
<span class="nx">Promise</span><span class="p">.</span><span class="nx">onPossiblyUnhandledRejection</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">reason</span><span class="p">,</span> <span class="nx">promise</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">unhandledPromises</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">promise</span><span class="p">);</span>
    <span class="c1">//Update some debugger UI</span>
<span class="p">});</span>

<span class="nx">Promise</span><span class="p">.</span><span class="nx">onUnhandledRejectionHandled</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">promise</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">unhandledPromises</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">promise</span><span class="p">);</span>
    <span class="nx">unhandledPromises</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="c1">//Update the debugger UI</span>
<span class="p">});</span>
</pre></div>
<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name="promise.longstacktraces"
                    aria-hidden="true"
                    href="#promise.longstacktraces"><i class="fa fa-link"></i></a>
                Promise.longStackTraces
            </h2>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">longStackTraces</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">undefined</span>
</pre></div>
<p>Call this right after the library is loaded to enabled long stack traces. Long stack traces cannot be disabled after being enabled, and cannot be enabled after promises have alread been created. Long stack traces imply a substantial performance penalty, around 4-5x for throughput and 0.5x for latency.</p>

<p>Long stack traces are enabled by default in the debug build.</p>

<p>To enable them in all instances of bluebird in node.js, use the environment variable <code>BLUEBIRD_DEBUG</code>:</p>
<div class="highlight"><pre><span class="vg">BLUEBIRD_DEBUG</span><span class="o">=</span><span class="il">1</span><span class="w"> </span><span class="vg">node</span><span class="w"> </span><span class="vg">server</span><span class="o">.</span><span class="vg">js</span>
</pre></div>
<p>Setting the environment variable <code>NODE_ENV</code> to <code>&quot;development&quot;</code> also automatically enables long stack traces.</p>

<p>You should enabled long stack traces if you want better debugging experience. For example:</p>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">longStackTraces</span><span class="p">();</span>
<span class="nx">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="nx">outer</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="nx">inner</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="nx">evenMoreInner</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">a</span><span class="p">.</span><span class="nx">b</span><span class="p">.</span><span class="nx">c</span><span class="p">.</span><span class="nx">d</span><span class="p">()</span>
        <span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span> <span class="nx">catcher</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">});</span>
</pre></div>
<p>Gives</p>
<div class="highlight"><pre><span class="n">ReferenceError</span><span class="o">:</span> <span class="n">a</span> <span class="k">is</span> <span class="n">not</span> <span class="n">defined</span>
    <span class="n">at</span> <span class="n">evenMoreInner</span> <span class="o">(&lt;</span><span class="n">anonymous</span><span class="o">&gt;:</span><span class="mi">6</span><span class="o">:</span><span class="mi">13</span><span class="o">)</span>
<span class="n">From</span> <span class="n">previous</span> <span class="n">event</span><span class="o">:</span>
    <span class="n">at</span> <span class="n">inner</span> <span class="o">(&lt;</span><span class="n">anonymous</span><span class="o">&gt;:</span><span class="mi">5</span><span class="o">:</span><span class="mi">24</span><span class="o">)</span>
<span class="n">From</span> <span class="n">previous</span> <span class="n">event</span><span class="o">:</span>
    <span class="n">at</span> <span class="n">outer</span> <span class="o">(&lt;</span><span class="n">anonymous</span><span class="o">&gt;:</span><span class="mi">4</span><span class="o">:</span><span class="mi">20</span><span class="o">)</span>
<span class="n">From</span> <span class="n">previous</span> <span class="n">event</span><span class="o">:</span>
    <span class="n">at</span> <span class="o">&lt;</span><span class="n">anonymous</span><span class="o">&gt;:</span><span class="mi">3</span><span class="o">:</span><span class="mi">9</span>
    <span class="n">at</span> <span class="n">Object</span><span class="o">.</span><span class="na">InjectedScript</span><span class="o">.</span><span class="na">_evaluateOn</span> <span class="o">(&lt;</span><span class="n">anonymous</span><span class="o">&gt;:</span><span class="mi">581</span><span class="o">:</span><span class="mi">39</span><span class="o">)</span>
    <span class="n">at</span> <span class="n">Object</span><span class="o">.</span><span class="na">InjectedScript</span><span class="o">.</span><span class="na">_evaluateAndWrap</span> <span class="o">(&lt;</span><span class="n">anonymous</span><span class="o">&gt;:</span><span class="mi">540</span><span class="o">:</span><span class="mi">52</span><span class="o">)</span>
    <span class="n">at</span> <span class="n">Object</span><span class="o">.</span><span class="na">InjectedScript</span><span class="o">.</span><span class="na">evaluate</span> <span class="o">(&lt;</span><span class="n">anonymous</span><span class="o">&gt;:</span><span class="mi">459</span><span class="o">:</span><span class="mi">21</span><span class="o">)</span>
</pre></div>
<p>While with long stack traces disabled, you would get:</p>
<div class="highlight"><pre><span class="nl">ReferenceError</span><span class="p">:</span> <span class="n">a</span> <span class="n">is</span> <span class="n">not</span> <span class="n">defined</span>
    <span class="n">at</span> <span class="n">evenMoreInner</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">anonymous</span><span class="o">&gt;:</span><span class="mi">6</span><span class="o">:</span><span class="mi">13</span><span class="p">)</span>
    <span class="n">at</span> <span class="n">tryCatch1</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">anonymous</span><span class="o">&gt;:</span><span class="mi">41</span><span class="o">:</span><span class="mi">19</span><span class="p">)</span>
    <span class="n">at</span> <span class="n">Promise</span><span class="err">$</span><span class="n">_resolvePromise</span> <span class="p">[</span><span class="n">as</span> <span class="n">_resolvePromise</span><span class="p">]</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">anonymous</span><span class="o">&gt;:</span><span class="mi">1739</span><span class="o">:</span><span class="mi">13</span><span class="p">)</span>
    <span class="n">at</span> <span class="n">Promise</span><span class="err">$</span><span class="n">_resolveLast</span> <span class="p">[</span><span class="n">as</span> <span class="n">_resolveLast</span><span class="p">]</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">anonymous</span><span class="o">&gt;:</span><span class="mi">1520</span><span class="o">:</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">at</span> <span class="n">Async</span><span class="err">$</span><span class="n">_consumeFunctionBuffer</span> <span class="p">[</span><span class="n">as</span> <span class="n">_consumeFunctionBuffer</span><span class="p">]</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">anonymous</span><span class="o">&gt;:</span><span class="mi">560</span><span class="o">:</span><span class="mi">33</span><span class="p">)</span>
    <span class="n">at</span> <span class="n">Async</span><span class="err">$</span><span class="n">consumeFunctionBuffer</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">anonymous</span><span class="o">&gt;:</span><span class="mi">515</span><span class="o">:</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">at</span> <span class="n">MutationObserver</span><span class="p">.</span><span class="n">Promise</span><span class="err">$</span><span class="n">_Deferred</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">anonymous</span><span class="o">&gt;:</span><span class="mi">433</span><span class="o">:</span><span class="mi">17</span><span class="p">)</span>
</pre></div>
<p>On client side, long stack traces currently only work in recent Firefoxes, Chrome and Internet Explorer 10+.</p>

<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name="promise.config"
                    aria-hidden="true"
                    href="#promise.config"><i class="fa fa-link"></i></a>
                Promise.config
            </h2>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">config</span><span class="p">(</span><span class="nb">Object</span> <span class="p">{</span>
    <span class="nx">warnings</span><span class="o">:</span> <span class="kr">boolean</span><span class="o">=</span><span class="kc">false</span><span class="p">,</span>
    <span class="nx">longStackTraces</span><span class="o">:</span> <span class="kr">boolean</span><span class="o">=</span><span class="kc">false</span><span class="p">,</span>
    <span class="nx">cancellation</span><span class="o">:</span> <span class="kr">boolean</span><span class="o">=</span><span class="kc">false</span>
<span class="p">}</span> <span class="nx">options</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">undefined</span><span class="p">;</span>
</pre></div>
<p>Configure long stack traces, warnings and cancellation.</p>
<div class="highlight"><pre><span class="nx">Promise</span><span class="p">.</span><span class="nx">config</span><span class="p">({</span>
    <span class="c1">// Enable warnings.</span>
    <span class="nx">warnings</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="c1">// Enable long stack traces.</span>
    <span class="nx">longStackTraces</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="c1">// Enable cancellation.</span>
    <span class="nx">cancellation</span><span class="o">:</span> <span class="kc">true</span>
<span class="p">});</span>
</pre></div>
<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name=".suppressunhandledrejections"
                    aria-hidden="true"
                    href="#.suppressunhandledrejections"><i class="fa fa-link"></i></a>
                .suppressUnhandledRejections
            </h2>
<div class="highlight"><pre><span class="p">.</span><span class="nx">suppressUnhandledRejections</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">undefined</span>
</pre></div>
<p>Basically sugar for doing:</p>
<div class="highlight"><pre><span class="nx">somePromise</span><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(){});</span>
</pre></div>
<p>Which is needed in case error handlers are attached asynchronously to the promise later, which would otherwise result in premature unhandled rejection reporting.</p>

<p>Example:</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">tweets</span> <span class="o">=</span> <span class="nx">fetchTweets</span><span class="p">();</span>
<span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;ready&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">tweets</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// Render tweets</span>
    <span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;failed to fetch tweets because: &quot;</span> <span class="o">+</span> <span class="nx">e</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">});</span>
</pre></div>
<p>If fetching tweets fails before the document is ready the rejection is reported as unhandled even though it will be eventually handled when the document is ready. This is of course impossible to determine automatically, but you can explicitly do so using <code>.suppressUnhandledRejections()</code>:</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">tweets</span> <span class="o">=</span> <span class="nx">fetchTweets</span><span class="p">();</span>
<span class="nx">tweets</span><span class="p">.</span><span class="nx">suppressUnhandledRejections</span><span class="p">();</span>
<span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;ready&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">tweets</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// Render tweets</span>
    <span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;failed to fetch tweets because: &quot;</span> <span class="o">+</span> <span class="nx">e</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">});</span>
</pre></div>
<p>It should be noted that there is no real need to attach the handlers asynchronously. Exactly the same effect can be achieved with:</p>
<div class="highlight"><pre><span class="nx">fetchTweets</span><span class="p">()</span>
    <span class="p">.</span><span class="k">finally</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">$</span><span class="p">.</span><span class="nx">ready</span><span class="p">.</span><span class="nx">promise</span><span class="p">();</span>
    <span class="p">})</span>
    <span class="c1">// DOM guaranteed to be ready after this point</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// Render tweets</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;failed to fetch tweets because: &quot;</span> <span class="o">+</span> <span class="nx">e</span><span class="p">);</span>
    <span class="p">});</span>
</pre></div>
<p>The advantage of using <code>.suppressUnhandledRejections()</code> over <code>.catch(function(){})</code> is that it doesn&#39;t increment the branch count of the promise. Branch counts matter when using cancellation because a promise will only be cancelled if all of its branches want to cancel it.</p>

<p><hr></p>
            <h2>
                <a class="header-anchor"
                    name=".done"
                    aria-hidden="true"
                    href="#.done"><i class="fa fa-link"></i></a>
                .done
            </h2>
<div class="highlight"><pre><span class="p">.</span><span class="nx">done</span><span class="p">(</span>
    <span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">any</span> <span class="nx">value</span><span class="p">)</span> <span class="nx">fulfilledHandler</span><span class="p">],</span>
    <span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">any</span> <span class="nx">error</span><span class="p">)</span> <span class="nx">rejectedHandler</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">undefined</span>
</pre></div>
<p>Like                 <a href="/bluebird/web/docs/api-reference.html#.then"><code><code>.then</code></code></a>
, but any unhandled rejection that ends up here will crash the process (in node) or be thrown as an error (in browsers). The use of this method is heavily discouraged and it only exists for historical reasons.</p>

<p><hr></p>
</div>

            <h2>
                <a class="header-anchor"
                    name="progression-migration"
                    aria-hidden="true"
                    href="#progression-migration"><i class="fa fa-link"></i></a>
                Progression migration
            </h2>

<p>Progression has been removed as there are composability and chaining issues with APIs that use promise progression handlers. Implementing the common use case of progress bars can be accomplished using a pattern similar to                 <a href="http://blogs.msdn.com/b/dotnet/archive/2012/06/06/async-in-4-5-enabling-progress-and-cancellation-in-async-apis.aspx" title="">IProgress</a>
 in C#.</p>

<p>For old code that still uses it, see                 <a href="/bluebird/web/docs/deprecated_apis.html#progression" title="">the progression docs in the deprecated API documentation</a>
.</p>

<p>Using jQuery before:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">get</span><span class="p">(...))</span>
    <span class="p">.</span><span class="nx">progressed</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">})</span>
</code></pre></div>
<p>Using jQuery after:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">get</span><span class="p">(...).</span><span class="nx">progress</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">}))</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">})</span>
</code></pre></div>
<p>Implementing general progress interfaces like in C#:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">returnsPromiseWithProgress</span><span class="p">(</span><span class="nx">progressHandler</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">doFirstAction</span><span class="p">().</span><span class="nx">tap</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">progressHandler</span><span class="p">(</span><span class="mf">0.33</span><span class="p">);</span>
    <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">doSecondAction</span><span class="p">).</span><span class="nx">tap</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">progressHandler</span><span class="p">(</span><span class="mf">0.66</span><span class="p">);</span>
    <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">doThirdAction</span><span class="p">).</span><span class="nx">tap</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">progressHandler</span><span class="p">(</span><span class="mf">1.00</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="nx">returnsPromiseWithProgress</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">progress</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">ui</span><span class="p">.</span><span class="nx">progressbar</span><span class="p">.</span><span class="nx">setWidth</span><span class="p">((</span><span class="nx">progress</span> <span class="o">*</span> <span class="mi">200</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">);</span> <span class="c1">// update with on client side</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// action complete</span>
   <span class="c1">// entire chain is complete.</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// error</span>
<span class="p">});</span>
</code></pre></div>
<p>Another example using <code>coroutine</code>:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">doNothing</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{};</span>
<span class="kd">var</span> <span class="nx">progressSupportingCoroutine</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">coroutine</span><span class="p">(</span><span class="kd">function</span><span class="o">*</span> <span class="p">(</span><span class="nx">progress</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">progress</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">progress</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span> <span class="o">?</span> <span class="nx">progress</span> <span class="o">:</span> <span class="nx">doNothing</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">first</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">getFirstValue</span><span class="p">();</span>
        <span class="c1">// 33% done</span>
        <span class="nx">progress</span><span class="p">(</span><span class="mf">0.33</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">second</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">getSecondValue</span><span class="p">();</span>
        <span class="nx">progress</span><span class="p">(</span><span class="mf">0.67</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">third</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">getThirdValue</span><span class="p">();</span>
        <span class="nx">progress</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="k">return</span> <span class="p">[</span><span class="nx">first</span><span class="p">,</span> <span class="nx">second</span><span class="p">,</span> <span class="nx">third</span><span class="p">];</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">progressConsumingCoroutine</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">coroutine</span><span class="p">(</span><span class="kd">function</span><span class="o">*</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">allValues</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">progressSupportingCoroutine</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">ui</span><span class="p">.</span><span class="nx">progressbar</span><span class="p">.</span><span class="nx">setWidth</span><span class="p">((</span><span class="nx">p</span> <span class="o">*</span> <span class="mi">200</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="kd">var</span> <span class="nx">second</span> <span class="o">=</span> <span class="nx">allValues</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="c1">// ...</span>
<span class="p">});</span>
</code></pre></div>            <h2>
                <a class="header-anchor"
                    name="deferred-migration"
                    aria-hidden="true"
                    href="#deferred-migration"><i class="fa fa-link"></i></a>
                Deferred migration
            </h2>

<p>Deferreds are deprecated in favor of the promise constructor. If you need deferreds for some reason, you can create them trivially using the constructor:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">defer</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">promise</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">resolve</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="nx">reject</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="nx">resolve</span><span class="o">:</span> <span class="nx">resolve</span><span class="p">,</span>
        <span class="nx">reject</span><span class="o">:</span> <span class="nx">reject</span><span class="p">,</span>
        <span class="nx">promise</span><span class="o">:</span> <span class="nx">promise</span>
    <span class="p">};</span>
<span class="p">}</span>
</code></pre></div>
<p>For old code that still uses deferred objects, see                 <a href="/bluebird/web/docs/deprecated_apis.html#promise-resolution" title="">the deprecated API docs </a>
.</p>
            <h2>
                <a class="header-anchor"
                    name="environment-variables"
                    aria-hidden="true"
                    href="#environment-variables"><i class="fa fa-link"></i></a>
                Environment variables
            </h2>

<p>This section only applies to node.js or io.js.</p>

<p>You can change bluebird behavior globally with various environment variables. These global variables affect all instances of bluebird that are running in your environment, rather than just the one you have <code>require</code>d in your application. The effect an environment variable has depends on the bluebird version.</p>

<p>Environment variables supported by 2.x:</p>

<ul>
<li><code>BLUEBIRD_DEBUG</code> - Set to any truthy value this will enable long stack traces and warnings</li>
<li><code>NODE_ENV</code> - If set exactly to <code>development</code> it will have the same effect as if the <code>BLUEBIRD_DEBUG</code> variable was set.</li>
</ul>

<p>Environment variables supported by 3.x:</p>

<ul>
<li><code>BLUEBIRD_DEBUG</code> - Set to any truthy value this will enable long stack traces and warnings, unless those are explicitly disabled</li>
<li><code>NODE_ENV</code> - If set exactly to <code>development</code> it will have the same effect as if the <code>BLUEBIRD_DEBUG</code> variable was set.</li>
<li><code>BLUEBIRD_WARNINGS</code> - if set exactly to <code>0</code> it will explicitly disable warnings and this overrides any other setting that might enable warnings. If set to any truthy value, it will explicitly enable warnings.</li>
<li><code>BLUEBIRD_LONG_STACK_TRACES</code> - if set exactly to <code>0</code> it will explicitly disable long stack traces and this overrides any other setting that might enable long stack traces. If set to any truthy value, it will explicitly enable long stack traces.</li>
</ul>

  </article>

</div>

        </div>
      </div>
    </div>
    <footer></footer>
    <script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
</body>

</html>
